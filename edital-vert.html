<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Controle de Progresso - Edital Polícia Penal</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
  /* --- ESTILO PARA O NOVO TÍTULO --- */
header {
  text-align: center;
  padding: 20px 0;
  color: #F7EF8A;
}
header h1 {
  font-size: 1.8rem;
  margin: 0;
  text-shadow: 0 1px 2px rgba(0,0,0,0.3);
  background: linear-gradient(to right, #D2AC47, #F7EF8A, #AE8625);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}
/* --- FIM DO ESTILO --- */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body {
      background: linear-gradient(135deg, #0D0D09 0%, #000000 100%);
      color: #F4E883;
      min-height: 100vh;
      padding: 0px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
	  overflow-y: hidden;
    }
    .container {
      width: 100%;
      max-width: 1200px;
      background: rgba(20, 20, 20, 0.95);
      border-radius: 10px;
      padding: 0px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      border: 1px solid #333;
    }
    header {
      text-align: center;
      padding: 08px 0;
      color: #F7EF8A;
      margin-bottom: 10px;
    }
    header h1 {
      font-size: 1.6rem;
      margin-bottom: 5px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
      background: linear-gradient(to right, #D2AC47, #F7EF8A, #AE8625);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    header p {
      font-size: 0.85rem;
      opacity: 0.9;
    }
    .app-container {
      margin-top: 10px;
    }
    .progress-app {
      background: linear-gradient(to bottom, #1a1a1a, #111);
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
      min-height: 420px;
      border: 1px solid #333;
    }
   .app-header {
      display: flex;
      justify-content: flex-end; /* ALTERADO DE 'space-between' */
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 0px;
      border-bottom: 1px solid #333;
      flex-wrap: wrap;
      gap: 8px;
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 6px;
      background: rgba(210, 172, 71, 0.25);
      padding: 5px 12px;
      border-radius: 50px;
      font-weight: 500;
      color: #F7EF8A;
      font-size: 0.85rem;
    }
 /* --- BARRA SUPERIOR COMPACTA E ALINHADA --- */
.top-bar {
  display: flex;
  flex-wrap: nowrap;
  gap: 4px;
  margin-bottom: 12px;
  align-items: center;
  justify-content: flex-start;
  overflow-x: auto;
  padding-bottom: 4px;
}
.top-bar > * {
  flex: 0 0 auto;
}
.top-bar button {
  background: linear-gradient(135deg, #D2AC47, #F7EF8A, #AE8625);
  color: #0D0D09;
  border: none;
  padding: 6px 8px;
  border-radius: 50px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
  font-weight: bold;
  box-shadow: 0 2px 4px rgba(0,0,0,0.15);
  font-size: 0.82rem;
  transition: all 0.3s ease;
  white-space: nowrap;
  position: relative;
  overflow: hidden;
  min-height: 34px;
  max-width: 130px;
  margin: 0;
}
.top-bar button:hover {
  background: linear-gradient(135deg, #F4E883, #D2AC47, #AE8625);
  transform: translateY(-1px);
  box-shadow: 0 3px 6px rgba(0,0,0,0.2);
}
.top-bar button.loading {
  pointer-events: none;
  opacity: 0.7;
}
/* Botão "Dados" compacto */
.top-bar button:nth-child(5) {
  width: 76px !important;
  max-width: 76px !important;
  padding: 6px 5px !important;
  font-size: 0.8rem !important;
}
/* Container de busca fixo */
.search-container {
  display: flex;
  align-items: center;
  gap: 6px;
  width: 230px;
  flex: 0 0 auto;
  min-width: 200px;
  max-width: 240px;
}
.top-bar input[type="text"],
.top-bar select {
  padding: 6px 10px;
  border: 1px solid #555;
  border-radius: 50px;
  background: #222;
  color: #fff;
  font-size: 0.82rem;
}
    .search-icon {
      background: linear-gradient(135deg, #D2AC47, #F7EF8A, #AE8625);
      color: #0D0D09;
      border: none;
      padding: 7px 12px;
      border-radius: 50px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .search-icon:hover {
      background: linear-gradient(135deg, #F4E883, #D2AC47, #AE8625);
      transform: translateY(-1px);
    }
    .search-expanded {
      flex: 1;
      min-width: 120px;
    }
    .top-bar input[type="text"] {
      padding: 7px 12px;
      border: 1px solid #555;
      border-radius: 50px;
      font-size: 0.85rem;
      transition: border-color 0.3s;
      background-color: #222;
      color: #fff;
      width: 100%;
    }
    .top-bar input[type="text"]:focus {
      border-color: #D2AC47;
      outline: none;
    }
    
    /* 5. Ajuste do placeholder do campo de busca */
    #searchInput::placeholder {
      font-size: 0.8rem;
    }
    
    .top-bar select {
      padding: 7px 12px;
      border: 1px solid #555;
      border-radius: 50px;
      background: #222;
      font-size: 1rem;
      transition: border-color 0.3s;
      color: #fff;
      min-width: 170px;
	  width: 170px;
    }
    .top-bar select:focus {
      border-color: #D2AC47;
      outline: none;
    }
    .progress-counter {
      background: rgba(210, 172, 71, 0.25);
      color: #F7EF8A;
      padding: 5px 10px;
      border-radius: 50px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.85rem;
    }
    #main-container {
      display: flex;
      flex-direction: column;
      height: 650px;
      gap: 12px;
    }
    .content-area {
      display: flex;
      gap: 12px;
      height: 100%;
    }
    #topics-list-container {
  flex: 1 1 auto; /* <-- Adicionado '1 1 auto' para garantir o crescimento */
  border: 1px solid #333;
  border-radius: 6px;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  min-width: 200px;
  background: #000000;
  /* max-height: 500px; <-- Comentado/removido para permitir crescimento livre */
  overflow-y: auto;
}
    .list-header {
      background: linear-gradient(to right, #222, #111);
      color: #F7EF8A;
      padding: 10px 12px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      font-size: 1.3rem;
    }
    #topics-list {
      flex: 1;
      overflow-y: auto;
      list-style: none;
      background: #000000;
    }
    
    /* 4. Ícone de edição sempre visível */
    .topic-item {
      padding: 10px 12px;
      border-bottom: 1px solid #333;
      cursor: pointer;
      transition: all 0.2s ease;
      color: #eee;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .topic-item:hover {
      background: linear-gradient(to right, #2a2a2a, #222);
      transform: translateX(3px);
      box-shadow: inset 3px 0 6px rgba(244, 232, 131, 0.15);
    }
    .topic-item.active {
      background: rgba(210, 172, 71, 0.15);
      border-left: 3px solid #D2AC47;
      box-shadow: inset 3px 0 8px rgba(210, 172, 71, 0.25);
    }
    
    .topic-content {
      flex: 1;
    }
    
    .topic-title {
      font-weight: bold;
      margin-bottom: 4px;
      color: #F7EF8A;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
    }
    
    /* 1. Ícones de status duplos para tópicos */
    .status-icons {
      display: flex;
      gap: 4px;
      margin-right: 8px;
    }

    .status-icon {
      width: 16px;
      height: 16px;
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
    }

    .status-estudado {
      background: #4CAF50;
      color: white;
    }

    .status-revisado {
      background: #FFC107;
      color: black;
    }
    .status-questoes {
  background: #2196F3;  /* Azul */
  color: white;
}
/* === CONTROLES RÁPIDOS NA LISTA === */
.quick-controls {
  display: flex;
  gap: 6px;
  align-items: center;
  margin-right: 12px;
}

.quick-checkbox {
  width: 22px;
  height: 22px;
  border: 2px solid #555;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 12px;
  background: #222;
}

.quick-checkbox:hover {
  border-color: #D2AC47;
  transform: scale(1.1);
}

.quick-checkbox.checked-estudo {
  background: #4CAF50;
  border-color: #4CAF50;
  color: white;
}

.quick-checkbox.checked-questoes {
  background: #2196F3;
  border-color: #2196F3;
  color: white;
}
.quick-checkbox.checked-flashcards {
  background: #9C27B0;
  border-color: #9C27B0;
  color: white;
}

.quick-revisao-counter {
  min-width: 28px;
  height: 22px;
  padding: 0 6px;
  background: #333;
  border: 2px solid #555;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 11px;
  font-weight: bold;
  color: #999;
  transition: all 0.2s ease;
}

.quick-revisao-counter:hover {
  border-color: #FFC107;
  background: #3a3a3a;
}

.quick-revisao-counter.has-revisoes {
  background: #FFC107;
  border-color: #FFC107;
  color: #000;
}

/* Tooltip para os controles */
.quick-controls [title]:hover::after {
  content: attr(title);
  position: absolute;
  bottom: -25px;
  left: 50%;
  transform: translateX(-50%);
  background: #333;
  color: #F7EF8A;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 10px;
  white-space: nowrap;
  z-index: 100;
}

/* Mini popup para editar revisões */
.revisao-popup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #111;
  border: 2px solid #D2AC47;
  border-radius: 8px;
  padding: 20px;
  z-index: 2000;
  box-shadow: 0 8px 24px rgba(0,0,0,0.5);
  min-width: 280px;
}

.revisao-popup h4 {
  color: #F7EF8A;
  margin-bottom: 15px;
  font-size: 1rem;
}

.revisao-popup input {
  width: 100%;
  padding: 8px;
  background: #222;
  border: 2px solid #555;
  border-radius: 4px;
  color: #FFC107;
  font-size: 1.1rem;
  font-weight: bold;
  text-align: center;
  margin-bottom: 15px;
}

.revisao-popup-buttons {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
}

.popup-backdrop {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.7);
  z-index: 1999;
}
    .edit-icon {
      color: #D2AC47;
      opacity: 0.7;
      font-size: 0.9rem;
      margin-left: 8px;
      transition: all 0.3s ease;
    }

    .edit-icon:hover {
      opacity: 1;
      transform: scale(1.1);
    }
    
    .topic-discipline {
      background: rgba(210, 172, 71, 0.25);
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 1.2rem;
      color:white;
      font-weight: 500;
    }
    .topic-subtopic {
      font-size: 1.2rem;
      color: #ffffff;
      margin-top: 4px;
      font-style: italic;
    }
    #topic-detail-container {
      flex: 2;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      background: #000000;
      position: relative;
    }
    #topic-detail-title {
      font-size: 1.3rem;
      font-weight: bold;
      margin-bottom: 8px;
      color: #F7EF8A;
      padding-bottom: 8px;
      border-bottom: 1px solid #333;
    }
    #topic-detail-discipline {
      font-size: 0.85rem;
      color: white;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 5px;
      font-weight: 500;
    }
    .topic-info {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 5px;
      padding: 10px;
      border: 1px solid #333;
    }
    .info-field {
      display: flex;
      margin-bottom: 8px;
      align-items: center;
    }
    .info-field:last-child {
      margin-bottom: 0;
    }
    .info-label {
      font-weight: bold;
      min-width: 80px;
      color: #F7EF8A;
      font-size: 0.85rem;
    }
    .info-value {
      flex: 1;
      color: #fff;
      font-size: 0.85rem;
    }
    .info-value.editable {
      background: rgba(210, 172, 71, 0.1);
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px dashed #D2AC47;
    }
    .edit-input {
      width: 100%;
      padding: 4px 8px;
      border: 1px solid #D2AC47;
      border-radius: 4px;
      background: #222;
      color: #fff;
      font-size: 0.85rem;
    }
    .edit-input:focus {
      outline: none;
      border-color: #F7EF8A;
    }
    .progress-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px;
      border-radius: 5px;
      background: rgba(255, 255, 255, 0.05);
    }
    .progress-label {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .progress-label i {
      color: #D2AC47;
    }
    .progress-status {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    /* --- ESTILOS DOS CHECKBOXES PERSONALIZADOS --- */
    .custom-checkbox {
      display: inline-flex;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }
    .custom-checkbox input[type="checkbox"] {
      opacity: 0;
      position: absolute;
      width: 0;
      height: 0;
    }
    .checkmark {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      border: 2px solid #555;
      background-color: #222;
      color: transparent;
      font-size: 14px;
      font-weight: bold;
      border-radius: 4px;
      transition: all 0.2s ease;
    }
.custom-checkbox input[type="checkbox"]:checked + .checkmark {
  color: white;
  border-color: #4CAF50;
}

/* Cores específicas para cada tipo de checkbox */
.custom-checkbox.estudo input[type="checkbox"]:checked + .checkmark {
  background-color: #4CAF50; /* Verde */
  border-color: #4CAF50;
}

.custom-checkbox.revisao input[type="checkbox"]:checked + .checkmark {
  background-color: #FFC107; /* Amarelo */
  border-color: #FFC107;
  color: black;
}

.custom-checkbox.questoes input[type="checkbox"]:checked + .checkmark {
  background-color: #2196F3; /* Azul */
  border-color: #2196F3;
    }
	.custom-checkbox.flashcards input[type="checkbox"]:checked + .checkmark {
  background-color: #9C27B0; /* Roxo */
  border-color: #9C27B0;
}
    .custom-checkbox input[type="checkbox"]:hover + .checkmark {
      border-color: #D2AC47;
    }
    .date-input {
      padding: 5px 8px;
      border: 1px solid #555;
      border-radius: 4px;
      background: #222;
      color: #fff;
      font-size: 0.85rem;
    }
    .resize-handle {
      position: absolute;
      right: 5px;
      top: 5px;
      background: #D2AC47;
      color: #0D0D09;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 10;
      transition: all 0.3s;
      font-size: 0.75rem;
    }
    .resize-handle:hover {
      transform: scale(1.1);
      background: #F7EF8A;
    }
    .topic-actions {
      display: flex;
      gap: 8px;
      padding-top: 12px;
      border-top: 1px solid #333;
      margin-top: auto;
      z-index: 10;
    }
    .topic-actions button {
      padding: 7px 12px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.85rem;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .topic-actions button.loading {
      pointer-events: none;
      opacity: 0.7;
    }
    .topic-actions button:hover {
      transform: translateY(-1px);
      opacity: 0.9;
    }
    .btn-save {
      background: linear-gradient(135deg, #D2AC47, #F7EF8A, #AE8625);
      color: #0D0D09;
    }
    .btn-reset {
      background: linear-gradient(135deg, #D2AC47, #F7EF8A, #AE8625);
      color: #0D0D09;
    }
    .btn-edit {
      background: linear-gradient(135deg, #D2AC47, #F7EF8A, #AE8625);
      color: #0D0D09;
    }
    .btn-cancel {
      background: linear-gradient(135deg, #666, #999, #444);
      color: #fff;
    }
    .edit-mode-banner {
      background: linear-gradient(135deg, #D2AC47, #F7EF8A);
      color: #0D0D09;
      padding: 8px 12px;
      border-radius: 5px;
      margin-bottom: 12px;
      text-align: center;
      font-weight: bold;
      display: none;
    }
    /* LOGIN STYLES - CORES IGUAIS AO PROJETO ANOTAÇÕES */
    #login-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 25px;
      text-align: center;
      height: 100%;
    }
    #login-form {
      background: #111;
      padding: 20px;
      border-radius: 8px;
      max-width: 380px;
      width: 100%;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      border: 1px solid #333;
    }
    #login-form h2 {
      color: #D2AC47;
      margin-bottom: 12px;
      font-size: 1.2rem;
    }
    #login-form p {
      margin-bottom: 12px;
      font-size: 0.85rem;
    }
    #login-form input {
      width: 100%;
      padding: 8px;
      margin-bottom: 12px;
      border: 1px solid #555;
      border-radius: 5px;
      font-size: 0.85rem;
      transition: border-color 0.3s;
      background: #222;
      color: #fff;
    }
    #login-form input:focus {
      border-color: #D2AC47;
      outline: none;
    }
    #login-form button {
      background: linear-gradient(135deg, #D2AC47, #F7EF8A, #AE8625);
      color: #0D0D09;
      border: none;
      padding: 10px 16px;
      border-radius: 5px;
      font-size: 0.9rem;
      cursor: pointer;
      font-weight: bold;
      width: 100%;
      transition: all 0.3s ease;
      position: relative;
    }
    #login-form button:hover {
      background: linear-gradient(135deg, #F4E883, #D2AC47, #AE8625);
      transform: translateY(-1px);
    }
    .login-spinner {
      display: none;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(210, 172, 71, 0.3);
      border-radius: 50%;
      border-top-color: #D2AC47;
      animation: spin 1s ease-in-out infinite;
      margin: 8px auto;
    }
    #login-error {
      color: #D2AC47;
      margin-top: 10px;
      text-align: center;
      display: none;
      font-size: 0.85rem;
    }
    .logout-button {
      background: none;
      border: none;
      cursor: pointer;
      color: #D2AC47;
      font-size: 0.9rem;
      margin-left: 6px;
      transition: color 0.3s;
    }
    .logout-button:hover {
      color: #F7EF8A;
    }
    #loading-message, #error-message {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
      font-size: 1rem;
      flex-direction: column;
      gap: 12px;
      text-align: center;
      background: #000000;
      border-radius: 6px;
      padding: 15px;
      color: #F7EF8A;
    }
    #loading-message i {
      font-size: 2rem;
      color: #D2AC47;
      animation: spin 1.5s linear infinite;
    }
    #error-message {
      color: #D2AC47;
    }
    .notification-container {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 1000;
      max-width: 280px;
      width: 100%;
    }
    .notification {
      background: #111;
      border-radius: 5px;
      padding: 10px 14px;
      margin-bottom: 8px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      gap: 8px;
      animation: slideIn 0.3s ease, fadeOut 0.3s ease 7.7s forwards;
      border-left: 3px solid #D2AC47;
      transition: transform 0.3s;
      color: #F7EF8A;
      font-size: 0.85rem;
    }
    .notification:hover {
      transform: translateY(-2px);
    }
    .notification.error {
      border-left-color: #D2AC47;
    }
    .notification-icon {
      font-size: 1.1rem;
    }
    .success .notification-icon {
      color: #D2AC47;
    }
    .error .notification-icon {
      color: #D2AC47;
    }
    .notification-content {
      flex: 1;
    }
    .notification-title {
      font-weight: bold;
      margin-bottom: 3px;
      font-size: 0.9rem;
    }
    .notification-close {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      color: #777;
      transition: color 0.3s;
    }
    .notification-close:hover {
      color: #F7EF8A;
    }
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 999;
      display: none;
    }
	.modal-backdrop#confirmModal {
  z-index: 1001; /* Garante que a confirmação fique sobre outros modais */
}
    .modal {
      background: #111;
      border-radius: 6px;
      padding: 15px;
      max-width: 380px;
      width: 90%;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      transform: translateY(-12px);
      animation: modalAppear 0.4s ease forwards;
      border: 1px solid #333;
      color: #F7EF8A;
    }
    .modal h3 {
      margin-bottom: 12px;
      color: #D2AC47;
      font-size: 1.2rem;
    }
    .modal p {
      margin-bottom: 15px;
      font-size: 0.9rem;
      line-height: 1.5;
    }
    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }
    .modal-buttons button {
      padding: 7px 14px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      font-size: 0.85rem;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .modal-buttons button.loading {
      pointer-events: none;
      opacity: 0.7;
    }
    .modal-buttons button:hover {
      transform: translateY(-1px);
      opacity: 0.9;
    }
    .btn-modal-confirm {
      background: linear-gradient(135deg, #D2AC47, #F7EF8A, #AE8625);
      color: #0D0D09;
    }
    .btn-modal-cancel {
      background: linear-gradient(135deg, #D2AC47, #F7EF8A, #AE8625);
      color: #0D0D09;
    }
    /* --- VISÃO GERAL AVANÇADA --- */
    .overview-modal-content {
      display: flex;
      flex-direction: column;
      gap: 20px;
      max-height: 80vh;
      overflow-y: auto;
      padding: 10px;
      text-align: left;
    }
    .overview-text-summary {
      background: #000000;
      padding: 14px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 1.05rem;
      line-height: 1.7;
      border: 1px solid #555;
      white-space: pre-wrap;
    }
    .overview-chart {
      background: #000000;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #555;
    }
    .chart-title {
      color: #F7EF8A;
      margin-bottom: 12px;
      font-weight: bold;
      text-align: center;
      font-size: 1.5rem;
    }
    /* Gráfico 1 */
    .chart-1-container {
      display: flex;
      justify-content: center;
      gap: 30px;
      align-items: flex-end;
      height: 130px;
      padding: 10px 0;
    }
    .bar {
      width: 60px;
      border-radius: 4px 4px 0 0;
      position: relative;
    }
    .bar-label {
      position: absolute;
      bottom: -28px;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 0.9rem;
      color: #fff;
    }
    .bar.estudado { background: #4CAF50; }
    .bar.nao-estudado { background: #F44336; }
    /* Gráfico 2 */
    .discipline-progress {
      margin-bottom: 14px;
    }
	/* NOVO ESTILO PARA O CAMPO DE REVISÕES */
.revisao-count-input {
  width: 60px;
  padding: 6px 8px;
  border: 2px solid #FFC107;
  border-radius: 8px;
  background: #222;
  color: #FFC107;
  font-weight: bold;
  text-align: center;
  font-size: 0.9rem;
}

.revisao-count-input:focus {
  outline: none;
  border-color: #FFD54F;
  background: #333;
}

/* Mantém a caixa amarela de status na lista */
.status-revisado {
  background: #FFC107;
  color: black;
  font-weight: bold;
  min-width: 20px;
  text-align: center;
}
    .discipline-name {
      font-size: 1.1rem;
      margin-bottom: 5px;
      color: #F7EF8A;
      display: flex;
      justify-content: space-between;
      cursor: pointer;
    }
    .progress-bar-container {
      height: 22px;
      background: #333;
      border-radius: 11px;
      overflow: hidden;
    }
    .progress-bar-fill {
      height: 100%;
	  background: linear-gradient(to right, #2E7D32, #4CAF50);
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 10px;
      color: #000;
      font-size: 0.8rem;
      font-weight: bold;
    }
    /* Gráfico 3 */
    .chart-3-container {
      display: flex;
      justify-content: center;
      gap: 40px;
      align-items: flex-end;
      height: 150px;
      padding: 10px 0;
    }
    .stacked-bar {
      width: 50px;
      display: flex;
      flex-direction: column-reverse;
      border-radius: 4px 4px 0 0;
    }
    .stacked-segment {
      width: 100%;
    }
    .segment-revisado { background: #2196F3; }
    .segment-nao-revisado { background: #9E9E9E; }
    
    /* ESTILOS PARA AS CAIXAS DE VISÃO GERAL - ALINHADAS */
    .overview-box {
      padding: 0px 6px !important;
      font-size: 1.2rem !important;
      line-height: 0.8 !important;
      min-height: 6px !important;
      display: inline-flex !important;
      align-items: center !important;
      justify-content: center !important;
      border-radius: 5px !important;
      text-align: center;
      flex: 1;
      margin: 1px;
    }
    
    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2px;
      gap: 8px;
    }

    /* --- NOVO MODAL: METAS DO USUÁRIO --- */
    #userGoalsModal .modal {
      max-width: 900px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    .form-field-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 12px;
    }
    .form-field {
      flex: 1;
      min-width: 200px;
    }
    .form-field label {
      display: block;
      margin-bottom: 4px;
      font-size: 0.85rem;
      color: #F7EF8A;
    }
   .form-field input[type="number"],
.form-field input[type="date"],
.form-field input[type="time"] {
  width: 100%;
  padding: 6px 8px;
  border: 1px solid #555;
  border-radius: 4px;
  background: #fff;
  color: #0000ff;
  font-size: 0.85rem;
  font-weight: bold;
  text-align: center;
}
    .form-field input[type="number"]:focus,
    .form-field input[type="date"]:focus {
      border-color: #D2AC47;
      outline: none;
    }

    /* ESTILOS PARA O RAIO X (NOVOS) */
    .resources-list {
      list-style: none;
      margin-top: 5px;
    }
    .resources-list li {
      padding: 2px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .critical-points {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 8px 12px;
      border-radius: 4px;
      margin-top: 10px;
      color: #000;
    }
    
    /* NOVOS ESTILOS PARA AS CORREÇÕES SOLICITADAS */
    .dicas-content {
  line-height: 0.9 !important;
  font-size: 0.95rem !important;
  color: #ffffff !important; /* CORREÇÃO 6: Texto das dicas em branco */
}
.dicas-content div {
  margin-bottom: 1px !important;
  color: #ffffff !important; /* CORREÇÃO 6: Texto das dicas em branco */
}
.dicas-content br {
  display: none !important;
}
.bigger-font {
  font-size: 1.5em !important;
  font-weight: bold !important;
  line-height: 1.2 !important;
}
.raiox-personalizadas .overview-text-summary {
  font-size: 1.2em !important;
  line-height: 1.4 !important;
}
.raiox-personalizadas .overview-text-summary div {
  font-size: 1.25em !important;
}
.raiox-medias .overview-text-summary div {
  font-size: 1.25em !important;
}

/* NOVOS ESTILOS PARA BOTÃO DADOS - CONTAINERS INDIVIDUAIS */
.dados-container {
  display: flex;
  flex-direction: column;
  gap: 15px;
  margin-bottom: 20px;
}
.dados-item {
  background: #000000;
  border: 1px solid #555;
  border-radius: 8px;
  padding: 15px;
  text-align: center;
}
.dados-label {
  font-weight: bold;
  color: #FFD700;
  font-size: 1rem;
  margin-bottom: 8px;
}
.dados-value {
  color: #ffffff;
  font-size: 1.4em;
  font-weight: bold;
}

/* CORREÇÃO 4: Aumentar tamanho das letras na distribuição de questões */
.distribuicao-questoes {
  font-size: 1.2em !important;
}
.distribuicao-questoes div {
  font-size: 1.1em !important;
}

    /* ANIMAÇÃO DE PULSAÇÃO PARA FEEDBACK POSITIVO */
    .pulse-animation {
        animation: pulseSuccess 0.6s ease-in-out 2;
    }
    
    @keyframes pulseSuccess {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    @keyframes modalAppear {
      from { opacity: 0; transform: translateY(-12px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* --- ESTILOS DA AGENDA (FASE 2) --- */
/* ESTILO PARA O CONTAINER COM ROLAGEM NA VISÃO SEMANAL */
.week-grid-container {
  height: 65vh;
  overflow-y: auto;
  border: 1px solid #333;
  border-radius: 6px;
  padding: 10px;
  background: #000;
}
/* ESTILO PARA O CONTAINER COM ROLAGEM NA VISÃO MENSAL */
.monthly-agenda {
  max-height: 70vh;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 10px;
}

.monthly-agenda::-webkit-scrollbar {
  width: 8px;
}

.monthly-agenda::-webkit-scrollbar-track {
  background: #111;
  border-radius: 4px;
}

.monthly-agenda::-webkit-scrollbar-thumb {
  background: #D2AC47;
  border-radius: 4px;
}

.monthly-agenda::-webkit-scrollbar-thumb:hover {
  background: #F7EF8A;
}
/* Estilo para os dias do calendário mensal */
.calendar-day {
  min-height: 100px !important;
  max-height: 140px; /* Define uma altura máxima antes da rolagem aparecer */
  overflow-y: auto;  /* Adiciona a barra de rolagem vertical quando necessário */
  padding: 8px !important;
  padding-right: 12px; /* Adiciona espaço para a barra de rolagem não cobrir o texto */
}

/* Estilo customizado para a nova barra de rolagem dos dias */
.calendar-day::-webkit-scrollbar {
    width: 5px;
}
.calendar-day::-webkit-scrollbar-track {
    background: rgba(0,0,0,0.2);
    border-radius: 3px;
}
.calendar-day::-webkit-scrollbar-thumb {
    background: #555;
    border-radius: 3px;
}
.calendar-day::-webkit-scrollbar-thumb:hover {
    background: #D2AC47;
}

.empty-day {
  min-height: 100px !important;
}
.week-grid {
  display: grid;
  grid-template-columns: 100px repeat(7, 1fr);
  gap: 8px;
  min-height: min-content;
}
    /* Botão de adicionar bloco */
    .add-block-btn {
      position: absolute;
      bottom: 5px;
      right: 5px;
      background: #333;
      border: none;
      color: #D2AC47;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .add-block-btn:hover {
      background: #D2AC47;
      color: #000;
    }

    /* Botão de deletar bloco */
    .delete-block {
      background: none;
      border: none;
      color: #ff4444;
      cursor: pointer;
      font-size: 0.9rem; /* Tamanho do ícone */
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.3s ease;
      padding: 0;
    }

    .delete-block:hover {
      background: #ff4444;
      color: #fff;
    }

    .delete-block:hover {
      background: #ff4444;
      color: #000;
    }

    /* Estados de drag & drop */
    .time-slot.drag-over {
      border-color: #F7EF8A;
      background: rgba(210, 172, 71, 0.1);
    }

    /* Calendário mensal */
   .calendar-day.today {
  border: 2px solid #F7EF8A !important;
  background-color: rgba(210, 172, 71, 0.15) !important;
  box-shadow: 0 0 8px rgba(244, 232, 131, 0.25);
}

    .calendar-day.has-studies {
      background: linear-gradient(135deg, #333, #222) !important;
    }

    /* Estatísticas mensais */
    .stat-card {
      background: #333;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      transition: transform 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-2px);
    }

    /* Configurações */
    .config-section {
      background: rgba(255, 255, 255, 0.05);
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #333;
    }

    .config-section h5 {
      color: #D2AC47;
      margin-bottom: 15px;
      font-size: 1rem;
    }
.agenda-config {
  max-height: 65vh; /* Limita a altura máxima da área de configurações */
  overflow-y: auto; /* Adiciona a barra de rolagem vertical se o conteúdo ultrapassar a altura */
  padding: 0 15px 15px 10px; /* Adiciona um preenchimento para a barra de rolagem não cobrir o conteúdo */
}
    /* Abas da Agenda */
    .agenda-tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 15px;
      border-bottom: 1px solid #333;
      padding-bottom: 10px;
    }

    .agenda-tab {
      background: #222;
      border: 1px solid #555;
      color: #F7EF8A;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.85rem;
    }

    .agenda-tab.active {
      background: linear-gradient(135deg, #D2AC47, #F7EF8A, #AE8625);
      color: #0D0D09;
      font-weight: bold;
    }

    .agenda-tab:hover {
      background: #333;
    }

    .agenda-tab.active:hover {
      background: linear-gradient(135deg, #F4E883, #D2AC47, #AE8625);
    }

    /* Blocos de estudo */
    .study-block {
      background: #333;
      padding: 8px;
      margin-bottom: 5px;
      border-radius: 4px;
      border-left: 4px solid #D2AC47;
      cursor: move;
      transition: all 0.3s ease;
    }

    .study-block:hover {
      background: #3a3a3a;
      transform: translateY(-1px);
    }

    .study-block.concluido {
      opacity: 0.7;
      border-left-color: #4CAF50;
    }

    /* Slots de tempo */
    .time-slot {
  min-height: 120px;
  background: #222;
  border: 2px dashed #555;
  padding: 8px;
  border-radius: 5px;
  transition: all 0.3s ease;
  position: relative; /* <<< ESSA LINHA FOI ADICIONADA */
}

    .time-slot:hover {
      border-color: #D2AC47;
      background: #2a2a2a;
    }

    .time-slot.drag-over {
      border-color: #F7EF8A;
      background: rgba(210, 172, 71, 0.1);
    }

    /* Cabeçalhos */
    .day-header, .period-header {
      background: #333;
      padding: 10px;
      text-align: center;
      font-weight: bold;
      color: #F7EF8A;
      border-radius: 4px;
    }

.weekly-agenda {
  overflow-x: auto;
}

    /* Responsividade */
    @media (max-width: 768px) {
      .week-grid {
        grid-template-columns: 80px repeat(7, 1fr) !important;
        font-size: 0.8rem;
      }
      
      .day-header, .period-header {
        padding: 5px !important;
        font-size: 0.7rem;
      }
      
      .time-slot {
        min-height: 100px !important;
        padding: 5px !important;
      }
      
      .study-block {
        padding: 5px !important;
      }
      
      .agenda-header {
        flex-direction: column;
        gap: 10px;
      }

      #main-container {
  display: flex;
  flex-direction: column;
  min-height: 500px; /* <-- Alterado de 'height' para 'min-height' */
  gap: 12px;
}
      header h1 {
        font-size: 1.4rem;
      }
      .app-header {
        flex-direction: column;
        gap: 8px;
        align-items: flex-start;
      }
      .progress-app {
        padding: 10px;
      }
      #topics-list-container {
        min-width: unset;
        max-width: unset;
        height: 180px;
      }
      .user-info {
        font-size: 0.8rem;
      }
      .progress-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      .progress-status {
        width: 100%;
        justify-content: space-between;
      }
      .info-field {
        flex-direction: column;
        align-items: flex-start;
      }
      .info-label {
        margin-bottom: 4px;
      }
      .summary-row {
        flex-direction: column;
        gap: 4px;
      }
      .form-field-row {
        flex-direction: column;
      }
      .dados-container {
        grid-template-columns: 1fr;
      }
      .search-container {
        max-width: 100%;
        grid-column: 1 / -1;
      }
      .topic-item {
        flex-direction: column;
        align-items: flex-start;
      }
      .edit-icon {
        align-self: flex-end;
        margin-top: 5px;
      }
    }
    @media (max-width: 480px) {
      body {
        padding: 8px;
      }
      .container {
        padding: 10px;
        border-radius: 8px;
      }
      .topic-actions {
        flex-direction: column;
      }
      #login-container {
        padding: 15px;
      }
      #login-form {
        padding: 15px;
      }
    }
	/* Estilo personalizado para Minha Visão Geral de Progresso */
.custom-progress-bar-fill {
  height: 100%;
  /* background-color será definido inline pelo JavaScript */
  display: flex;
  align-items: center;
  justify-content: flex-end;
  padding-right: 10px;
  color: #000;
  font-size: 0.8rem;
  font-weight: bold;
}
/* ESTILO ESPECÍFICO PARA BARRAS DE REVISÃO NO GRÁFICO 3 */
.revisao-bar-fill {
  height: 100%;
  background: linear-gradient(to right, #FFC107, #FFD54F);
  display: flex;
  align-items: center;
  justify-content: flex-end;
  padding-right: 10px;
  color: #000;
  font-size: 0.8rem;
  font-weight: bold;
}
/* Estilo de Carregamento (Spinner) */
.quick-controls .loading {
  border-radius: 50% !important; /* Transforma em círculo */
  border: 2px solid rgba(210, 172, 71, 0.3);
  border-top-color: #D2AC47;
  color: transparent !important; /* Esconde o texto/ícone de dentro */
  animation: spin 1s linear infinite;
  pointer-events: none; /* Impede cliques múltiplos */
}
/* Estilo de Sucesso (Pulso Verde) */
.quick-controls .success {
  border-color: #4CAF50 !important;
  background-color: rgba(76, 175, 80, 0.2) !important;
  animation: pulseSuccess 0.5s ease-out;
}
/* Estilo de Erro (Tremor Vermelho) */
.quick-controls .error {
  border-color: #F44336 !important;
  background-color: rgba(244, 67, 54, 0.2) !important;
  animation: shakeError 0.5s ease-out;
}
/* Animações */
@keyframes spin {
  to { transform: rotate(360deg); }
}
@keyframes pulseSuccess {
  0% { transform: scale(1); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}
@keyframes shakeError {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-3px); }
  75% { transform: translateX(3px); }
}
/* --- ESTILOS PARA A BARRA DE PROGRESSO DINÂMICA (CHICO CONCURSOS) --- */
#chico-progress-bar-container {
    flex: 1;
    display: none; /* Começa escondido por padrão */
    flex-direction: column;
    align-items: center;
    gap: 4px;
    margin-left: 20px;
}
.time-allocation-label {
    font-size: 0.8rem;
    font-weight: bold;
    color: #F7EF8A;
	 /* >>>>> LINHAS NOVAS ADICIONADAS AQUI <<<<< */
    width: 100%;
    text-align: center;
    /* >>>>> FIM DAS LINHAS NOVAS <<<<< */
}
.time-allocation-bar {
    width: 100%;
    max-width: 300px;
    height: 22px;
    background-color: #111;
    border-radius: 11px;
    display: flex;
    overflow: hidden;
    border: 1px solid #555;
}
.bar-segment {
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #000;
    font-weight: bold;
    font-size: 0.75rem;
    transition: width 0.5s ease-in-out;
    white-space: nowrap;
}
.new-content-segment {
    background: linear-gradient(to right, #2E7D32, #4CAF50);
}
.review-segment {
    background: linear-gradient(to right, #FFC107, #FFD54F);
}
/* --- ESTILOS PARA O TIMER DE FOCO (POMODORO) --- */
#focus-timer-container {
    display: flex;
    align-items: center;
    gap: 10px;
    background: rgba(0,0,0,0.2);
    padding: 5px 12px;
    border-radius: 50px;
    border: 1px solid #444;
    margin-left: 20px;
}
#timer-display {
    font-size: 1.4rem;
    font-weight: bold;
    color: #F7EF8A;
    min-width: 70px;
    text-align: center;
}
.timer-controls button {
    background: none;
    border: none;
    color: #F7EF8A;
    font-size: 1.2rem;
    cursor: pointer;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    transition: all 0.2s ease;
}
.timer-controls button:hover {
    background-color: rgba(210, 172, 71, 0.2);
    transform: scale(1.1);
}
#pomodoro-cycles {
    font-size: 1rem;
    color: #aaa;
}
/* --- ESTILO PARA MENSAGEM DE AJUDA DO MÉTODO CHICO --- */
.chico-helper-text {
    font-size: 0.75rem;
    color: #FFC107;
    background-color: rgba(255, 193, 7, 0.1);
    border-left: 3px solid #FFC107;
    padding: 5px 8px;
    margin-top: 5px;
    border-radius: 4px;
    display: none; /* Começa escondido */
}
/* --- ESTILOS PARA OS BOTÕES DE DIFICULDADE --- */
.btn-difficulty {
    flex: 1;
    padding: 6px 10px;
    border: 2px solid #555;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    font-size: 0.8rem;
    transition: all 0.2s ease;
    background: #222;
    color: #fff;
}

.btn-difficulty:hover {
    transform: translateY(-2px);
    border-color: #F7EF8A;
}

.btn-difficulty.active {
    color: #0D0D09;
}

.btn-difficulty[data-level="Fácil"].active {
    background: #4CAF50; /* Verde */
    border-color: #4CAF50;
}

.btn-difficulty[data-level="Médio"].active {
    background: #FFC107; /* Amarelo */
    border-color: #FFC107;
}

.btn-difficulty[data-level="Difícil"].active {
    background: #F44336; /* Vermelho */
    border-color: #F44336;
}
/* --- ESTILO PARA O NOVO BOTÃO DE FECHAR --- */
.btn-fechar-novo {
  /* Forma e Tamanho */
  width: 28px;
  height: 28px;
  border-radius: 50%;
  
  /* Cor e Fundo */
  background: linear-gradient(135deg, #7A0000 5%, #FF4D4D 45%, #A10000 100%);
  color: white;
  border: 1px solid #FFC9C9;
  
  /* Conteúdo ("X") */
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  font-size: 16px;
  font-weight: bold;
  line-height: 1;

  /* Layout */
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;
  
  /* Efeitos */
  cursor: pointer;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  flex-shrink: 0; /* Impede que o botão seja esmagado */
}

.btn-fechar-novo:hover {
  transform: scale(1.1);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
}
/* --- FIM DO ESTILO --- */
  </style>
</head>
<body>
  <div class="container">
    <div class="app-container">
	<header>
      <h1>EDITAL VERTICALIZADO PPMG-2025</h1>
    </header>
      <div class="progress-app">
        <!-- CONTAINER DE LOGIN -->
        <div id="login-container" style="display: flex;">
          <form id="login-form">
            <h2><i class="fas fa-user-circle"></i> Acesso ao Sistema</h2>
            <p>Digite o nome do usuário conforme configurado pelo administrador:</p>
            <input type="text" id="user-name" placeholder="Nome do usuário" required>
            <button type="submit">
              <i class="fas fa-sign-in-alt"></i> Acessar
              <i class="fas fa-spinner button-spinner" style="display: none;"></i>
            </button>
            <div class="login-spinner" id="login-spinner"></div>
            <div id="login-error" style="display: none;"></div>
            <p style="margin-top: 15px; font-size: 0.8rem; color: #888;">
              <i class="fas fa-info-circle"></i> O nome do usuário deve corresponder exatamente ao configurado na planilha.
            </p>
          </form>
        </div>
        <!-- CONTEÚDO PRINCIPAL (APÓS LOGIN) -->
        <div id="app-content" style="display: none;">
          <div class="app-header">
            <div class="user-info">
              <i class="fas fa-user-circle"></i>
              <span id="user-name-display">Usuário</span>
              <button class="logout-button" onclick="logout()" title="Sair">
                <i class="fas fa-sign-out-alt"></i>
              </button>
            </div>
          </div>
          <div class="top-bar">
            <button onclick="showProgressOverviewWithLoading()">
              <i class="fas fa-chart-bar"></i> Visão Geral
              <i class="fas fa-spinner button-spinner" style="display: none;"></i>
            </button>
            <button onclick="showIndividualProgressOverviewWithLoading()">
              <i class="fas fa-chart-bar"></i> Minha Visão Geral
              <i class="fas fa-spinner button-spinner" style="display: none;"></i>
            </button>
            <button onclick="openUserGoalsModal()">
              <i class="fas fa-bullseye"></i> Minhas Metas
              <i class="fas fa-spinner button-spinner" style="display: none;"></i>
            </button>
            <button onclick="showRaioXOverviewWithLoading()">
              <i class="fas fa-binoculars"></i> Raio X do Edital
              <i class="fas fa-spinner button-spinner" style="display: none;"></i>
            </button>
            <!-- NOVO BOTÃO DADOS -->
            <button onclick="showDadosOverviewWithLoading()">
  <i class="fas fa-database"></i> Dados
  <i class="fas fa-spinner button-spinner" style="display: none;"></i>
</button>
<button onclick="showEstatisticasMetasWithLoading()">
  <i class="fas fa-chart-line"></i> Estatísticas
  <i class="fas fa-spinner button-spinner" style="display: none;"></i>
</button>
<!-- NOVO BOTÃO AGENDA -->
<button onclick="showAgendaWithLoading()">
  <i class="fas fa-calendar-alt"></i> Agenda
  <i class="fas fa-spinner button-spinner" style="display: none;"></i>
</button>
<div class="search-container">
              <div class="search-expanded">
                <input type="text" id="searchInput" placeholder="Tópicos" oninput="filterTopics()">
              </div>
              <select id="disciplineFilter" onchange="filterTopics()">
                <option value="">Todas as Disciplinas</option>
              </select>
            </div>
          </div>
          <div id="main-container">
            <div id="loading-message">
              <i class="fas fa-spinner"></i>
              <p>Carregando progresso...</p>
            </div>
            <div id="error-message" style="display:none;"></div>
            <div class="content-area">
              <div id="topics-list-container" style="display:none;">
                <div class="list-header">
                  <span>Tópicos do Edital</span>
                  <span id="filtered-counter">0/0</span>
                </div>
                <ul id="topics-list"></ul>
              </div>
              <div id="topic-detail-container" style="display:none;">
    <button class="btn-fechar-novo" title="Fechar e voltar à lista" onclick="closeTopicDetails()" style="position: absolute; top: 8px; right: 8px; z-index: 10;">X</button>
                <!-- Banner de Modo Edição -->
                <div class="edit-mode-banner" id="edit-mode-banner">
                  <i class="fas fa-edit"></i> MODO EDIÇÃO ATIVADO - Você está editando informações do tópico
                </div>
                <div id="topic-detail-title">Título do Tópico</div>
                <div id="topic-detail-discipline">
                  <i class="fas fa-book"></i>
                  <span>Disciplina</span>
                </div>
                <!-- Nova estrutura: Informações + Controles de Progresso em colunas -->
                <div style="display: flex; gap: 15px; margin-top: 10px;">
                  <!-- Coluna da Esquerda: Informações do Tópico -->
                  <div class="topic-info" style="flex: 1; min-width: 250px;">
                    <div class="info-field">
                      <span class="info-label">Disciplina:</span>
                      <span class="info-value" id="info-disc">Carregando...</span>
                      <input type="text" class="edit-input" id="edit-disc" style="display: none;">
                    </div>
                    <div class="info-field">
                      <span class="info-label">Sequência:</span>
                      <span class="info-value" id="info-seq">Carregando...</span>
                      <input type="text" class="edit-input" id="edit-seq" style="display: none;">
                    </div>
                    <div class="info-field">
                      <span class="info-label">Tópico:</span>
                      <span class="info-value" id="info-topico">Carregando...</span>
                      <input type="text" class="edit-input" id="edit-topico" style="display: none;">
                    </div>
                    <div class="info-field">
                      <span class="info-label">Subtópico:</span>
                      <span class="info-value" id="info-subtopico">Carregando...</span>
                      <input type="text" class="edit-input" id="edit-subtopico" style="display: none;">
                    </div>
                  </div>
                  <!-- Coluna da Direita: Controles de Progresso -->
                  <div class="progress-controls" style="flex: 1; min-width: 300px; overflow-y: auto; max-height: 250px; border: 1px solid #333; border-radius: 5px; padding: 10px; background: rgba(255, 255, 255, 0.05);">
                    <div class="progress-item">
                      <div class="progress-label">
                        <i class="fas fa-book"></i>
                        <span>Estudo Concluído</span>
                      </div>
                      <div class="progress-status">
                        <label class="custom-checkbox estudo">
  <input type="checkbox" id="estudo-checkbox" onchange="updateCheckboxStatus('estudo')">
  <span class="checkmark">✓</span>
</label>
                        <input type="date" class="date-input" id="estudo-date">
                      </div>
                    </div>
                   <div class="progress-item">
  <div class="progress-label">
    <i class="fas fa-sync-alt"></i>
    <span>Quantidade de Revisões</span>
  </div>
  <div class="progress-status">
    <input type="number" id="revisao-count" min="0" value="0" class="revisao-count-input" 
           onchange="updateRevisaoStatus()" title="Número de vezes que revisou este tema">
    <input type="date" class="date-input" id="revisao-date">
  </div>
</div>
                    <div class="progress-item">
                      <div class="progress-label">
                        <i class="fas fa-question-circle"></i>
                        <span>Questões Concluídas</span>
                      </div>
                      <div class="progress-status">
                        <label class="custom-checkbox questoes">
  <input type="checkbox" id="questoes-checkbox" onchange="updateCheckboxStatus('questoes')">
  <span class="checkmark">✓</span>
</label>
                        <input type="date" class="date-input" id="questoes-date">
                      </div>
                    </div>
					<!-- NOVO BLOCO PARA FLASHCARDS -->
                <div class="progress-item">
                  <div class="progress-label">
                    <i class="fas fa-layer-group"></i>
                    <span>Flashcards Concluídos</span>
                  </div>
                  <div class="progress-status">
                    <label class="custom-checkbox flashcards">
<input type="checkbox" id="flashcards-checkbox" onchange="updateCheckboxStatus('flashcards')">
<span class="checkmark">✓</span>
</label>
                    <input type="date" class="date-input" id="flashcards-date">
                  </div>
                </div>
<!-- FIM DO NOVO BLOCO -->
                  </div>
                </div>
				<div class="progress-item" style="flex-direction: column; align-items: flex-start; margin-top: 10px; background: transparent;">
  <div class="progress-label" style="margin-bottom: 8px;">
    <i class="fas fa-brain"></i>
    <span>Nível de Dificuldade</span>
  </div>
  <div id="difficulty-controls" style="display: flex; gap: 8px; width: 100%;">
    <button class="btn-difficulty" data-level="Fácil" onclick="setDifficulty('Fácil')"><i class="fas fa-smile"></i> Fácil</button>
    <button class="btn-difficulty" data-level="Médio" onclick="setDifficulty('Médio')"><i class="fas fa-meh"></i> Médio</button>
    <button class="btn-difficulty" data-level="Difícil" onclick="setDifficulty('Difícil')"><i class="fas fa-dizzy"></i> Difícil</button>
  </div>
</div>
<!-- FIM DO NOVO BLOCO DE DIFICULDADE -->

<!-- Ações -->
<div class="topic-actions">
    <button class="btn-save" onclick="saveProgress()" id="save-progress-btn">
                    <i class="fas fa-save"></i> Salvar Progresso
                    <i class="fas fa-spinner button-spinner" style="display: none;"></i>
                  </button>
                  <button class="btn-reset" onclick="resetProgress()" id="reset-progress-btn">
                    <i class="fas fa-undo"></i> Limpar Progresso
                    <i class="fas fa-spinner button-spinner" style="display: none;"></i>
                  </button>
                  <button class="btn-edit" id="edit-topic-btn" onclick="toggleEditMode()">
                    <i class="fas fa-edit"></i> Editar Tópico
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- NOTIFICAÇÕES -->
  <div class="notification-container" id="notification-container"></div>

  <!-- MODAL DE CONFIRMAÇÃO -->
  <div class="modal-backdrop" id="confirmModal">
    <div class="modal">
      <h3>Confirmação</h3>
      <p id="confirmMessage">Tem certeza que deseja executar esta ação?</p>
      <div class="modal-buttons">
        <button class="btn-modal-cancel" onclick="closeModal(false)">Cancelar</button>
        <button class="btn-modal-confirm" onclick="closeModal(true)">Confirmar</button>
      </div>
    </div>
  </div>

  <!-- MODAL DE VISÃO GERAL -->
  <div class="modal-backdrop" id="overviewModal">
    <div class="modal" style="width: 92%; max-width: 900px; max-height: 92vh; overflow: hidden; text-align: center; position: relative;">
    <button class="btn-fechar-novo" onclick="closeOverviewModal()" style="position: absolute; top: 10px; right: 10px; z-index: 10;">X</button>
      <h3 id="overview-title" style="margin-top: 0px; margin-bottom: 10px;"><i class="fas fa-chart-bar"></i> VISÃO GERAL</h3>
      <div id="overview-content" class="overview-modal-content" style="padding-top: 0;"></div>
    </div>
  </div>

  <!-- NOVO MODAL: DADOS -->
  <div class="modal-backdrop" id="dadosModal">
    <div class="modal" style="width: 92%; max-width: 900px; max-height: 92vh; overflow: hidden; text-align: center; position: relative;">
  <button class="btn-fechar-novo" onclick="closeDadosModal()" style="position: absolute; top: 10px; right: 10px; z-index: 10;">X</button>
  <h3 id="dados-title" style="margin-top: 0px; margin-bottom: 10px;"><i class="fas fa-database"></i> DADOS DO EDITAL</h3>
      <div id="dados-content" class="overview-modal-content" style="padding-top: 0;"></div>
    </div>
  </div>
  <!-- MODAL DE ESTATÍSTICAS DAS METAS -->
  <div class="modal-backdrop" id="estatisticasModal">
    <div class="modal" style="width: 92%; max-width: 900px; max-height: 92vh; overflow: hidden; text-align: center; position: relative;">
  <button class="btn-fechar-novo" onclick="closeEstatisticasModal()" style="position: absolute; top: 10px; right: 10px; z-index: 10;">X</button>
  <h3 id="estatisticas-title" style="margin-top: 0px; margin-bottom: 10px;"><i class="fas fa-chart-line"></i> ESTATÍSTICAS DAS METAS</h3>
      <div id="estatisticas-content" class="overview-modal-content" style="padding-top: 0;"></div>
    </div>
  </div>

  <!-- NOVO MODAL: AGENDA -->
  <div class="modal-backdrop" id="agendaModal">
    <div class="modal" style="width: 95%; max-width: 1200px; max-height: 95vh; overflow: hidden;">
      
	<!-- ================================================================ -->
      <!-- INÍCIO DO NOVO CABEÇALHO ORGANIZADO (COM TIMER) -->
      <!-- ================================================================ -->
      <div class="modal-header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px;">
        
        <!-- Zona Esquerda: Título -->
        <h3 style="margin: 0; color: #F7EF8A;">
            <i class="fas fa-calendar-alt"></i> MINHA AGENDA DE ESTUDOS
        </h3>
        
        <!-- Zona Central e Direita -->
        <div style="display: flex; align-items: center; gap: 20px;">
            <!-- Abas -->
            <div class="agenda-tabs" style="margin-bottom: 0; display: inline-flex; gap: 5px;">
                <button class="agenda-tab active" onclick="switchAgendaTab('semanal')">
                    <i class="fas fa-calendar-week"></i> Semanal
                </button>
                <button class="agenda-tab" onclick="switchAgendaTab('mensal')">
                    <i class="fas fa-calendar"></i> Mensal
                </button>
                <button class="agenda-tab" onclick="switchAgendaTab('config')">
                    <i class="fas fa-cog"></i> Configurações
                </button>
            </div>
            <!-- Barra de Progresso Chico -->
            <div id="chico-progress-bar-container">
                <div class="time-allocation-label">(🕰️ C. Concursos)</div>
                <div class="time-allocation-bar">
                    <div class="bar-segment new-content-segment" id="new-content-segment" title="Tempo para Conteúdo Novo"></div>
                    <div class="bar-segment review-segment" id="review-segment" title="Tempo para Revisão"></div>
                </div>
            </div>

            <!-- >>>>> INÍCIO DO NOVO TIMER DE FOCO <<<<< -->
            <div id="focus-timer-container">
                <span id="timer-display">25:00</span>
                <div class="timer-controls">
                    <button id="timer-start-pause" onclick="startPauseTimer()"><i class="fas fa-play"></i></button>
                    <button id="timer-reset" onclick="resetTimer()"><i class="fas fa-sync-alt"></i></button>
                </div>
                <div id="pomodoro-cycles" title="Ciclos Pomodoro Concluídos"></div>
                <button class="timer-controls" id="timer-mode-toggle" onclick="toggleTimerMode()" title="Alternar para modo Cronômetro"><i class="fas fa-stopwatch"></i></button>
            </div>
            <!-- >>>>> FIM DO NOVO TIMER DE FOCO <<<<< -->

            <!-- Botão Fechar -->
            <!-- Botão Fechar -->
<button class="btn-fechar-novo" onclick="closeAgendaModal()" title="Fechar">X</button>
        </div>
      </div>
<!-- ================================================================ -->
<!-- FIM DO NOVO CABEÇALHO -->
<!-- ================================================================ -->
      
      <!-- Conteúdo das Abas -->
      <div id="agenda-content" class="agenda-content">
        <!-- Conteúdo será carregado dinamicamente -->
      </div>
    </div>
  </div>

  <!-- NOVO MODAL: METAS DO USUÁRIO -->
  <div class="modal-backdrop" id="userGoalsModal">
    <div class="modal">
      <h3><i class="fas fa-bullseye"></i> Minhas Metas e Contadores</h3>
      <div class="form-field-row">
  <div class="form-field">
    <label for="goal-Meta Diária Tópicos">Meta Diária Tópicos</label>
    <input type="number" id="goal-Meta Diária Tópicos" min="0">
  </div>
  <div class="form-field">
  <label for="goal-Meta Horas Estudo">Meta Horas Estudo</label>
  <input type="time" id="goal-Meta Horas Estudo">
</div>
  <div class="form-field">
    <label for="goal-Meta Dias Estudo">Meta Dias Estudo</label>
    <input type="number" id="goal-Meta Dias Estudo" min="0">
  </div>
  <div class="form-field">
    <label for="goal-Meta Data Conclusão">Meta Data Conclusão</label>
    <input type="date" id="goal-Meta Data Conclusão">
  </div>
</div>
      <div class="form-field-row">
        <div class="form-field">
          <label for="goal-Meta T. Páginas">Meta T. Páginas</label>
          <input type="number" id="goal-Meta T. Páginas" min="0">
        </div>
        <div class="form-field">
          <label for="goal-Meta T. Vídeo Aulas">Meta T. Vídeo Aulas</label>
          <input type="number" id="goal-Meta T. Vídeo Aulas" min="0">
        </div>
        <div class="form-field">
          <label for="goal-Meta T. Artigos">Meta T. Artigos</label>
          <input type="number" id="goal-Meta T. Artigos" min="0">
        </div>
        <div class="form-field">
          <label for="goal-Meta T. Flashcards">Meta T. Flashcards</label>
          <input type="number" id="goal-Meta T. Flashcards" min="0">
        </div>
      </div>
      <div class="form-field-row">
        <div class="form-field">
          <label for="goal-Total Material Páginas">Total Material Páginas</label>
          <input type="number" id="goal-Total Material Páginas" min="0">
        </div>
        <div class="form-field">
          <label for="goal-Total Material Vídeo Aulas">Total Material Vídeo Aulas</label>
          <input type="number" id="goal-Total Material Vídeo Aulas" min="0">
        </div>
        <div class="form-field">
          <label for="goal-Total Material Artigos">Total Material Artigos</label>
          <input type="number" id="goal-Total Material Artigos" min="0">
        </div>
        <div class="form-field">
          <label for="goal-Total Material Flashcards">Total Material Flashcards</label>
          <input type="number" id="goal-Total Material Flashcards" min="0">
        </div>
      </div>
      <div class="form-field-row">
        <div class="form-field">
          <label for="goal-Páginas Concluídas">Páginas Concluídas</label>
          <input type="number" id="goal-Páginas Concluídas" min="0">
        </div>
        <div class="form-field">
          <label for="goal-Vídeo Aulas Concluídas">Vídeo Aulas Concluídas</label>
          <input type="number" id="goal-Vídeo Aulas Concluídas" min="0">
        </div>
        <div class="form-field">
          <label for="goal-Artigos Concluídos">Artigos Concluídos</label>
          <input type="number" id="goal-Artigos Concluídos" min="0">
        </div>
        <div class="form-field">
          <label for="goal-Flashcards Concluídos">Flashcards Concluídos</label>
          <input type="number" id="goal-Flashcards Concluídos" min="0">
        </div>
      </div>
      <div class="modal-buttons">
        <button class="btn-modal-cancel" onclick="closeUserGoalsModal()">Fechar</button>
        <button class="btn-modal-confirm" onclick="saveUserGoals()" id="save-goals-btn">
          Salvar Metas
          <i class="fas fa-spinner button-spinner" style="display: none;"></i>
        </button>
      </div>
    </div>
  </div>

  <script>
    // --- CONFIGURAÇÃO ---
    let WEB_APP_URL = "https://script.google.com/macros/s/AKfycbygSW2z33jnRiVq8S_PAcucOSXkKHsLSZ6DKXYSfP4O9XdziYuHo7yGBF4iCNUv5No6sA/exec";

    // --- VARIÁVEIS GLOBAIS ---
    let allTopics = [];
    let filteredTopics = [];
    let currentTopicSequence = null;
    let isContainerExpanded = false;
    let isEditMode = false;
    let originalTopicData = {};
    let currentUserName = null;
    let currentUserGoals = {};
    let globalMetas = {};
    let agendaData = [];
	// --- VARIÁVEIS DO TIMER DE FOCO ---
let timerInterval = null;
let timerSeconds = 25 * 60; // Padrão de 25 minutos
let isTimerRunning = false;
let timerMode = 'pomodoro'; // 'pomodoro' ou 'chronometer'
let pomodoroState = 'focus'; // 'focus', 'short_break', 'long_break'
let pomodoroCycles = 0;
let pomodoroSettings = {
    focus: 25,
    short_break: 5,
    long_break: 15,
    cycles_to_long_break: 4
};

    // --- FUNÇÕES AUXILIARES ---
    function setButtonLoading(button, isLoading) {
      if (isLoading) {
        button.classList.add('loading');
      } else {
        button.classList.remove('loading');
      }
    }

    function formatarData(dataISO) {
      if (!dataISO) return '—';
      const data = new Date(dataISO);
      const dia = String(data.getDate()).padStart(2, '0');
      const mes = String(data.getMonth() + 1).padStart(2, '0');
      const ano = data.getFullYear();
      return `${dia}/${mes}/${ano}`;
    }
	
function formatarHoras(decimalHoras) {
  if (!decimalHoras || decimalHoras <= 0) return '—';
  const totalMinutos = Math.round(decimalHoras * 60);
  const horas = Math.floor(totalMinutos / 60);
  const minutos = totalMinutos % 60;
  if (minutos === 0) {
    return `${horas}h`;
  } else {
    return `${horas}h${minutos.toString().padStart(2, '0')}m`;
  }
}
    // --- INICIALIZAÇÃO ---
    document.addEventListener("DOMContentLoaded", function() {
      const loginForm = document.getElementById("login-form");
      if (loginForm) {
        loginForm.addEventListener("submit", function(e) {
          e.preventDefault();
          login();
        });
      }
      const savedUser = localStorage.getItem('currentUserName');
      if (savedUser) {
        currentUserName = savedUser;
        document.getElementById('user-name-display').textContent = savedUser;
        document.getElementById('login-container').style.display = 'none';
        document.getElementById('app-content').style.display = 'block';
        loadAllData(true);
      }
    });

    // --- SISTEMA DE LOGIN ---
    async function login() {
      const nameInput = document.getElementById('user-name');
      const errorElement = document.getElementById('login-error');
      const submitButton = document.querySelector('#login-form button[type="submit"]');
      const buttonSpinner = submitButton.querySelector('.button-spinner');
      const buttonIcon = submitButton.querySelector('.fa-sign-in-alt');
      
      if (nameInput) {
        const userName = nameInput.value.trim();
        if (!userName) {
          errorElement.textContent = 'Por favor, digite o nome do usuário.';
          errorElement.style.display = 'block';
          return;
        }
        
        // Mostrar spinner e esconder ícone
        setButtonLoading(submitButton, true);
        buttonIcon.style.display = 'none';
        buttonSpinner.style.display = 'inline-block';
        errorElement.style.display = 'none';
        
        try {
          const url = new URL(WEB_APP_URL);
          url.searchParams.append('action', 'read');
          url.searchParams.append('userEmail', userName);
          
          console.log('Tentando login para:', userName);
          console.log('URL:', url.toString());
          
          const response = await fetch(url, { redirect: 'follow' });
          
          if (!response.ok) {
            throw new Error(`Erro HTTP ${response.status}: ${response.statusText}`);
          }
          
          const result = await response.json();
          console.log('Resposta do servidor:', result);
          
          // Verificação mais flexível para usuário
          if (result.error) {
            // Se houver erro mas os dados existirem, permite o login
            if (result.data && result.data.topics) {
              console.log('Erro ignorado - dados encontrados, permitindo login');
            } else {
              throw new Error(result.error);
            }
          }
          
          // Login bem-sucedido
          currentUserName = userName;
          localStorage.setItem('currentUserName', userName);
          document.getElementById('user-name-display').textContent = userName;
          document.getElementById('login-container').style.display = 'none';
          document.getElementById('app-content').style.display = 'block';
          showNotification('Login realizado com sucesso!');
          
          // Carregar dados
          await loadAllData();
          
        } catch (error) {
          console.error("Erro detalhado no login:", error);
          
          // Mensagens de erro mais específicas
          if (error.message.includes('Failed to fetch')) {
            errorElement.textContent = 'Erro de conexão. Verifique sua internet e tente novamente.';
          } else if (error.message.includes('não encontrada') || error.message.includes('não encontrado')) {
            errorElement.textContent = 'Usuário não encontrado. Verifique o nome ou entre em contato com o administrador.';
          } else if (error.message.includes('404') || error.message.includes('500')) {
            errorElement.textContent = 'Erro no servidor. Tente novamente em alguns instantes.';
          } else {
            errorElement.textContent = `Erro: ${error.message}`;
          }
          errorElement.style.display = 'block';
          
        } finally {
          // Restaurar ícone e esconder spinner
          setButtonLoading(submitButton, false);
          buttonIcon.style.display = 'inline-block';
          buttonSpinner.style.display = 'none';
        }
      }
    }

    function logout() {
      localStorage.removeItem('currentUserName');
      currentUserName = null;
      allTopics = [];
      filteredTopics = [];
      currentUserGoals = {};
      globalMetas = {};
      agendaData = [];
      document.getElementById('login-container').style.display = 'flex';
      document.getElementById('app-content').style.display = 'none';
      document.getElementById('user-name').value = '';
      showNotification('Você saiu do sistema.', 'success');
    }

    // --- FUNÇÕES DE INTERFACE ---
    function closeTopicDetails() {
  // Esconde o painel de detalhes
  document.getElementById("topic-detail-container").style.display = 'none';
  
  // ✅ MOSTRA a lista de tópicos novamente
  document.getElementById("topics-list-container").style.display = 'block';
  
  // Remove seleção ativa de todos os tópicos
  document.querySelectorAll(".topic-item").forEach(item => {
    item.classList.remove("active");
  });
  
  // Limpa a sequência atual
  currentTopicSequence = null;
  
  // ✅ Desativa modo de edição se estiver ativo
  if (isEditMode) {
    deactivateEditMode();
  }
  
  // Feedback visual
  showNotification('Voltando à lista de tópicos', 'success');
}

    function showNotification(message, type = 'success') {
      const container = document.getElementById('notification-container');
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <div class="notification-icon ${type}">
          <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle'}"></i>
        </div>
        <div class="notification-content">
          <div class="notification-title">${type === 'success' ? 'Sucesso!' : 'Erro!'}</div>
          <div class="notification-text">${message}</div>
        </div>
        <button class="notification-close" onclick="this.parentElement.remove()">
          <i class="fas fa-times"></i>
        </button>
      `;
      container.appendChild(notification);
      setTimeout(() => {
        if (notification.parentNode) {
          notification.remove();
        }
      }, 8000); // Aumentado de 5000 para 8000 ms (8 segundos)
    }

    function showConfirm(message, callback) {
      document.getElementById('confirmMessage').textContent = message;
      document.getElementById('confirmModal').style.display = 'flex';
      window.deleteCallback = callback;
    }

    function closeModal(confirmed) {
      document.getElementById('confirmModal').style.display = 'none';
      if (window.deleteCallback) {
        window.deleteCallback(confirmed);
        window.deleteCallback = null;
      }
    }

    function showSection(sectionId) {
      const sections = [
        "topics-list-container",
        "topic-detail-container",
        "loading-message",
        "error-message"
      ];
      sections.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
      });
      if (sectionId && document.getElementById(sectionId)) {
        document.getElementById(sectionId).style.display = 'block';
      }
    }

    function updateTopicCounter() {
      const filteredCounter = document.getElementById("filtered-counter");
      if (filteredCounter) {
        filteredCounter.textContent = `${filteredTopics.length}/${allTopics.length}`;
      }
    }

    function populateDisciplineFilter() {
      const filterSelect = document.getElementById("disciplineFilter");
      if (filterSelect) {
        filterSelect.innerHTML = "<option value=\"\">Todas as Disciplinas</option>";
        const disciplines = [...new Set(allTopics.map(topic => topic.Disciplinas).filter(discipline => discipline))];
        disciplines.forEach(discipline => {
          const option = document.createElement("option");
          option.value = discipline;
          option.textContent = discipline;
          filterSelect.appendChild(option);
        });
      }
    }

    function displayTopicsList() {
      const listElement = document.getElementById("topics-list");
      if (listElement) {
        listElement.innerHTML = "";
        filteredTopics.forEach(topic => {
          const listItem = document.createElement("li");
          listItem.className = "topic-item";
          if (topic.Seq === currentTopicSequence) {
              listItem.classList.add("active");
          }
          listItem.dataset.sequence = topic.Seq;
          
          // Ícones de status - COM AS SUBSTITUIÇÕES APLICADAS
          const estudoStatus = topic['Status Estudo'] === 'Concluído';
          const revisaoStatus = topic['Revisao Count'] > 0; // ✅ SUBSTITUIÇÃO APLICADA
          const revisaoCount = topic['Revisao Count'] || 0; // ✅ SUBSTITUIÇÃO APLICADA
          const questoesStatus = topic['Status Questões'] === 'Concluído';
		  const flashcardsStatus = topic['Status Flashcards'] === 'Concluído';

// Conteúdo do tópico
// [CÓDIGO NOVO E LIMPO - COPIE E COLE ISTO]

// Conteúdo do tópico
const topicContent = `
  <div class="topic-content">
    <div class="topic-discipline">${topic.Disciplinas ? topic.Disciplinas : "Sem disciplina"}</div>
    <div class="topic-title">
      ${topic.Seq} - ${topic.Tópicos || "Sem título"}
    </div>
    ${topic.Subtópicos && topic.Subtópicos !== '—' ? `<div class="topic-subtopic">${topic.Subtópicos}</div>` : ''}
  </div>
  <div style="display: flex; align-items: center; gap: 10px;">
    
    <!-- Nova Estrutura Vertical para empilhar Rótulos e Controles -->
    <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
      
      <!-- INÍCIO DO NOVO BLOCO DE RÓTULOS -->
      <div style="display: flex; gap: 6px; font-size: 0.7rem; color: #FFF; font-weight: bold; padding-right: 12px;">
        <span style="width: 22px; text-align: center;" title="Estudo">E</span>
        <span style="min-width: 28px; text-align: center;" title="Revisões">R</span>
        <span style="width: 22px; text-align: center;" title="Questões">Q</span>
		<span style="width: 22px; text-align: center;" title="Flashcards">F</span>
      </div>
      <!-- FIM DO NOVO BLOCO DE RÓTULOS -->

      <div class="quick-controls" onclick="event.stopPropagation()">
        <div class="quick-checkbox ${estudoStatus ? 'checked-estudo' : ''}" 
             title="Estudo Concluído"
             onclick="quickToggleEstudo('${topic.Seq}', this)">
          ${estudoStatus ? '✓' : ''}
        </div>
        <div class="quick-revisao-counter ${revisaoStatus ? 'has-revisoes' : ''}" 
             title="Revisões (clique para alterar)"
             onclick="openRevisaoPopup('${topic.Seq}', ${revisaoCount})">
          ${revisaoCount}
        </div>
        <div class="quick-checkbox ${questoesStatus ? 'checked-questoes' : ''}" 
             title="Questões Concluídas"
             onclick="quickToggleQuestoes('${topic.Seq}', this)">
          ${questoesStatus ? '✓' : ''}
        </div>
		<div class="quick-checkbox ${flashcardsStatus ? 'checked-flashcards' : ''}" 
         title="Flashcards Concluídos"
         onclick="quickToggleFlashcards('${topic.Seq}', this)">
      ${flashcardsStatus ? '✓' : ''}
    </div>
      </div>
    </div>
    <!-- Fim da Nova Estrutura Vertical -->

    <i class="fas fa-pencil-alt edit-icon" title="Editar tópico"></i>
  </div>
`;
          
          listItem.innerHTML = topicContent;
          
          // Event listener para clique no tópico
          listItem.addEventListener("click", (e) => {
            // Não dispara se clicar no ícone de edição
            if (!e.target.classList.contains('edit-icon') && !e.target.closest('.edit-icon')) {
              showTopicDetails(topic.Seq);
            }
          });
          
          // Event listener para o ícone de edição
          const editIcon = listItem.querySelector('.edit-icon');
          editIcon.addEventListener("click", (e) => {
            e.stopPropagation(); // Impede que o clique no ícone dispare o showTopicDetails
            showTopicDetails(topic.Seq);
            setTimeout(() => {
              if (!isEditMode) {
                toggleEditMode();
              }
            }, 100);
          });
          
          listElement.appendChild(listItem);
        });
        updateTopicCounter();
        showSection("topics-list-container");
      }
    }

    function showTopicDetails(sequence) {
      const topic = allTopics.find(t => t.Seq == sequence);
      if (!topic) return;
      currentTopicSequence = topic.Seq;
      if (document.getElementById("topic-detail-title")) {
        let titleHtml = `<i class="fas fa-book"></i> ${topic.Disciplinas || "Sem disciplina"} - ${topic.Seq}`;
        if (topic.Subtópicos && topic.Subtópicos !== '—') {
          titleHtml += `<br><i class="fas fa-level-down-alt"></i> ${topic.Subtópicos}`;
        }
        document.getElementById("topic-detail-title").innerHTML = titleHtml;
      }
      if (document.getElementById("topic-detail-discipline")) {
        document.getElementById("topic-detail-discipline").textContent = topic.Tópicos || "Sem título";
      }
      document.getElementById('info-disc').textContent = topic.Disciplinas || '';
      document.getElementById('info-seq').textContent = topic.Seq || '';
      document.getElementById('info-topico').textContent = topic.Tópicos || '';
      document.getElementById('info-subtopico').textContent = topic.Subtópicos || '';
      updateStatusCheckboxes(topic);
      document.querySelectorAll(".topic-item").forEach(item => {
        item.classList.remove("active");
        if (item.dataset.sequence == topic.Seq) {
          item.classList.add("active");
        }
      });
	  // NOVO CÓDIGO - Adicionado para mostrar a dificuldade salva
    document.querySelectorAll('.btn-difficulty').forEach(btn => btn.classList.remove('active'));
    if (topic.Dificuldade) {
        const activeButton = document.querySelector(`.btn-difficulty[data-level="${topic.Dificuldade}"]`);
        if (activeButton) {
            activeButton.classList.add('active');
        }
    }
    // FIM DO NOVO CÓDIGO
      showSection("topic-detail-container");
    }

    function updateStatusCheckboxes(topic) {
  document.getElementById('estudo-checkbox').checked = (topic['Status Estudo'] === 'Concluído');
  document.getElementById('estudo-date').value = topic['Data Estudo'] || '';
  
  // ✅ NOVA LÓGICA PARA REVISÃO - SUBSTITUIÇÃO APLICADA
  const revisaoCount = topic['Revisao Count'] || 0;
  document.getElementById('revisao-count').value = revisaoCount;
  document.getElementById('revisao-date').value = topic['Data Revisão'] || '';
  
  document.getElementById('questoes-checkbox').checked = (topic['Status Questões'] === 'Concluído');
  document.getElementById('questoes-date').value = topic['Data Questões'] || '';
  document.getElementById('flashcards-checkbox').checked = (topic['Status Flashcards'] === 'Concluído');
document.getElementById('flashcards-date').value = topic['Data Flashcards'] || '';
}
// --- INÍCIO DA NOVA FUNÇÃO DE LÓGICA SRS ---
function getTopicsForSrsReview(deadline) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    let dueTopics = [];

    allTopics.forEach(topic => {
        if (!topic['Data Estudo']) {
            return;
        }

        const studyDate = new Date(topic['Data Estudo']);
        studyDate.setHours(0, 0, 0, 0);
        const reviewCount = parseInt(topic['Revisao Count'] || 0);
        const difficulty = topic['Dificuldade'] || 'Médio';

        const intervals = {
            'Fácil':  [2, 6, 14, 30, 60],
            'Médio':  [1, 3, 7, 15, 30],
            'Difícil': [1, 2, 4, 8, 15]
        };

        const idealIntervals = intervals[difficulty];
        if (reviewCount >= idealIntervals.length) {
            return; // Ciclo de revisões concluído
        }

        let intervalDays = idealIntervals[reviewCount];
        let idealDueDate = new Date(studyDate);
        idealDueDate.setDate(studyDate.getDate() + intervalDays);

        let finalDueDate = idealDueDate;

        // Lógica de adaptação ao prazo
        if (deadline && idealDueDate > deadline) {
            const remainingReviews = idealIntervals.length - reviewCount;
            const daysUntilDeadline = (deadline - today) / (1000 * 60 * 60 * 24);

            if (daysUntilDeadline <= 0 || remainingReviews <= 0) {
                finalDueDate = today;
            } else {
                const compressedInterval = Math.max(1, Math.floor(daysUntilDeadline / remainingReviews));
                const compressedDueDate = new Date(today);
                compressedDueDate.setDate(today.getDate() + compressedInterval);
                finalDueDate = compressedDueDate > deadline ? deadline : compressedDueDate;
            }
        }

        if (today >= finalDueDate) {
            // Adiciona a data de vencimento ao objeto do tópico para poder ordenar
            topic.dueDate = finalDueDate;
            dueTopics.push(topic);
        }
    });

    console.log(`SRS Adaptativo: Encontrados ${dueTopics.length} tópicos para revisar hoje.`);
    // Ordena por data de vencimento, os mais atrasados primeiro
    dueTopics.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
    return dueTopics;
}
// --- FIM DA NOVA FUNÇÃO DE LÓGICA SRS ---

    function filterTopics() {
      const searchTerm = document.getElementById("searchInput").value.toLowerCase();
      const disciplineFilter = document.getElementById("disciplineFilter").value;
      filteredTopics = allTopics.filter(topic => {
        const matchesSearch = 
          (topic.Tópicos && topic.Tópicos.toLowerCase().includes(searchTerm)) ||
          (topic.Disciplinas && topic.Disciplinas.toLowerCase().includes(searchTerm)) ||
          (topic.Subtópicos && topic.Subtópicos.toLowerCase().includes(searchTerm));
        const matchesDiscipline = disciplineFilter === "" || topic.Disciplinas === disciplineFilter;
        return matchesSearch && matchesDiscipline;
      });
      displayTopicsList();
    }
	function updateCheckboxStatus(type) {
  const checkbox = document.getElementById(`${type}-checkbox`);
  const dateInput = document.getElementById(`${type}-date`);
  
  if (checkbox.checked && !dateInput.value) {
    const today = new Date().toISOString().split('T')[0];
    dateInput.value = today;
  }
}

   function updateRevisaoStatus() {
  const countInput = document.getElementById('revisao-count');
  const dateInput = document.getElementById('revisao-date');
  const count = parseInt(countInput.value) || 0;
  
  if (count > 0 && !dateInput.value) {
    // Se está adicionando revisões e não tem data, preenche com hoje
    const today = new Date().toISOString().split('T')[0];
    dateInput.value = today;
  } else if (count === 0) {
    // Se zerou as revisões, limpa a data
    dateInput.value = '';
  }
}

    function closeOverviewModal() {
      document.getElementById('overviewModal').style.display = 'none';
    }

    function closeDadosModal() {
      document.getElementById('dadosModal').style.display = 'none';
    }

    // --- NOVAS FUNÇÕES COM LOADING ---
    async function showProgressOverviewWithLoading() {
      const button = document.querySelector('.top-bar button:nth-child(1)');
      setButtonLoading(button, true);
      try {
        await new Promise(resolve => setTimeout(resolve, 300)); // Simula um pequeno delay
        showProgressOverview();
      } finally {
        setButtonLoading(button, false);
      }
    }

    async function showIndividualProgressOverviewWithLoading() {
      const button = document.querySelector('.top-bar button:nth-child(2)');
      setButtonLoading(button, true);
      try {
        await new Promise(resolve => setTimeout(resolve, 300));
        showIndividualProgressOverview();
      } finally {
        setButtonLoading(button, false);
      }
    }

    async function showRaioXOverviewWithLoading() {
      const button = document.querySelector('.top-bar button:nth-child(4)');
      setButtonLoading(button, true);
      try {
        await new Promise(resolve => setTimeout(resolve, 300));
        showRaioXOverview();
      } finally {
        setButtonLoading(button, false);
      }
    }

    // --- NOVA FUNÇÃO PARA BOTÃO DADOS ---
    async function showDadosOverviewWithLoading() {
      const button = document.querySelector('.top-bar button:nth-child(5)');
      setButtonLoading(button, true);
      try {
        await new Promise(resolve => setTimeout(resolve, 300));
        showDadosOverview();
      } finally {
        setButtonLoading(button, false);
      }
    }
    // --- FUNÇÃO COM LOADING PARA ESTATÍSTICAS ---
    async function showEstatisticasMetasWithLoading() {
      const button = document.querySelector('.top-bar button:nth-child(6)');
      setButtonLoading(button, true);
      try {
        await new Promise(resolve => setTimeout(resolve, 300));
        showEstatisticasMetas();
      } finally {
        setButtonLoading(button, false);
      }
    }

    // --- FECHAR MODAL DE ESTATÍSTICAS ---
    function closeEstatisticasModal() {
      document.getElementById('estatisticasModal').style.display = 'none';
    }

    // --- EXIBIR ESTATÍSTICAS DAS METAS ---
   function showEstatisticasMetas() {
  if (!globalMetas || !currentUserGoals || allTopics.length === 0) {
    showNotification('Dados insuficientes para gerar estatísticas.', 'error');
    return;
  }

  const hoje = new Date();
  hoje.setHours(0, 0, 0, 0);
  const dataConclusaoStr = currentUserGoals['Meta Data Conclusão'];
  const dataConclusao = dataConclusaoStr ? new Date(dataConclusaoStr) : null;
  if (dataConclusao) dataConclusao.setHours(0, 0, 0, 0);

  // === DADOS BÁSICOS ===
  const totalTopics = allTopics.length;
  const topicsEstudados = allTopics.filter(t => t['Status Estudo'] === 'Concluído').length;
  const topicsRevisados = allTopics.filter(t => t['Revisao Count'] > 0).length;
  const topicsQuestoes = allTopics.filter(t => t['Status Questões'] === 'Concluído').length;

  // === DATAS DE ATIVIDADE ===
  const dataEstudoArray = allTopics
    .filter(t => t['Data Estudo'])
    .map(t => new Date(t['Data Estudo']));
  const dataRevisaoArray = allTopics
    .filter(t => t['Data Revisão'])
    .map(t => new Date(t['Data Revisão']));
  const dataQuestoesArray = allTopics
    .filter(t => t['Data Questões'])
    .map(t => new Date(t['Data Questões']));

  // Primeira e última data
  const primeiraData = dataEstudoArray.length > 0 
    ? new Date(Math.min(...dataEstudoArray.map(d => d.getTime()))) 
    : hoje;
  const ultimaData = dataEstudoArray.length > 0 
    ? new Date(Math.max(...dataEstudoArray.map(d => d.getTime()))) 
    : hoje;

  const diasTotais = Math.max(1, Math.ceil((ultimaData - primeiraData) / (1000 * 60 * 60 * 24)) + 1);
  const mediaEstudos = dataEstudoArray.length > 0 ? (dataEstudoArray.length / diasTotais).toFixed(1) : '—';
  const mediaRevisoes = dataRevisaoArray.length > 0 ? (dataRevisaoArray.length / diasTotais).toFixed(1) : '—';
  const mediaQuestoes = dataQuestoesArray.length > 0 ? (dataQuestoesArray.length / diasTotais).toFixed(1) : '—';

  // Últimos 7 dias
  const seteDiasAtras = new Date();
  seteDiasAtras.setDate(hoje.getDate() - 7);
  const estudadosSemana = dataEstudoArray.filter(d => d >= seteDiasAtras).length;
  const estudadosMes = dataEstudoArray.filter(d => 
    d.getFullYear() === hoje.getFullYear() && 
    d.getMonth() === hoje.getMonth()
  ).length;

  // Progresso Geral (Tópicos + Revisões)
  const progressoGeral = totalTopics > 0 
    ? (((topicsEstudados + topicsRevisados) / (totalTopics * 2)) * 100).toFixed(1) 
    : '0.0';

  // === PROJEÇÕES REALISTAS ===
  let diasRestantes = '—';
  let ritmoNecessarioTopicos = '—';
  let ritmoNecessarioRevisoes = '—';
  let statusMetaTopicos = '—';
  let statusMetaRevisoes = '—';

  if (dataConclusao) {
    const diffTime = dataConclusao - hoje;
    diasRestantes = Math.max(0, Math.ceil(diffTime / (1000 * 60 * 60 * 24)));
    if (diasRestantes > 0) {
      const topicosRestantes = totalTopics - topicsEstudados;
      const revisoesRestantes = totalTopics - topicsRevisados;
      ritmoNecessarioTopicos = (topicosRestantes / diasRestantes).toFixed(1);
      ritmoNecessarioRevisoes = (revisoesRestantes / diasRestantes).toFixed(1);
      statusMetaTopicos = parseFloat(ritmoNecessarioTopicos) > (currentUserGoals['Meta Diária Tópicos'] || 0) 
        ? 'PRECISA ACELERAR' : 'NO RITMO';
      statusMetaRevisoes = parseFloat(ritmoNecessarioRevisoes) > (currentUserGoals['Meta Diária Tópicos'] || 0) 
        ? 'PRECISA ACELERAR' : 'NO RITMO';
    }
  }

  // === COMPARATIVO HOJE ===
  const hojeStr = hoje.toISOString().split('T')[0];
  const topicosHoje = allTopics.filter(t => t['Data Estudo'] === hojeStr).length;
  const revisoesHoje = allTopics.filter(t => t['Data Revisão'] === hojeStr).length;
  const questoesHoje = allTopics.filter(t => t['Data Questões'] === hojeStr).length;

  const metaDiariaTopicos = currentUserGoals['Meta Diária Tópicos'] || 0;
  const metaDiariaRevisoes = currentUserGoals['Meta Diária Tópicos'] || 0; // assumindo mesma meta
  const metaDiariaQuestoes = 0; // não definida
  const metaDiariaFlashcards = 0;

  // === PROGRESSO MATERIAIS HOJE ===
  const paginasHoje = 0; // não rastreado por dia
  const videosHoje = 0;
  const artigosHoje = 0;

  // === RECOMENDAÇÕES ===
  let alerta = '✅ Ótimo ritmo! Continue assim.';
  if (topicsEstudados === 0) {
    alerta = '⚠️ ALERTA: Você ainda não estudou nenhum tópico. Comece hoje!';
  } else if ((topicsEstudados / totalTopics) < 0.1) {
    alerta = '⚠️ ALERTA: Progresso muito lento. Aumente seu ritmo diário.';
  } else if ((topicsEstudados / totalTopics) > 0.9) {
    alerta = '🎉 Parabéns! Você está quase concluindo o edital. Foque nas revisões.';
  }

  // === PLANEJAMENTO SUGERIDO ===
  const disciplinas = [...new Set(allTopics.map(t => t.Disciplinas).filter(d => d))];
  const distribuicaoDisciplinas = {};
  disciplinas.forEach(disc => {
    const total = allTopics.filter(t => t.Disciplinas === disc).length;
    const restantes = total - allTopics.filter(t => t.Disciplinas === disc && t['Status Estudo'] === 'Concluído').length;
    distribuicaoDisciplinas[disc] = diasRestantes > 0 ? (restantes / diasRestantes).toFixed(1) : '0.0';
  });

  // === SELETOR DE DISCIPLINAS PARA REVISÕES ===
  let selectorHTML = `
    <div style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
      <select id="disciplinaRevisaoSelector" onchange="atualizarBarrasRevisao()" style="padding: 6px 10px; border: 1px solid #555; border-radius: 50px; background: #222; color: #fff; font-size: 0.85rem; min-width: 180px;">
        <option value="">Selecione uma disciplina</option>
  `;
  disciplinas.forEach(disc => {
    selectorHTML += `<option value="${disc}">${disc}</option>`;
  });
  selectorHTML += `</select></div>`;

  let barrasRevisaoHTML = '<div id="barras-revisao-container" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;"></div>';

  // === MONTAGEM DO CONTEÚDO COMPLETO ===
  let content = `
    <!-- 📊 ESTATÍSTICAS GERAIS -->
    <div class="overview-chart">
      <div class="chart-title">📊 ESTATÍSTICAS GERAIS</div>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-top: 10px;">
        <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px; text-align: center;">
          <div style="font-size: 0.9rem; color: #fff;">Total de Tópicos</div>
          <div style="font-size: 1.8rem; font-weight: bold; color: #F7EF8A;">${totalTopics}</div>
        </div>
        <div style="background: rgba(76, 175, 80, 0.15); padding: 12px; border-radius: 8px; text-align: center;">
          <div style="font-size: 0.9rem; color: #fff;">Estudo Concluído</div>
<div style="font-size: 1.8rem; font-weight: bold; color: #4CAF50;">${Math.round((topicsEstudados / totalTopics) * 100)}%</div>
<div style="font-size: 0.9rem; color: #fff;">${topicsEstudados}/${totalTopics}</div>
        </div>
        <div style="background: rgba(255, 193, 7, 0.15); padding: 12px; border-radius: 8px; text-align: center;">
          <div style="font-size: 0.9rem; color: #fff;">Revisão Concluída</div>
          <div style="font-size: 1.8rem; font-weight: bold; color: #FFC107;">${Math.round((topicsRevisados / totalTopics) * 100)}%</div>
          <div style="font-size: 0.9rem; color: #fff;">${topicsRevisados}/${totalTopics}</div>
        </div>
        <div style="background: rgba(33, 150, 243, 0.15); padding: 12px; border-radius: 8px; text-align: center;">
          <div style="font-size: 0.9rem; color: #fff;">Questões Concluídas</div>
          <div style="font-size: 1.8rem; font-weight: bold; color: #2196F3;">${Math.round((topicsQuestoes / totalTopics) * 100)}%</div>
          <div style="font-size: 0.9rem; color: #eee;">${topicsQuestoes}/${totalTopics}</div>
        </div>
        <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px; text-align: center;">
          <div style="font-size: 0.9rem; color: #fff;">Média de Estudos</div>
          <div style="font-size: 1.6rem; font-weight: bold; color: #F7EF8A;">${mediaEstudos}</div>
          <div style="font-size: 0.8rem; color: #fff;">tópicos/dia</div>
        </div>
        <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px; text-align: center;">
          <div style="font-size: 0.9rem; color: #fff;">Média de Revisões</div>
          <div style="font-size: 1.6rem; font-weight: bold; color: #F7EF8A;">${mediaRevisoes}</div>
          <div style="font-size: 0.8rem; color: #fff;">revisões/dia</div>
        </div>
        <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px; text-align: center;">
          <div style="font-size: 0.9rem; color: #fff;">Média de Questões</div>
          <div style="font-size: 1.6rem; font-weight: bold; color: #F7EF8A;">${mediaQuestoes}</div>
          <div style="font-size: 0.8rem; color: #fff;">questões/dia</div>
        </div>
        <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px; text-align: center;">
          <div style="font-size: 0.9rem; color: #fff;">Tópicos +2 Revisões</div>
          <div style="font-size: 1.6rem; font-weight: bold; color: #F7EF8A;">${allTopics.filter(t => t['Revisao Count'] >= 2).length}</div>
          <div style="font-size: 0.8rem; color: #fff;">${totalTopics > 0 ? Math.round((allTopics.filter(t => t['Revisao Count'] >= 2).length / totalTopics) * 100) : 0}% do total</div>
        </div>
        <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px; text-align: center;">
          <div style="font-size: 0.9rem; color: #fff;">Estudados na Semana</div>
          <div style="font-size: 1.6rem; font-weight: bold; color: #F7EF8A;">${estudadosSemana}</div>
          <div style="font-size: 0.8rem; color: #fff;">últimos 7 dias</div>
        </div>
        <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px; text-align: center;">
          <div style="font-size: 0.9rem; color: #fff;">Estudados no mês (${hoje.toLocaleString('pt-BR', { month: 'short' })})</div>
          <div style="font-size: 1.6rem; font-weight: bold; color: #F7EF8A;">${estudadosMes}</div>
        </div>
        <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px; text-align: center;">
          <div style="font-size: 0.9rem; color: #fff;">Horas estudadas na Semana</div>
          <div style="font-size: 1.6rem; font-weight: bold; color: #F7EF8A;">${formatarHoras(currentUserGoals['Meta Horas Estudo'])}</div>
        </div>
        <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px; text-align: center;">
          <div style="font-size: 0.9rem; color: #fff;">Horas estudadas no mês</div>
          <div style="font-size: 1.6rem; font-weight: bold; color: #F7EF8A;">${formatarHoras(currentUserGoals['Meta Horas Estudo'])}</div>
        </div>
        <div style="background: rgba(106, 27, 154, 0.2); padding: 12px; border-radius: 8px; text-align: center; grid-column: span 2;">
          <div style="font-size: 0.9rem; color: #fff;">Progresso Geral (Tópicos + Revisões)</div>
          <div style="font-size: 1.8rem; font-weight: bold; color: #AE8625;">${progressoGeral}%</div>
        </div>
      </div>
    </div>
    <!-- 📊 COMPARAÇÃO PERÍODO -->
    <div class="overview-chart">
      <div class="chart-title">📊 COMPARAÇÃO PERÍODO</div>
      <div style="display: flex; justify-content: center; margin-bottom: 10px;">
        <select id="periodo-comparacao" onchange="atualizarComparacaoPeriodo()" style="padding: 6px 10px; border: 1px solid #555; border-radius: 50px; background: #222; color: #fff; font-size: 0.85rem; min-width: 180px;">
          <option value="semana">Esta semana</option>
          <option value="mes">Mês atual</option>
        </select>
      </div>
      <div id="comparacao-periodo-content" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;"></div>
    </div>
    <!-- 📊 COMPARATIVO META vs REALIZADO NO DIA -->
    <div class="overview-chart">
      <div class="chart-title">📊 COMPARATIVO META vs REALIZADO NO DIA</div>
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 10px;">
        <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px;">
          <div style="font-weight: bold; color: #F7EF8A; font-size: 1.1rem;">Tópicos Estudados</div>
          <div style="margin-top: 8px; display: flex; justify-content: space-between;">
            <span style="color: #fff;">Meta do Dia</span>
            <span style="color: #F7EF8A;">${metaDiariaTopicos}</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span style="color: #fff;">Realizado no Dia</span>
            <span style="color: #4CAF50;">${topicosHoje}</span>
          </div>
        </div>
        <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px;">
          <div style="font-weight: bold; color: #F7EF8A; font-size: 1.1rem;">Revisões</div>
          <div style="margin-top: 8px; display: flex; justify-content: space-between;">
            <span style="color: #fff;">Meta do Dia</span>
            <span style="color: #F7EF8A;">${metaDiariaRevisoes}</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span style="color: #fff;">Realizado no Dia</span>
            <span style="color: #FFC107;">${revisoesHoje}</span>
          </div>
        </div>
        <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px;">
          <div style="font-weight: bold; color: #F7EF8A; font-size: 1.1rem;">Questões</div>
          <div style="margin-top: 8px; display: flex; justify-content: space-between;">
            <span style="color: #fff;">Meta do Dia</span>
            <span style="color: #F7EF8A;">${metaDiariaQuestoes}</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span style="color: #fff;">Realizado no Dia</span>
            <span style="color: #2196F3;">${questoesHoje}</span>
          </div>
        </div>
        <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px;">
          <div style="font-weight: bold; color: #F7EF8A; font-size: 1.1rem;">Flashcards</div>
          <div style="margin-top: 8px; display: flex; justify-content: space-between;">
            <span style="color: #fff;">Meta do Dia</span>
            <span style="color: #F7EF8A;">${metaDiariaFlashcards}</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span style="color: #fff;">Realizado no Dia</span>
            <span style="color: #9C27B0;">0</span>
          </div>
        </div>
      </div>
    </div>

    <!-- 📚 PROGRESSO EM MATERIAIS (HOJE) -->
    <div class="overview-chart">
      <div class="chart-title">📚 PROGRESSO EM MATERIAIS (HOJE)</div>
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 10px;">
        <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px;">
          <div style="font-weight: bold; color: #F7EF8A; font-size: 1.1rem;">Material Páginas</div>
          <div style="margin-top: 8px; display: flex; justify-content: space-between;">
            <span style="color: #fff;">Meta do Dia</span>
            <span style="color: #F7EF8A;">${currentUserGoals['Meta T. Páginas'] || 0}</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span style="color: #fff;">Realizado no Dia</span>
            <span style="color: #42A5F5;">${paginasHoje}</span>
          </div>
        </div>
        <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px;">
          <div style="font-weight: bold; color: #F7EF8A; font-size: 1.1rem;">Vídeo Aulas</div>
          <div style="margin-top: 8px; display: flex; justify-content: space-between;">
            <span style="color: #fff;">Meta do Dia</span>
            <span style="color: #F7EF8A;">${currentUserGoals['Meta T. Vídeo Aulas'] || 0}</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span style="color: #fff;">Realizado no Dia</span>
            <span style="color: #9C27B0;">${videosHoje}</span>
          </div>
        </div>
        <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px;">
          <div style="font-weight: bold; color: #F7EF8A; font-size: 1.1rem;">Artigos</div>
          <div style="margin-top: 8px; display: flex; justify-content: space-between;">
            <span style="color: #fff;">Meta do Dia</span>
            <span style="color: #F7EF8A;">${currentUserGoals['Meta T. Artigos'] || 0}</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
           <span style="color: #fff;">Realizado no Dia</span>
            <span style="color: #FF9800;">${artigosHoje}</span>
          </div>
        </div>
      </div>
    </div>

   <!-- 🎯 PROJEÇÕES REALISTAS -->
<div class="overview-chart">
  <div class="chart-title">🎯 PROJEÇÕES REALISTAS SOBRE AS MINHAS METAS</div>
  <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 10px;">
    <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px; color: #fff;">
      <div style="font-weight: bold; color: #F7EF8A; margin-bottom: 6px;">Indicador</div>
      <div style="font-size: 0.95rem; line-height: 1.6;">
        <div><span style="color: #F7EF8A;">Tópicos Restantes:</span> <span style="color: #fff;">${totalTopics - topicsEstudados}</span></div>
        <div><span style="color: #F7EF8A;">Revisões Restantes:</span> <span style="color: #fff;">${totalTopics - topicsRevisados}</span></div>
        <div><span style="color: #F7EF8A;">Dias Restantes:</span> <span style="color: #fff;">${diasRestantes}</span></div>
        <div><span style="color: #F7EF8A;">Ritmo Necessário (Tópicos):</span> <span style="color: #fff;">${ritmoNecessarioTopicos} tópicos/dia</span></div>
        <div><span style="color: #F7EF8A;">Ritmo Necessário (Revisões):</span> <span style="color: #fff;">${ritmoNecessarioRevisoes} revisões/dia</span></div>
      </div>
    </div>
    <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px; color: #fff;">
      <div style="font-weight: bold; color: #F7EF8A; margin-bottom: 6px;">Status da Meta</div>
      <div style="font-size: 0.95rem; line-height: 1.6;">
        <div><span style="color: #F7EF8A;">Tópicos:</span> <span style="color: ${statusMetaTopicos === 'NO RITMO' ? '#008000' : '#F44336'};">${statusMetaTopicos}</span></div>
        <div><span style="color: #F7EF8A;">Revisões:</span> <span style="color: ${statusMetaRevisoes === 'NO RITMO' ? '#008000' : '#F44336'};">${statusMetaRevisoes}</span></div>
    </div>
  </div>
</div>

    <!-- 💡 RECOMENDAÇÕES -->
    <div class="overview-chart">
      <div class="chart-title">💡 RECOMENDAÇÕES</div>
      <div style="background: rgba(255, 193, 7, 0.1); border-left: 4px solid #FFC107; padding: 12px; border-radius: 4px; margin-top: 10px; color: #fff;">
        <div style="font-weight: bold; margin-bottom: 6px;">${alerta}</div>
        <div>🎯 Foco Principal: Concluir tópicos pendentes</div>
        <div>📅 Próxima Meta: ${metaDiariaTopicos} tópicos hoje</div>
      </div>
    </div>

    <!-- 📅 PLANEJAMENTO SUGERIDO -->
<div class="overview-chart">
  <div class="chart-title">📅 PLANEJAMENTO SUGERIDO</div>
  <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px; margin-top: 10px; font-size: 0.95rem; line-height: 1.6; color: #fff;">
    <div style="text-align: center; margin-top: 8px; font-weight: bold; color: #Fff100;">Metas definidas pelo aluno</div>
	<div>• <span style="color: #F7EF8A;">Meta Diária:</span> <span style="color: #fff;">${metaDiariaTopicos} tópicos</span></div>
    <div>• <span style="color: #F7EF8A;">Revisão Diária:</span> <span style="color: #fff;">${metaDiariaRevisoes} tópicos</span></div>
    <div>• <span style="color: #F7EF8A;">Questões Diárias:</span> <span style="color: #fff;">${metaDiariaQuestoes}</span></div>
    <div>• <span style="color: #F7EF8A;">Previsão de Conclusão:</span> <span style="color: #fff;">${dataConclusao ? formatarData(dataConclusao.toISOString()) : '—'}</span></div>
      <div style="text-align: center; margin-top: 8px; font-weight: bold; color: #Fff100;">Distribuição Recomendada por Disciplina:</div>
    ${Object.entries(distribuicaoDisciplinas).map(([disc, valor]) => 
      `<div>• <span style="color: #F7EF8A;">${disc}:</span> <span style="color: #fff;">${valor} tópicos/dia</span></div>`
    ).join('')}
	<div style="text-align: center; margin-top: 8px; font-weight: bold; color: #Fff100;">Distribuição Proporcional por Disciplina (baseada na quantidade de tópicos):</div>
    ${disciplinas.map(disc => {
      const totalDisc = allTopics.filter(t => t.Disciplinas === disc).length;
      const proporcao = totalTopics > 0 ? ((totalDisc / totalTopics) * 100).toFixed(1) : '0.0';
      const metaProporcional = metaDiariaTopicos > 0 ? (metaDiariaTopicos * totalDisc / totalTopics).toFixed(1) : '0.0';
      return `<div>• <span style="color: #F7EF8A;">${disc}:</span> <span style="color: #fff;">${metaProporcional} tópicos/dia (${proporcao}% do edital)</span></div>`;
    }).join('')}
  </div>
</div>

    <!-- 📚 PROGRESSO POR DISCIPLINA REVISÕES -->
    <div class="overview-chart">
      <div class="chart-title">📚 PROGRESSO POR DISCIPLINA REVISÕES</div>
      ${selectorHTML}
      ${barrasRevisaoHTML}
    </div>
  `;

  document.getElementById('estatisticas-content').innerHTML = content;
  document.getElementById('estatisticasModal').style.display = 'flex';

  // Adicionar função de atualização das barras
  window.atualizarBarrasRevisao = function() {
    const disciplina = document.getElementById('disciplinaRevisaoSelector').value;
    const container = document.getElementById('barras-revisao-container');
    if (!disciplina) {
      container.innerHTML = '';
      return;
    }
    const topicosDisciplina = allTopics.filter(t => t.Disciplinas === disciplina);
    let barras = '';
    topicosDisciplina.forEach(topico => {
      const revisoes = topico['Revisao Count'] || 0;
      const altura = Math.min(100, revisoes * 20); // até 5 revisões = 100px
      barras += `
  <div style="width: 40px; display: flex; flex-direction: column; align-items: center;" 
       title="${topico.Tópicos || 'Tópico'}${topico.Subtópicos && topico.Subtópicos !== '—' ? ' - ' + topico.Subtópicos : ''}">
    <div style="width: 100%; background: #333; border-radius: 4px; height: 100px; display: flex; align-items: flex-end; justify-content: center; position: relative;">
      <div style="width: 100%; background: #FFC107; height: ${altura}px; border-radius: 4px 4px 0 0; display: flex; align-items: flex-end; justify-content: center;">
        <span style="color: #000; font-weight: bold; font-size: 0.7rem;">${revisoes}</span>
      </div>
    </div>
    <div style="font-size: 0.7rem; color: #aaa; margin-top: 4px; text-align: center;">${topico.Seq}</div>
  </div>
`;
    });
    container.innerHTML = barras;
  };
    // Adicionar função de atualização da comparação
  window.atualizarComparacaoPeriodo = function() {
    const tipo = document.getElementById('periodo-comparacao').value;
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);

    let inicioAtual, fimAtual, inicioAnterior, fimAnterior, labelAtual, labelAnterior;

    if (tipo === 'semana') {
      // Esta semana (domingo a sábado)
      const domingoAtual = new Date(hoje);
      domingoAtual.setDate(hoje.getDate() - hoje.getDay());
      inicioAtual = domingoAtual;
      fimAtual = new Date(domingoAtual);
      fimAtual.setDate(domingoAtual.getDate() + 6);

      // Semana passada
      inicioAnterior = new Date(domingoAtual);
      inicioAnterior.setDate(domingoAtual.getDate() - 7);
      fimAnterior = new Date(inicioAnterior);
      fimAnterior.setDate(inicioAnterior.getDate() + 6);

      labelAtual = 'Esta semana';
      labelAnterior = 'Semana passada';
    } else {
      // Mês atual
      inicioAtual = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
      fimAtual = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);

      // Mês passado
      inicioAnterior = new Date(hoje.getFullYear(), hoje.getMonth() - 1, 1);
      fimAnterior = new Date(hoje.getFullYear(), hoje.getMonth(), 0);

      labelAtual = 'Mês atual';
      labelAnterior = 'Mês passado';
    }

    // Função para contar atividades em um intervalo
    const contarAtividades = (dataArray, inicio, fim) => {
      return dataArray.filter(d => d >= inicio && d <= fim).length;
    };

    const topicosAtual = contarAtividades(dataEstudoArray, inicioAtual, fimAtual);
    const topicosAnterior = contarAtividades(dataEstudoArray, inicioAnterior, fimAnterior);
    const revisoesAtual = contarAtividades(dataRevisaoArray, inicioAtual, fimAtual);
    const revisoesAnterior = contarAtividades(dataRevisaoArray, inicioAnterior, fimAnterior);
    const questoesAtual = contarAtividades(dataQuestoesArray, inicioAtual, fimAtual);
    const questoesAnterior = contarAtividades(dataQuestoesArray, inicioAnterior, fimAnterior);

    const setaTopicos = topicosAtual > topicosAnterior ? '↑' : (topicosAtual < topicosAnterior ? '↓' : '→');
    const corTopicos = topicosAtual > topicosAnterior ? '#4CAF50' : (topicosAtual < topicosAnterior ? '#F44336' : '#FFC107');

    const setaRevisoes = revisoesAtual > revisoesAnterior ? '↑' : (revisoesAtual < revisoesAnterior ? '↓' : '→');
    const corRevisoes = revisoesAtual > revisoesAnterior ? '#4CAF50' : (revisoesAtual < revisoesAnterior ? '#F44336' : '#FFC107');

    const setaQuestoes = questoesAtual > questoesAnterior ? '↑' : (questoesAtual < questoesAnterior ? '↓' : '→');
    const corQuestoes = questoesAtual > questoesAnterior ? '#4CAF50' : (questoesAtual < questoesAnterior ? '#F44336' : '#FFC107');

    const comparacaoHTML = `
      <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px; text-align: center;">
        <div style="font-weight: bold; color: #F7EF8A; font-size: 1.1rem;">Tópicos Estudados</div>
        <div style="font-size: 1.6rem; font-weight: bold; color: ${corTopicos}; margin: 8px 0;">${topicosAtual} ${setaTopicos}</div>
        <div style="font-size: 0.85rem; color: #aaa;">${labelAnterior}: ${topicosAnterior}</div>
      </div>
      <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px; text-align: center;">
        <div style="font-weight: bold; color: #F7EF8A; font-size: 1.1rem;">Revisões</div>
        <div style="font-size: 1.6rem; font-weight: bold; color: ${corRevisoes}; margin: 8px 0;">${revisoesAtual} ${setaRevisoes}</div>
        <div style="font-size: 0.85rem; color: #aaa;">${labelAnterior}: ${revisoesAnterior}</div>
      </div>
      <div style="background: rgba(255,255,255,0.08); padding: 12px; border-radius: 8px; text-align: center;">
        <div style="font-weight: bold; color: #F7EF8A; font-size: 1.1rem;">Questões</div>
        <div style="font-size: 1.6rem; font-weight: bold; color: ${corQuestoes}; margin: 8px 0;">${questoesAtual} ${setaQuestoes}</div>
        <div style="font-size: 0.85rem; color: #aaa;">${labelAnterior}: ${questoesAnterior}</div>
      </div>
    `;
    document.getElementById('comparacao-periodo-content').innerHTML = comparacaoHTML;
  };

  // Chamar uma vez ao abrir
  setTimeout(() => {
    if (typeof window.atualizarComparacaoPeriodo === 'function') {
      window.atualizarComparacaoPeriodo();
    }
  }, 100);
}

    // --- NOVAS FUNÇÕES DE DADOS ---
       async function loadAllData(showOverview = false) {
      try {
        showSection("loading-message");
        await loadTopics(); // Carrega tópicos e userGoals (garante currentUserGoals está preenchido)
        await loadGlobalMetas(); // Carrega globalMetas
        
        showSection("topics-list-container");
        populateDisciplineFilter(); // Garante que o filtro de disciplina esteja preenchido
        displayTopicsList(); // Redesenha a lista de tópicos
        updateTopicCounter();

        // REMOVIDO: loadConfig() não deve ser chamada aqui. Ela é chamada por initializeConfigView()
        // quando o modal de configurações da agenda é realmente aberto.
        // FIM REMOVIDO

        if (showOverview) {
          showProgressOverview();
        }
      } catch (error) {
        console.error("Erro ao carregar todos os dados:", error);
        showNotification(`Falha ao carregar dados: ${error.message}`, 'error');
      }
    }

    async function loadTopics() {
      if (!currentUserName) {
        showNotification('Usuário não autenticado.', 'error');
        return;
      }
      try {
        const url = new URL(WEB_APP_URL);
        url.searchParams.append('action', 'read');
        url.searchParams.append('userEmail', currentUserName);
        const response = await fetch(url, { redirect: 'follow' });
        if (!response.ok) throw new Error(`Erro ${response.status}`);
        const result = await response.json();
        if (result.success === false || result.error) {
          throw new Error(result.error || 'Erro desconhecido do servidor');
        }
        if (!result.data || !Array.isArray(result.data.topics)) {
          throw new Error('Resposta do servidor inválida: dados ausentes ou malformados');
        }
        allTopics = result.data.topics;
        currentUserGoals = result.data.userGoals || {};
        filteredTopics = [...allTopics];
        populateDisciplineFilter();
        displayTopicsList();
        updateTopicCounter();
      } catch (error) {
        console.error("Erro ao carregar tópicos:", error);
        throw error;
      }
    }

    async function loadGlobalMetas() {
      try {
        const url = new URL(WEB_APP_URL);
        url.searchParams.append('action', 'readOverviewMetrics');
        const response = await fetch(url, { redirect: 'follow' });
        if (!response.ok) throw new Error(`Erro ${response.status}`);
        const result = await response.json();
        if (result.success === false || result.error) {
          throw new Error(result.error || 'Erro ao carregar métricas globais');
        }
        globalMetas = result.data || {};
      } catch (error) {
        console.error("Erro ao carregar métricas globais:", error);
        throw error;
      }
    }

    // --- NOVAS FUNÇÕES DE UI ---
    function openUserGoalsModal() {
  const modal = document.getElementById('userGoalsModal');
const fields = [
  'Meta Diária Tópicos', 'Meta Horas Estudo', 'Meta Dias Estudo', 'Meta Data Conclusão',
    'Meta T. Páginas', 'Meta T. Vídeo Aulas', 'Meta T. Artigos', 'Meta T. Flashcards',
    'Total Material Páginas', 'Total Material Vídeo Aulas', 'Total Material Artigos', 'Total Material Flashcards',
    'Páginas Concluídas', 'Vídeo Aulas Concluídas', 'Artigos Concluídos', 'Flashcards Concluídos'
  ];
  
  fields.forEach(key => {
    const input = document.getElementById(`goal-${key}`);
    if (input) {
      const value = currentUserGoals[key];
      
      // CORREÇÃO ESPECÍFICA APENAS PARA O CAMPO DE DATA
      if (key === 'Meta Data Conclusão' && value) {
        // Garante que a data esteja no formato correto para o input type="date"
        const date = new Date(value);
        if (!isNaN(date.getTime())) {
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          input.value = `${year}-${month}-${day}`;
        } else {
          input.value = value; // Fallback
        }
      } else {
        // Para todos os outros campos, mantém a lógica original
        if (input.type === 'date') {
          input.value = value || '';
        } 
		// CORREÇÃO ESPECÍFICA PARA META HORAS ESTUDO (type="time")
if (key === 'Meta Horas Estudo' && value) {
  if (typeof value === 'number') {
    const hours = Math.floor(value);
    const minutes = Math.round((value - hours) * 60);
    input.value = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
  } else {
    input.value = value;
  }
} else {
          input.value = value !== undefined && value !== '' ? value : '';
        }
      }
    }
  });
  
  modal.style.display = 'flex';
}

    function closeUserGoalsModal() {
      document.getElementById('userGoalsModal').style.display = 'none';
    }

    // --- FUNÇÃO SALVAR METAS OTIMIZADA ---
    async function saveUserGoals() {
      const saveBtn = document.getElementById('save-goals-btn');
      setButtonLoading(saveBtn, true);
      
      const fields = [
        'Meta Diária Tópicos', 'Meta Horas Estudo', 'Meta Dias Estudo', 'Meta Data Conclusão',
        'Meta T. Páginas', 'Meta T. Vídeo Aulas', 'Meta T. Artigos', 'Meta T. Flashcards',
        'Total Material Páginas', 'Total Material Vídeo Aulas', 'Total Material Artigos', 'Total Material Flashcards',
        'Páginas Concluídas', 'Vídeo Aulas Concluídas', 'Artigos Concluídos', 'Flashcards Concluídos'
      ];
      
      const goalsToSave = {};
      let hasError = false;

      // 1. Coleta e valida todos os dados primeiro, sem enviar nada.
      for (const key of fields) {
        const input = document.getElementById(`goal-${key}`);
        let value = input.value.trim();
        
        // Pular campos vazios, mas manter os preenchidos, mesmo que com '0'
        if (value === '') {
          continue;
        }
        
        if (input.type === 'number') {
          if (isNaN(value)) {
            showNotification(`Valor inválido para ${key}. Apenas números são permitidos.`, 'error');
            hasError = true;
            break;
          }
          value = parseFloat(value);
        }

        if (input.type === 'time' && value) {
          const [hours, minutes] = value.split(':').map(Number);
          value = hours + (minutes / 60);
        }

        goalsToSave[key] = value;
      }

      if (hasError) {
        setButtonLoading(saveBtn, false);
        return;
      }

      // 2. Se não houver nada para salvar, avisa o usuário.
      if (Object.keys(goalsToSave).length === 0) {
        setButtonLoading(saveBtn, false);
        showNotification('Nenhum campo preenchido para salvar.');
        return;
      }

      // 3. Envia todas as metas de uma só vez.
      try {
        const url = new URL(WEB_APP_URL);
        const params = new URLSearchParams();
        params.append("action", "updateUserGoals");
        params.append("userEmail", currentUserName);
        // A chave 'goalKey' não é mais usada, enviamos tudo em 'goalValue' como um JSON
        params.append("goalValue", JSON.stringify(goalsToSave));

        const response = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: params,
          redirect: 'follow'
        });

        const result = await response.json();
        if (result.error) {
          throw new Error(result.error);
        }
        
        // Animação de sucesso
        saveBtn.innerHTML = '<i class="fas fa-check"></i> Salvo!';
        saveBtn.style.background = 'linear-gradient(135deg, #4CAF50, #66BB6A, #2E7D32)';
        saveBtn.classList.add('pulse-animation');
        showNotification(`Metas atualizadas com sucesso!`);

        setTimeout(() => {
          closeUserGoalsModal();
          setTimeout(() => {
            saveBtn.innerHTML = 'Salvar Metas';
            saveBtn.style.background = '';
            saveBtn.classList.remove('pulse-animation');
          }, 500);
        }, 1500);

        loadAllData(); // Recarrega os dados para refletir as mudanças

      } catch (error) {
        console.error("Erro ao salvar metas:", error);
        showNotification(`Erro ao salvar: ${error.message}`, 'error');
      } finally {
        setButtonLoading(saveBtn, false);
      }
    }
 // NOVA FUNÇÃO: Para salvar um campo específico das metas do usuário
    async function saveUserGoalSpecificField(key, value) {
        if (!currentUserName) {
            console.warn('Usuário não autenticado. Não é possível salvar meta.');
            return;
        }
        try {
            const url = new URL(WEB_APP_URL);
            const params = new URLSearchParams();
            params.append("action", "updateUserGoals");
            params.append("userEmail", currentUserName);
            params.append("goalKey", key);
            params.append("goalValue", value);
            
            const response = await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: params,
                redirect: 'follow'
            });
            
            const result = await response.json();
            if (result.error) {
                throw new Error(result.error);
            }
            // Atualizar o currentUserGoals localmente após sucesso
            currentUserGoals[key] = value;
            console.log(`Meta "${key}" atualizada com sucesso para "${value}".`);

        } catch (error) {
            console.error(`Erro ao salvar meta "${key}":`, error);
            showNotification(`Erro ao sincronizar meta "${key}": ${error.message}`, 'error');
        }
    }
    // FIM NOVA FUNÇÃO
	
	// NOVA FUNÇÃO: Determina a meta diária de tópicos/unidades de estudo
    function getDailyStudyTarget(baseAgendaConfig, topicosDiaConfig, diasSemanaConfig) {
        let dailyTarget = 0;

        // Calcula Médias Diárias Personalizadas (se baseAgendaConfig precisar)
        let mediasPersonalizadas = {};
        if (baseAgendaConfig === 'medias-personalizadas' || baseAgendaConfig === 'medias-recomendadas') {
            mediasPersonalizadas = calcularMediasPersonalizadas(); // Função já existente no HTML
        }

        switch (baseAgendaConfig) {
            case 'meta-diaria-topicos':
                dailyTarget = topicosDiaConfig;
                break;
            case 'medias-recomendadas':
                // Do Raio X: Tópicos: (Total Temas Edital / Dias p Prova) por dia
                const diasParaProva = globalMetas['Dias_p_Prova']?.value || 0;
                const totalTemasEdital = globalMetas['Total_Temas_Edital']?.value || 0;
                if (diasParaProva > 0 && totalTemasEdital > 0) {
                    dailyTarget = parseFloat((totalTemasEdital / diasParaProva).toFixed(1));
                }
                break;
            case 'medias-personalizadas':
                // Do Raio X: Tópicos restantes: (temasRestantes / diasParaProva) por dia
                dailyTarget = parseFloat(mediasPersonalizadas.mediaTemasPersonalizada || '0');
                break;
            default:
                dailyTarget = topicosDiaConfig; // Fallback para a meta do usuário
        }

        // Ajusta o dailyTarget para ser pelo menos 1, se for 0 e houver dias de estudo
        if (dailyTarget === 0 && diasSemanaConfig > 0) {
            // Se a meta for 0 mas o usuário tem dias de estudo, sugerir pelo menos 1 tópico/dia
            // Isso evita agendas vazias por erro de configuração inicial
            dailyTarget = 1; 
        }

        return dailyTarget;
    }
    // FIM NOVA FUNÇÃO getDailyStudyTarget
	    // NOVA FUNÇÃO: Calcula a fase de estudo geral do usuário com base no progresso de estudo dos tópicos
    function calculateStudyPhase() {
        if (!allTopics || allTopics.length === 0) {
            return '0-50'; // Assume fase inicial se não houver tópicos
        }

        const totalTopics = allTopics.length;
        const topicsEstudados = allTopics.filter(t => t['Status Estudo'] === 'Concluído').length;
        
        const completionPercentage = (topicsEstudados / totalTopics) * 100;

        if (completionPercentage >= 100) {
            return '100+'; // Após a conclusão total
        } else if (completionPercentage >= 75) {
            return '75-100'; // 75% revisão até 100% concluído
        } else if (completionPercentage >= 50) {
            return '50-75'; // 50% revisão até 75% concluído
        } else {
            return '0-50'; // 25% revisão até 50% concluído
        }
    }
    // FIM NOVA FUNÇÃO calculateStudyPhase
	// NOVA FUNÇÃO: Aloca o tempo diário entre novo conteúdo e revisões conforme a fase de progressão
    function allocateDailyStudyHours(totalDailyHours, studyPhase) {
        let newContentHours = 0;
        let reviewHours = 0;

        switch (studyPhase) {
            case '0-50': // 25% revisão / 75% novo
                reviewHours = totalDailyHours * 0.25;
                newContentHours = totalDailyHours * 0.75;
                break;
            case '50-75': // 50% revisão / 50% novo
                reviewHours = totalDailyHours * 0.5;
                newContentHours = totalDailyHours * 0.5;
                break;
            case '75-100': // 75% revisão / 25% novo
                reviewHours = totalDailyHours * 0.75;
                newContentHours = totalDailyHours * 0.25;
                break;
            case '100+': // 100% revisão
                reviewHours = totalDailyHours;
                newContentHours = 0;
                break;
            default: // Caso padrão (se algo der errado, assume fase inicial)
                reviewHours = totalDailyHours * 0.25;
                newContentHours = totalDailyHours * 0.75;
                break;
        }

        return {
            newContentHours: parseFloat(newContentHours.toFixed(2)),
            reviewHours: parseFloat(reviewHours.toFixed(2))
        };
    }
    // FIM NOVA FUNÇÃO allocateDailyStudyHours
	
	  // NOVA FUNÇÃO: Prepara e prioriza os tópicos para agendamento (novos e de revisão)
   
function prepareTopicsForScheduling(focoPrincipalConfig, distribuicaoConfig, allTopics, globalMetas) {
    // Separa os tópicos em "para estudar" (novo conteúdo) e "para revisar)
    
    // <<< AQUI ESTÁ A CORREÇÃO PRINCIPAL: A variável 'config' é declarada APENAS UMA VEZ >>>
    const config = JSON.parse(localStorage.getItem('agendaConfig') || '{}');
    const excludedDiscipline = config.excludeDisciplina || '';
    
    // Filtra a disciplina excluída ANTES de qualquer outra lógica
    const availableTopics = excludedDiscipline 
        ? allTopics.filter(t => t.Disciplinas !== excludedDiscipline)
        : allTopics;

    let topicsToStudy = availableTopics.filter(t => t['Status Estudo'] !== 'Concluido');
    
    // --- INÍCIO DA LÓGICA INTEGRADA DO SRS ---
    const baseRevisaoConfig = config.baseRevisao || '1';
    let topicsToReviewOriginal = [];
    
    // DECIDE A FONTE DOS TÓPICOS DE REVISÃO (SRS ou LÓGICA PADRÃO)
    if (baseRevisaoConfig === 'srs') {
        // Se o modo SRS estiver ativo, usa nossa nova função inteligente
        topicsToReviewOriginal = getTopicsForSrsReview();
    } else {
        // Senão, usa a lógica padrão que já existia
        topicsToReviewOriginal = availableTopics.filter(t => t['Status Estudo'] === 'Concluído' && (parseInt(t['Revisao Count']) || 0) < 4);
    }
    // --- FIM DA LÓGICA INTEGRADA DO SRS ---

    // --- Implementação da proporção 2:1 (agora opera sobre a lista correta, seja ela do SRS ou não) ---
    const SMALL_TOPIC_PAGES_THRESHOLD = 5; 
    let smallReviewTopics = topicsToReviewOriginal.filter(t => (parseInt(t['N. de Páginas']) || 0) < SMALL_TOPIC_PAGES_THRESHOLD);
    let largeReviewTopics = topicsToReviewOriginal.filter(t => (parseInt(t['N. de Páginas']) || 0) >= SMALL_TOPIC_PAGES_THRESHOLD);

    smallReviewTopics.sort((a, b) => parseInt(a.Seq) - parseInt(b.Seq));
    largeReviewTopics.sort((a, b) => parseInt(a.Seq) - parseInt(b.Seq));

    let topicsToReview = [];
    let smallIdx = 0;
    let largeIdx = 0;

    while (smallIdx < smallReviewTopics.length || largeIdx < largeReviewTopics.length) {
        for (let i = 0; i < 2 && smallIdx < smallReviewTopics.length; i++) {
            topicsToReview.push(smallReviewTopics[smallIdx++]);
        }
        if (largeIdx < largeReviewTopics.length) {
            topicsToReview.push(largeReviewTopics[largeIdx++]);
        }
    }
    while (smallIdx < smallReviewTopics.length) {
        topicsToReview.push(smallReviewTopics[smallIdx++]);
    }
    while (largeIdx < largeReviewTopics.length) {
        topicsToReview.push(largeReviewTopics[largeIdx++]);
    }
    // --- Fim da implementação da proporção 2:1 ---

    // Aplica a distribuição por disciplina
    function applyDisciplineDistribution(topics, distributionType) {
        const disciplines = [...new Set(topics.map(t => t.Disciplinas).filter(d => d))];
        let distributedTopics = [];

        if (distributionType === 'igual') {
            distributedTopics = [...topics].sort(() => Math.random() - 0.5);
        } else if (distributionType === 'peso') {
            const disciplineWeights = {};
            disciplines.forEach(d => {
                const cleanDiscName = d.replace(/[^a-zA-Z0-9çãáéíóúâêôõüÇÃÁÉÍÓÚÂÊÔÕÜ\s]/g, '').replace(/ /g, '_');
                disciplineWeights[d] = parseInt(globalMetas[cleanDiscName]?.value || 0);
            });
            
            disciplines.sort((a, b) => disciplineWeights[b] - disciplineWeights[a]);

            let disciplineQueues = {};
            disciplines.forEach(d => disciplineQueues[d] = topics.filter(t => t.Disciplinas === d).sort((a, b) => parseInt(a.Seq) - parseInt(b.Seq)));
            
            let allQueuesEmpty = false;
            let currentDisciplineIndex = 0;
            while (!allQueuesEmpty) {
                allQueuesEmpty = true;
                const currentDisc = disciplines[currentDisciplineIndex];
                if (disciplineQueues[currentDisc] && disciplineQueues[currentDisc].length > 0) {
                    distributedTopics.push(disciplineQueues[currentDisc].shift());
                    allQueuesEmpty = false;
                }
                currentDisciplineIndex = (currentDisciplineIndex + 1) % disciplines.length;
                
                if (allQueuesEmpty) {
                    allQueuesEmpty = Object.values(disciplineQueues).every(queue => queue.length === 0);
                }
            }
        } else { 
            distributedTopics = [...topics].sort(() => Math.random() - 0.5);
        }
        return distributedTopics;
    }

    topicsToStudy = applyDisciplineDistribution(topicsToStudy, distribuicaoConfig);
    topicsToReview = applyDisciplineDistribution(topicsToReview, distribuicaoConfig);

    let finalNewTopics = [];
    let finalReviewTopics = [];

    if (focoPrincipalConfig === 'novos') {
        finalNewTopics = topicsToStudy;
        finalReviewTopics = topicsToReview.slice(0, Math.ceil(topicsToReview.length * 0.15));
    } else if (focoPrincipalConfig === 'revisao') {
        finalReviewTopics = topicsToReview;
        finalNewTopics = topicsToStudy.slice(0, Math.ceil(topicsToStudy.length * 0.15));
    } else if (focoPrincipalConfig === 'balanceado' || focoPrincipalConfig === 'chico-concursos') {
        finalNewTopics = topicsToStudy;
        finalReviewTopics = topicsToReview;
    } else if (focoPrincipalConfig === 'questoes') {
        finalReviewTopics = topicsToReview.filter(t => t['Status Questões'] !== 'Concluído' && t['Status Estudo'] === 'Concluído');
        finalNewTopics = topicsToStudy.filter(t => t['Status Questões'] !== 'Concluido');
        finalNewTopics.sort(() => Math.random() - 0.5);
        finalReviewTopics.sort(() => Math.random() - 0.5);
    }
    
    return { newTopics: finalNewTopics || [], reviewTopics: finalReviewTopics || [] };
}
	
	// NOVA FUNÇÃO PARA SINCRONIZAR CHECKBOXES
function syncPeriodCheckboxes(sourceCheckbox, targetGroup) {
    const isChecked = sourceCheckbox.checked;
    const period = sourceCheckbox.id.split('-')[2]; // manha, tarde, noite

    if (targetGroup === 'main') {
        const targetId = `periodo-${period}`;
        const targetEl = document.getElementById(targetId);
        if (targetEl) targetEl.checked = isChecked;
    } else { // targetGroup === 'config'
        const targetId = `config-periodo-${period}`;
        const targetEl = document.getElementById(targetId);
        if (targetEl) targetEl.checked = isChecked;
    }
    // Atualiza a visibilidade da grade principal
    updatePeriodoVisibility();
}
	
	// NOVA FUNÇÃO: Atribui os blocos de estudo aos slots da agenda
   function assignBlocksToAgenda(newTopics, reviewTopics, availableSlots, numNewTopicsForDay, numReviewTopicsForDay) {
    const agenda = [];
    let newTopicIndex = 0;
    let reviewTopicIndex = 0;
    const SUGGESTED_DURATION_PER_TOPIC = 1;
    const today = new Date();

    const slotsByDay = {};
    availableSlots.forEach(slot => {
        if (!slotsByDay[slot.dia]) { slotsByDay[slot.dia] = []; }
        slotsByDay[slot.dia].push(slot);
    });

    const orderedDays = ['Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado', 'Domingo'];

    for (const day of orderedDays) {
        const slotsForToday = slotsByDay[day];
        if (!slotsForToday || slotsForToday.length === 0) continue;

        let slotIndex = 0;

        // Agenda os TÓPICOS NOVOS
        for (let i = 0; i < numNewTopicsForDay; i++) {
            if (newTopicIndex >= newTopics.length) break;
            const topic = newTopics[newTopicIndex++];
            const targetSlot = slotsForToday[slotIndex % slotsForToday.length];
            agenda.push({
                Data: today.toISOString().split('T')[0], DiaSemana: targetSlot.dia, Periodo: targetSlot.periodo,
                Disciplina: topic.Disciplinas, TopicosSugeridos: `${topic.Seq} - ${topic.Tópicos}`,
                Horas: SUGGESTED_DURATION_PER_TOPIC, Concluido: 'Não', Prioridade: 'Alta',
                ID_Topico: topic.Seq, ID_Disciplina: topic.Disciplinas
            });
            slotIndex++;
        }

        // Agenda as REVISÕES
        for (let i = 0; i < numReviewTopicsForDay; i++) {
            if (reviewTopicIndex >= reviewTopics.length) break;
            const topic = reviewTopics[reviewTopicIndex++];
            const targetSlot = slotsForToday[slotIndex % slotsForToday.length];
            agenda.push({
                Data: today.toISOString().split('T')[0], DiaSemana: targetSlot.dia, Periodo: targetSlot.periodo,
                Disciplina: topic.Disciplinas, TopicosSugeridos: `${topic.Seq} - ${topic.Tópicos}`,
                Horas: SUGGESTED_DURATION_PER_TOPIC, Concluido: 'Não', Prioridade: 'Média',
                ID_Topico: topic.Seq, ID_Disciplina: topic.Disciplinas
            });
            slotIndex++;
        }
    }
    return agenda;
}
// FIM NOVA FUNÇÃO assignBlocksToAgenda

	
    function calcularMediasPersonalizadas() {
      const diasParaProva = globalMetas['Dias_p_Prova']?.value || 0;
      
      // PROGRESSO REAL DO USUÁRIO
      const temasEstudados = allTopics.filter(t => t['Status Estudo'] === 'Concluído').length;
      const totalTemas = allTopics.length;
      const temasRestantes = totalTemas - temasEstudados;
      
      const revisoesConcluidas = allTopics.filter(t => t['Status Revisão'] === 'Concluído').length;
      const revisoesRestantes = totalTemas - revisoesConcluidas;
      
      const questoesConcluidas = allTopics.filter(t => t['Status Questões'] === 'Concluído').length;
      const questoesRestantes = totalTemas - questoesConcluidas;
      
      // MATERIAIS PESSOAIS
      const paginasRestantes = (currentUserGoals['Total Material Páginas'] || 0) - (currentUserGoals['Páginas Concluídas'] || 0);
      const videosRestantes = (currentUserGoals['Total Material Vídeo Aulas'] || 0) - (currentUserGoals['Vídeo Aulas Concluídas'] || 0);
      const artigosRestantes = (currentUserGoals['Total Material Artigos'] || 0) - (currentUserGoals['Artigos Concluídos'] || 0);
      const flashcardsRestantes = (currentUserGoals['Total Material Flashcards'] || 0) - (currentUserGoals['Flashcards Concluídos'] || 0);

      // CÁLCULO DAS MÉDIAS PERSONALIZADAS
      let mediaTemasPersonalizada = diasParaProva > 0 ? (temasRestantes / diasParaProva).toFixed(1) : 'N/A';
      let mediaRevisoesPersonalizada = diasParaProva > 0 ? (revisoesRestantes / diasParaProva).toFixed(1) : 'N/A';
      let mediaQuestoesPersonalizada = diasParaProva > 0 ? (questoesRestantes / diasParaProva).toFixed(1) : 'N/A';
      let mediaPaginasPersonalizada = diasParaProva > 0 ? (paginasRestantes / diasParaProva).toFixed(1) : 'N/A';
      let mediaVideosPersonalizada = diasParaProva > 0 ? (videosRestantes / diasParaProva).toFixed(1) : 'N/A';
      let mediaArtigosPersonalizada = diasParaProva > 0 ? (artigosRestantes / diasParaProva).toFixed(1) : 'N/A';
      let mediaFlashcardsPersonalizada = diasParaProva > 0 ? (flashcardsRestantes / diasParaProva).toFixed(1) : 'N/A';

      return {
        mediaTemasPersonalizada,
        mediaRevisoesPersonalizada,
        mediaQuestoesPersonalizada,
        mediaPaginasPersonalizada,
        mediaVideosPersonalizada,
        mediaArtigosPersonalizada,
        mediaFlashcardsPersonalizada
      };
    }

 function showIndividualProgressOverview() {
  if (allTopics.length === 0) {
    showNotification('Nenhum dado carregado para calcular progresso', 'error');
    return;
  }
  const totalTopics = allTopics.length;
  const topicsEstudados = allTopics.filter(t => t['Status Estudo'] === 'Concluído').length;
  const topicsRevisados = allTopics.filter(t => t['Status Revisão'] === 'Concluído').length;
  const topicsQuestoes = allTopics.filter(t => t['Status Questões'] === 'Concluído').length;

  // --- GRÁFICO 1: Progresso por Disciplina (Estudo) ---
  const disciplines = [...new Set(allTopics.map(t => t.Disciplinas).filter(d => d))];
  let disciplineBars = '';

  // Adiciona a barra geral de Estudo Concluído
  disciplineBars += `
    <div class="discipline-progress">
      <div class="discipline-name">
        <span>Estudo Concluído</span>
        <span>${topicsEstudados}/${totalTopics} (${Math.round((topicsEstudados / totalTopics) * 100)}%)</span>
      </div>
      <div class="progress-bar-container">
		<div class="progress-bar-fill" style="width: ${Math.round((topicsEstudados / totalTopics) * 100)}%; background: linear-gradient(to right, #2E7D32, #4CAF50);">${Math.round((topicsEstudados / totalTopics) * 100)}%</div>
      </div>
    </div>
  `;

  if (disciplines.length > 0) {
    disciplineBars += `<div class="chart-title" style="margin-top: 20px;">Gráfico 1: Progresso por Disciplina (Estudo)</div>`;
    disciplines.forEach(disc => {
      const discTopics = allTopics.filter(t => t.Disciplinas === disc);
      const total = discTopics.length;
      const concluidos = discTopics.filter(t => t['Status Estudo'] === 'Concluído').length;
      const percent = total > 0 ? Math.round((concluidos / total) * 100) : 0;
      disciplineBars += `
        <div class="discipline-progress">
          <div class="discipline-name" onclick="filterByDiscipline('${disc}')">
            <span>${disc}</span>
            <span>${concluidos}/${total} (${percent}%)</span>
          </div>
          <div class="progress-bar-container">
            <div class="progress-bar-fill" style="width: ${percent}%; background: linear-gradient(to right, #2E7D32, #4CAF50);">${percent}%</div>
          </div>
        </div>
      `;
    });
  }

  // --- GRÁFICO 2: Revisão Geral + Revisão por Disciplina ---
  let chart2 = `
    <div class="chart-title">Gráfico 2: Revisão Geral</div>
    <div class="discipline-progress">
      <div class="discipline-name">
        <span>Revisão Concluída</span>
        <span>${topicsRevisados}/${totalTopics} (${Math.round((topicsRevisados / totalTopics) * 100)}%)</span>
      </div>
      <div class="progress-bar-container">
        <div class="revisao-bar-fill" style="width: ${Math.round((topicsRevisados / totalTopics) * 100)}%;">${Math.round((topicsRevisados / totalTopics) * 100)}%</div>
      </div>
    </div>
  `;

  if (disciplines.length > 0) {
    chart2 += `<div class="chart-title" style="margin-top: 20px;">Revisão por Disciplina</div>`;
    disciplines.forEach(disc => {
      const discTopics = allTopics.filter(t => t.Disciplinas === disc);
      const total = discTopics.length;
      const revisados = discTopics.filter(t => t['Status Revisão'] === 'Concluído').length;
      const percent = total > 0 ? Math.round((revisados / total) * 100) : 0;
      chart2 += `
        <div class="discipline-progress">
          <div class="discipline-name" onclick="filterByDiscipline('${disc}')">
            <span>${disc}</span>
            <span>${revisados}/${total} (${percent}%)</span>
          </div>
          <div class="progress-bar-container">
            <div class="revisao-bar-fill" style="width: ${percent}%;">${percent}%</div>
          </div>
        </div>
      `;
    });
  }

  // --- MONTAR TUDO ---
  const fullContent = `
    <div class="overview-chart">
      ${disciplineBars}
    </div>
    <div class="overview-chart">
      ${chart2}
    </div>
  `;

  document.getElementById('overview-title').innerHTML = '<i class="fas fa-chart-bar"></i> MINHA VISÃO GERAL DE PROGRESSO';
  document.getElementById('overview-content').innerHTML = fullContent;
  document.getElementById('overviewModal').style.display = 'flex';
}

    // --- NOVA FUNÇÃO PARA BOTÃO DADOS - COM CONTAINERS INDIVIDUAIS (1 COLUNA) ---
    function showDadosOverview() {
      if (Object.keys(globalMetas).length === 0) {
        showNotification('Nenhuma métrica global carregada.', 'error');
        return;
      }

      // Dados textuais (removido % Aprovação Ano Ant - CORREÇÃO 3)
      const dadosTextuais = [
        { chave: 'Matéria Mais Cobrada', valor: globalMetas['Materia_Mais_Cobradas']?.value || '—' },
        { chave: 'Tópico Crítico 1', valor: globalMetas['Topico_Crítico_1']?.value || '—' },
        { chave: 'Tópico Crítico 2', valor: globalMetas['Topico_Crítico_2']?.value || '—' }
        // % Aprovação Ano Ant foi removido (CORREÇÃO 3)
      ];

      let dadosContent = `
        <div class="overview-chart">
          <div class="chart-title">📊 Dados Textuais do Edital</div>
          <div class="dados-container">
      `;

      // Criar container individual para cada métrica (CORREÇÃO 5: 1 coluna)
      dadosTextuais.forEach(dado => {
        dadosContent += `
          <div class="dados-item">
            <div class="dados-label">${dado.chave}</div>
            <div class="dados-value">${dado.valor}</div>
          </div>
        `;
      });

      dadosContent += `
          </div>
        </div>
      `;

      document.getElementById('dados-title').innerHTML = '<i class="fas fa-database"></i> DADOS DO EDITAL';
      document.getElementById('dados-content').innerHTML = dadosContent;
      document.getElementById('dadosModal').style.display = 'flex';
    }

    function showRaioXOverview() {
      if (Object.keys(globalMetas).length === 0) {
          showNotification('Nenhuma métrica global carregada.', 'error');
          return;
      }

      // Dados do Raio X - ATUALIZADO (CORREÇÃO 3: % Aprovação Ano Ant movido para cá)
      const diasParaProva = globalMetas['Dias_p_Prova']?.value || 0;
      const totalTemas = globalMetas['Total_Temas_Edital']?.value || 0;
      const totalRevisoes = globalMetas['Total_Temas_Revisao_Edital']?.value || 0;
      const totalArtigos = globalMetas['Total_Artigos_Edital']?.value || 0;
      const totalVideos = globalMetas['Total_Video_Aulas_Edital']?.value || 0;
      const totalFlashcards = globalMetas['Total_Flashcards_Edital']?.value || 0;
      const dataProva = formatarData(globalMetas['Data_Prova']?.value);
      const percentAprovacao = globalMetas['Percent_Aprovacao_Ano_Ant']?.value || '—'; // CORREÇÃO 3: Movido para Raio X

      // MÉDIAS PERSONALIZADAS
      const mediasPersonalizadas = calcularMediasPersonalizadas();

      // Estrutura do Raio X com GRID DE 4 COLUNAS
      let raioXContent = `
          <div class="overview-chart">
              <div class="chart-title">📊 Métricas do Edital</div>
              <div class="overview-text-summary">
                  <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; align-items: center;">
      `;

      // Adicionar cada item em pares chave-valor - INCLUINDO % APROVAÇÃO (CORREÇÃO 3)
      const metricas = [
          { chave: 'Data Prova', valor: dataProva },
          { chave: 'Dias p Prova', valor: diasParaProva },
          { chave: 'Total Temas Edital', valor: totalTemas },
          { chave: 'Total Temas Revisao Edital', valor: totalRevisoes },
          { chave: 'Total Artigos Edital', valor: totalArtigos },
          { chave: 'Total Video Aulas Edital', valor: totalVideos },
          { chave: 'Total Flashcards Edital', valor: totalFlashcards || '—' },
          { chave: 'Qtd Vagas Edital', valor: globalMetas['Qtd_Vagas_Edital']?.value || '—' },
          { chave: 'Qtd Questões', valor: globalMetas['Qtd_Questões']?.value || '—' },
          { chave: '% Aprovação Ano Ant', valor: percentAprovacao } // CORREÇÃO 3: Adicionado aqui
      ];

      metricas.forEach(metrica => {
          raioXContent += `
              <div style="font-weight: bold; text-align: right; color: #FFD700;" class="${['Data Prova', 'Dias p Prova', 'Total Temas Edital'].includes(metrica.chave) ? 'bigger-font' : ''}">${metrica.chave}:</div>
              <div style="text-align: left; color: #ffffff; font-size: 1.3em; font-weight: bold;">${metrica.valor}</div>
          `;
      });

      raioXContent += `
              </div>
          </div>
      `;

      // Médias Diárias Recomendadas (Globais) - TAMBÉM EM 4 COLUNAS
      raioXContent += `
          <div class="overview-chart raiox-medias">
              <div class="chart-title">📅 Médias Diárias Recomendadas</div>
              <div class="overview-text-summary">
                  <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; align-items: center;">
                      <div style="font-weight: bold; text-align: right; color: #FFD700;">Tópicos:</div>
                      <div style="text-align: left; color: #ffffff; font-size: 1.3em; font-weight: bold;">${diasParaProva > 0 ? (totalTemas / diasParaProva).toFixed(1) : 'N/A'} por dia</div>
                      <div style="font-weight: bold; text-align: right; color: #FFD700;">Revisões:</div>
                      <div style="text-align: left; color: #ffffff; font-size: 1.3em; font-weight: bold;">${diasParaProva > 0 ? (totalRevisoes / diasParaProva).toFixed(1) : 'N/A'} por dia</div>
                      <div style="font-weight: bold; text-align: right; color: #FFD700;">Artigos:</div>
                      <div style="text-align: left; color: #ffffff; font-size: 1.3em; font-weight: bold;">${diasParaProva > 0 ? (totalArtigos / diasParaProva).toFixed(1) : 'N/A'} por dia</div>
                      <div style="font-weight: bold; text-align: right; color: #FFD700;">Vídeos:</div>
                      <div style="text-align: left; color: #ffffff; font-size: 1.3em; font-weight: bold;">${diasParaProva > 0 ? (totalVideos / diasParaProva).toFixed(1) : 'N/A'} por dia</div>
                      <div style="font-weight: bold; text-align: right; color: #FFD700;">Flashcards:</div>
                      <div style="text-align: left; color: #ffffff; font-size: 1.3em; font-weight: bold;">${diasParaProva > 0 ? (totalFlashcards / diasParaProva).toFixed(1) : 'N/A'} por dia</div>
                  </div>
              </div>
          </div>
      `;

      // Suas Médias Diárias Personalizadas - TAMBÉM EM 4 COLUNAS
      raioXContent += `
          <div class="overview-chart raiox-personalizadas">
              <div class="chart-title">💪 Suas Médias Diárias Personalizadas</div>
              <div class="overview-text-summary">
                  <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; align-items: center;">
                      <div style="font-weight: bold; text-align: right; color: #FFD700;">Tópicos restantes:</div>
                      <div style="text-align: left; color: #ffffff; font-size: 1.3em; font-weight: bold;">${mediasPersonalizadas.mediaTemasPersonalizada} por dia</div>
                      <div style="font-weight: bold; text-align: right; color: #FFD700;">Revisões restantes:</div>
                      <div style="text-align: left; color: #ffffff; font-size: 1.3em; font-weight: bold;">${mediasPersonalizadas.mediaRevisoesPersonalizada} por dia</div>
                      <div style="font-weight: bold; text-align: right; color: #FFD700;">Questões restantes:</div>
                      <div style="text-align: left; color: #ffffff; font-size: 1.3em; font-weight: bold;">${mediasPersonalizadas.mediaQuestoesPersonalizada} por dia</div>
                      <div style="font-weight: bold; text-align: right; color: #FFD700;">Páginas restantes:</div>
                      <div style="text-align: left; color: #ffffff; font-size: 1.3em; font-weight: bold;">${mediasPersonalizadas.mediaPaginasPersonalizada} por dia</div>
                      <div style="font-weight: bold; text-align: right; color: #FFD700;">Vídeos restantes:</div>
                      <div style="text-align: left; color: #ffffff; font-size: 1.3em; font-weight: bold;">${mediasPersonalizadas.mediaVideosPersonalizada} por dia</div>
                      <div style="font-weight: bold; text-align: right; color: #FFD700;">Artigos restantes:</div>
                      <div style="text-align: left; color: #ffffff; font-size: 1.3em; font-weight: bold;">${mediasPersonalizadas.mediaArtigosPersonalizada} por dia</div>
                      <div style="font-weight: bold; text-align: right; color: #FFD700;">Flashcards restantes:</div>
                      <div style="text-align: left; color: #ffffff; font-size: 1.3em; font-weight: bold;">${mediasPersonalizadas.mediaFlashcardsPersonalizada} por dia</div>
                  </div>
              </div>
          </div>
          
          <div class="overview-chart">
              <div class="chart-title">Dicas para Eficácia e Eficiência</div>
              <div class="overview-text-summary dicas-content">
                  <div>🍅 <strong>CICLO POMODORO – FOCO E DISCIPLINA</strong></div>
                  <div>⏱️ 25 min → 💪 FOCO TOTAL</div>
                  <div>☕ 5 min → 😌 PAUSA CURTA</div>
                  <div>🔁 Repita 4 vezes</div>
                  <div>🌿 Após 4 ciclos → 💤 PAUSA LONGA (15–30 min)</div>
                  <div>🎯 Objetivo:</div>
                  <div>👉 Aumentar a concentração</div>
                  <div>👉 Evitar a procrastinação</div>
                  <div>👉 Reduzir o cansaço mental</div>
                  <br>
                  <div>• Revise o conteúdo no mesmo dia e depois em intervalos crescentes (1, 3, 7, 15 dias).</div>
                  <div>• Resolva questões imediatamente após estudar o tema.</div>
                  <div>• Use flashcards para memorizar conceitos-chave e jurisprudência.</div>
                  <div>• Priorize os temas mais cobrados e os críticos listados acima.</div>
              </div>
          </div>
      `;

      document.getElementById('overview-title').innerHTML = '<i class="fas fa-binoculars"></i> RAIO X DO EDITAL';
      document.getElementById('overview-content').innerHTML = raioXContent;
      document.getElementById('overviewModal').style.display = 'flex';
    }

    // --- VISÃO GERAL ORIGINAL DO V16 (ATUALIZADA) ---
 // --- VISÃO GERAL ORIGINAL DO V16 (ATUALIZADA) ---
function showProgressOverview() {
  if (allTopics.length === 0) {
    showNotification('Nenhum dado carregado para calcular progresso', 'error');
    return;
  }
  const totalTopics = allTopics.length;
  const topicsEstudados = allTopics.filter(t => t['Status Estudo'] === 'Concluído').length;
  const topicsRevisados = allTopics.filter(t => t['Status Revisão'] === 'Concluído').length;
  const topicsQuestoes = allTopics.filter(t => t['Status Questões'] === 'Concluído').length;

  // --- 📊 DADOS DO EDITAL ---
  const dataProva = formatarData(globalMetas['Data_Prova']?.value);
  const dadosEditalHTML = `
    <div class="overview-chart">
      <div class="chart-title">📊 Dados do Edital</div>
      <div class="overview-text-summary">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: center;">
          <div style="font-weight: bold; text-align: right; color: #FFD700;" class="bigger-font">Data Prova:</div>
          <div style="text-align: left; color: #ffffff;" class="bigger-font">${dataProva}</div>
          <div style="font-weight: bold; text-align: right; color: #FFD700;" class="bigger-font">Dias p/ Prova:</div>
          <div style="text-align: left; color: #ffffff;" class="bigger-font">${globalMetas['Dias_p_Prova']?.value || 'N/A'} dias</div>
          <div style="font-weight: bold; text-align: right; color: #FFD700;" class="bigger-font">Temas:</div>
          <div style="text-align: left; color: #ffffff;" class="bigger-font">${globalMetas['Total_Temas_Edital']?.value || 'N/A'}</div>
        </div>
      </div>
    </div>
  `;

  // --- 📚 DISTRIBUIÇÃO DE QUESTÕES POR DISCIPLINA ---
  const disciplinasQuestoes = [
    { nome: 'L. Portuguesa', questoes: globalMetas['L._Portuguesa']?.value || '—' },
    { nome: 'Informática Básica', questoes: globalMetas['Informática_Básica']?.value || '—' },
    { nome: 'Noções de Direito', questoes: globalMetas['Noções_de_Direito']?.value || '—' },
    { nome: 'Direitos Humanos', questoes: globalMetas['Direitos_Humanos']?.value || '—' },
  ];
  let disciplinasContent = '';
  disciplinasQuestoes.forEach(disciplina => {
    disciplinasContent += `
      <div style="font-weight: bold; text-align: right; color: #FFD700;">${disciplina.nome}:</div>
      <div style="text-align: left; color: #ffffff; font-weight: bold;">${disciplina.questoes} questões</div>
    `;
  });
  const disciplinasHTML = `
    <div class="overview-chart">
      <div class="chart-title">📚 Distribuição de Questões por Disciplina</div>
      <div class="overview-text-summary distribuicao-questoes">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: center;">
          ${disciplinasContent}
        </div>
      </div>
    </div>
  `;

  // --- DOIS GRÁFICOS DE PIZZA LADO A LADO ---
  const graficosPizza = `
    <div class="overview-chart">
      <div style="display: flex; justify-content: space-between; gap: 20px; padding: 10px;">
        <!-- Gráfico de Pizza: Estudo -->
        <div style="flex: 1; display: flex; align-items: center; gap: 15px; padding: 10px; border-radius: 8px; background: rgba(0,0,0,0.3);">
          <div style="position: relative; width: 100px; height: 100px; border-radius: 50%; background: conic-gradient(#4CAF50 0% ${(topicsEstudados / totalTopics) * 100}%, #F44336 ${(topicsEstudados / totalTopics) * 100}% 100%); box-shadow: 0 0 8px rgba(0,0,0,0.3);"></div>
          <div style="text-align: left; font-size: 0.95rem; line-height: 1.6;">
            <div style="font-weight: bold; color: #FFD700;">🍕 Estudo</div>
            <div><span style="display: inline-block; width: 12px; height: 12px; background: #4CAF50; border-radius: 50%; margin-right: 6px;"></span> Estudado: ${topicsEstudados}</div>
            <div><span style="display: inline-block; width: 12px; height: 12px; background: #F44336; border-radius: 50%; margin-right: 6px;"></span> Falta: ${totalTopics - topicsEstudados}</div>
            <div style="margin-top: 6px; font-weight: bold;">Total: ${totalTopics}</div>
          </div>
        </div>
        <!-- Gráfico de Pizza: Revisão -->
        <div style="flex: 1; display: flex; align-items: center; gap: 15px; padding: 10px; border-radius: 8px; background: rgba(0,0,0,0.3);">
          <div style="position: relative; width: 100px; height: 100px; border-radius: 50%; background: conic-gradient(#FFC107 0% ${(topicsRevisados / totalTopics) * 100}%, #F44336 ${(topicsRevisados / totalTopics) * 100}% 100%); box-shadow: 0 0 8px rgba(0,0,0,0.3);"></div>
          <div style="text-align: left; font-size: 0.95rem; line-height: 1.6;">
            <div style="font-weight: bold; color: #FFD700;">🍕 Revisão</div>
            <div><span style="display: inline-block; width: 12px; height: 12px; background: #FFC107; border-radius: 50%; margin-right: 6px;"></span> Revisado: ${topicsRevisados}</div>
            <div><span style="display: inline-block; width: 12px; height: 12px; background: #F44336; border-radius: 50%; margin-right: 6px;"></span> Falta: ${totalTopics - topicsRevisados}</div>
            <div style="margin-top: 6px; font-weight: bold;">Total: ${totalTopics}</div>
          </div>
        </div>
      </div>
    </div>
  `;

  // --- BARRAS DE PROGRESSO COM NÚMERO REAL + PORCENTAGEM NAS DUAS PARTES ---
  const totalPaginas = currentUserGoals['Total Material Páginas'] || 0;
  const paginasConcluidas = currentUserGoals['Páginas Concluídas'] || 0;
  const progressoPaginas = totalPaginas > 0 ? Math.round((paginasConcluidas / totalPaginas) * 100) : 0;
  const totalVideos = currentUserGoals['Total Material Vídeo Aulas'] || 0;
  const videosConcluidos = currentUserGoals['Vídeo Aulas Concluídas'] || 0;
  const progressoVideos = totalVideos > 0 ? Math.round((videosConcluidos / totalVideos) * 100) : 0;
  const totalArtigos = currentUserGoals['Total Material Artigos'] || 0;
  const artigosConcluidos = currentUserGoals['Artigos Concluídos'] || 0;
  const progressoArtigos = totalArtigos > 0 ? Math.round((artigosConcluidos / totalArtigos) * 100) : 0;
  const totalFlashcards = currentUserGoals['Total Material Flashcards'] || 0;
  const flashcardsConcluidos = currentUserGoals['Flashcards Concluídos'] || 0;
  const progressoFlashcards = totalFlashcards > 0 ? Math.round((flashcardsConcluidos / totalFlashcards) * 100) : 0;

  const cores = {
    Estudo: '#4CAF50',
    Revisão: '#FFC107',
    Questões: '#2196F3',
    Páginas: '#42A5F5',
    Vídeos: '#9C27B0',
    Artigos: '#FF9800',
    Flashcards: '#00BCD4'
  };

  function criarBarra(categoria, percentual, concluido, total, cor) {
    const falta = total - concluido;
    const percentualFalta = total > 0 ? Math.round((falta / total) * 100) : 0;
    return `
      <div class="discipline-progress" style="margin-bottom: 2px; position: relative;">
        <div class="discipline-name">
          <span>${categoria}</span>
          <span>${concluido}/${total} (${percentual}%)</span>
        </div>
        <div class="progress-bar-container" style="background-color: #333; height: 22px; border-radius: 11px; overflow: hidden; position: relative;">
          <div class="custom-progress-bar-fill" style="width: ${percentual}%; background-color: ${cor}; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; color: #000; font-size: 0.8rem; font-weight: bold;">
            ${concluido} (${percentual}%)
          </div>
          ${percentual < 100 ? `
            <div style="position: absolute; left: ${percentual}%; right: 0; top: 0; bottom: 0; display: flex; align-items: center; padding-left: 8px; color: #ccc; font-size: 0.8rem; font-weight: bold;">
              ${falta} (${percentualFalta}%)
            </div>
          ` : ''}
        </div>
      </div>
    `;
  }

  let barrasHTML = '';
  barrasHTML += criarBarra('Estudo', Math.round((topicsEstudados / totalTopics) * 100), topicsEstudados, totalTopics, cores.Estudo);
  barrasHTML += criarBarra('Revisão', Math.round((topicsRevisados / totalTopics) * 100), topicsRevisados, totalTopics, cores.Revisão);
  barrasHTML += criarBarra('Questões', Math.round((topicsQuestoes / totalTopics) * 100), topicsQuestoes, totalTopics, cores.Questões);
  barrasHTML += criarBarra('Páginas', progressoPaginas, paginasConcluidas, totalPaginas, cores.Páginas);
  barrasHTML += criarBarra('Vídeos', progressoVideos, videosConcluidos, totalVideos, cores.Vídeos);
  barrasHTML += criarBarra('Artigos', progressoArtigos, artigosConcluidos, totalArtigos, cores.Artigos);
  barrasHTML += criarBarra('Flashcards', progressoFlashcards, flashcardsConcluidos, totalFlashcards, cores.Flashcards);

  const barrasVerticaisHTML = `
    <div class="overview-chart" style="padding: 8px; margin-top: 10px;">
      <div class="chart-title">Progresso Detalhado por Categoria</div>
      <div style="display: flex; flex-direction: column; gap: 2px;">
        ${barrasHTML}
      </div>
    </div>
  `;

  // --- Montagem final ---
  const fullContent = `
    ${dadosEditalHTML}
    ${disciplinasHTML}
    ${graficosPizza}
    ${barrasVerticaisHTML}
  `;

  document.getElementById('overview-title').innerHTML = '<i class="fas fa-chart-bar"></i> VISÃO GERAL DO PROGRESSO';
  document.getElementById('overview-content').innerHTML = fullContent;
  document.getElementById('overviewModal').style.display = 'flex';
}

function showIndividualProgressOverview() {
  if (allTopics.length === 0) {
    showNotification('Nenhum dado carregado para calcular progresso', 'error');
    return;
  }
  const totalTopics = allTopics.length;
  const topicsEstudados = allTopics.filter(t => t['Status Estudo'] === 'Concluído').length;
  const topicsRevisados = allTopics.filter(t => t['Status Revisão'] === 'Concluído').length;
  const topicsQuestoes = allTopics.filter(t => t['Status Questões'] === 'Concluído').length;

  function criarBarraIndividual(titulo, concluidos, total, corClasse = 'progress-bar-fill') {
    const percent = total > 0 ? Math.round((concluidos / total) * 100) : 0;
    const falta = total - concluidos;
    const percentFalta = total > 0 ? Math.round((falta / total) * 100) : 0;
    const bgColor = corClasse === 'revisao-bar-fill' 
      ? 'linear-gradient(to right, #FFC107, #FFD54F)' 
      : 'linear-gradient(to right, #2E7D32, #4CAF50)';

    return `
      <div class="discipline-progress">
        <div class="discipline-name">
          <span>${titulo}</span>
          <span>${concluidos}/${total} (${percent}%)</span>
        </div>
        <div class="progress-bar-container" style="position: relative;">
          <div class="${corClasse}" style="width: ${percent}%; background: ${bgColor};">
            ${concluidos} (${percent}%)
          </div>
          ${percent < 100 ? `
            <div style="position: absolute; left: ${percent}%; right: 0; top: 0; bottom: 0; display: flex; align-items: center; padding-left: 8px; color: #ccc; font-size: 0.8rem; font-weight: bold;">
              ${falta} (${percentFalta}%)
            </div>
          ` : ''}
        </div>
      </div>
    `;
  }

  const disciplines = [...new Set(allTopics.map(t => t.Disciplinas).filter(d => d))];
  let disciplineBars = '';

  disciplineBars += criarBarraIndividual('Estudo Concluído', topicsEstudados, totalTopics, 'progress-bar-fill');

  if (disciplines.length > 0) {
    disciplineBars += `<div class="chart-title" style="margin-top: 20px;">Gráfico 1: Progresso por Disciplina (Estudo)</div>`;
    disciplines.forEach(disc => {
      const discTopics = allTopics.filter(t => t.Disciplinas === disc);
      const total = discTopics.length;
      const concluidos = discTopics.filter(t => t['Status Estudo'] === 'Concluído').length;
      disciplineBars += criarBarraIndividual(disc, concluidos, total, 'progress-bar-fill');
    });
  }

  let chart2 = `<div class="chart-title">Gráfico 2: Revisão Geral</div>`;
  chart2 += criarBarraIndividual('Revisão Concluída', topicsRevisados, totalTopics, 'revisao-bar-fill');

  if (disciplines.length > 0) {
    chart2 += `<div class="chart-title" style="margin-top: 20px;">Revisão por Disciplina</div>`;
    disciplines.forEach(disc => {
      const discTopics = allTopics.filter(t => t.Disciplinas === disc);
      const total = discTopics.length;
      const revisados = discTopics.filter(t => t['Status Revisão'] === 'Concluído').length;
      chart2 += criarBarraIndividual(disc, revisados, total, 'revisao-bar-fill');
    });
  }

  const fullContent = `
    <div class="overview-chart">
      ${disciplineBars}
    </div>
    <div class="overview-chart">
      ${chart2}
    </div>
  `;

  document.getElementById('overview-title').innerHTML = '<i class="fas fa-chart-bar"></i> MINHA VISÃO GERAL DE PROGRESSO';
  document.getElementById('overview-content').innerHTML = fullContent;
  document.getElementById('overviewModal').style.display = 'flex';
}

    function filterByDiscipline(disciplineName) {
      document.getElementById('disciplineFilter').value = disciplineName;
      filterTopics();
      document.getElementById('overviewModal').style.display = 'none';
      showSection("topics-list-container");
      updateTopicCounter();
    }

    // --- FUNÇÕES DE SALVAMENTO DE TÓPICOS ---
    async function saveProgress() {
      const saveButton = document.getElementById('save-progress-btn');
      
      // Feedback visual imediato
      saveButton.innerHTML = '<i class="fas fa-spinner button-spinner"></i> Salvando...';
      saveButton.style.background = 'linear-gradient(135deg, #2196F3, #42A5F5, #1565C0)';
      
      if (!currentUserName) {
        showNotification('Usuário não autenticado.', 'error');
        saveButton.innerHTML = '<i class="fas fa-save"></i> Salvar Progresso';
        saveButton.style.background = '';
        return;
      }
      if (isEditMode) {
        await saveTopicChanges();
        saveButton.innerHTML = '<i class="fas fa-save"></i> Salvar Progresso';
        saveButton.style.background = '';
        return;
      }
      const sequence = currentTopicSequence;
      if (!sequence) {
        showNotification('Nenhum tópico selecionado.', 'error');
        saveButton.innerHTML = '<i class="fas fa-save"></i> Salvar Progresso';
        saveButton.style.background = '';
        return;
      }
      const statusEstudo = document.getElementById('estudo-checkbox').checked ? 'Concluído' : 'Não Concluído';
      const dataEstudo = document.getElementById('estudo-date').value;
      
      // ✅ NOVA LÓGICA PARA REVISÃO - SUBSTITUIÇÃO APLICADA
      const revisaoCount = parseInt(document.getElementById('revisao-count').value) || 0;
      const statusRevisao = revisaoCount > 0 ? 'Concluído' : 'Não Concluído';
      const dataRevisao = document.getElementById('revisao-date').value;
      
      const statusQuestoes = document.getElementById('questoes-checkbox').checked ? 'Concluído' : 'Não Concluído';
      const dataQuestoes = document.getElementById('questoes-date').value;
	  const statusFlashcards = document.getElementById('flashcards-checkbox').checked ? 'Concluído' : 'Não Concluído';
const dataFlashcards = document.getElementById('flashcards-date').value;
      
      try {
        const url = new URL(WEB_APP_URL);
        const params = new URLSearchParams();
        params.append("action", "update");
        params.append("userEmail", currentUserName);
        params.append("sequence", sequence);
        params.append("statusEstudo", statusEstudo);
        params.append("dataEstudo", dataEstudo);
        params.append("statusRevisao", statusRevisao);
        params.append("dataRevisao", dataRevisao);
        params.append("statusQuestoes", statusQuestoes);
        params.append("dataQuestoes", dataQuestoes);
        
        // ✅ IMPLANTAÇÃO DO NOVO PARÂMETRO - SUBSTITUIÇÃO APLICADA
        params.append("revisaoCount", revisaoCount);
		params.append("statusFlashcards", statusFlashcards);
params.append("dataFlashcards", dataFlashcards);
        
        const response = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: params,
          redirect: 'follow'
        });
        
        const result = await response.json();
        if (result.error) {
          throw new Error(result.error);
        }
        if (!result.success) {
          throw new Error(result.message);
        }
        
        // Restaurar botão com feedback positivo
        saveButton.innerHTML = '<i class="fas fa-check"></i> Salvo!';
        saveButton.style.background = 'linear-gradient(135deg, #4CAF50, #66BB6A, #2E7D32)';
        saveButton.classList.add('pulse-animation');
        
        showNotification('Progresso salvo com sucesso!');
        await loadAllData();
        
        // Restaurar após 2 segundos
        setTimeout(() => {
          saveButton.innerHTML = '<i class="fas fa-save"></i> Salvar Progresso';
          saveButton.style.background = '';
          saveButton.classList.remove('pulse-animation');
        }, 2000);
        
      } catch (error) {
        console.error("Erro ao salvar progresso:", error);
        showNotification(`Erro ao salvar: ${error.message}`, 'error');
        saveButton.innerHTML = '<i class="fas fa-save"></i> Salvar Progresso';
        saveButton.style.background = '';
      }
    }

    function toggleEditMode() {
      if (!isEditMode) {
        showConfirm('Ao editar o tópico, você estará modificando informações que foram pré-definidas. Tem certeza que deseja continuar?', (confirmed) => {
          if (confirmed) {
            activateEditMode();
          }
        });
      } else {
        deactivateEditMode();
      }
    }

    function activateEditMode() {
      isEditMode = true;
      originalTopicData = {
        disc: document.getElementById('info-disc').textContent,
        seq: document.getElementById('info-seq').textContent,
        topico: document.getElementById('info-topico').textContent,
        subtopico: document.getElementById('info-subtopico').textContent
      };
      document.getElementById('edit-mode-banner').style.display = 'block';
      document.querySelectorAll('.info-value').forEach(el => el.style.display = 'none');
      document.querySelectorAll('.edit-input').forEach(el => {
        el.style.display = 'block';
        const field = el.id.replace('edit-', '');
        el.value = originalTopicData[field];
      });
      document.getElementById('edit-topic-btn').innerHTML = '<i class="fas fa-times"></i> Cancelar Edição';
      document.getElementById('edit-topic-btn').classList.remove('btn-edit');
      document.getElementById('edit-topic-btn').classList.add('btn-cancel');
      showNotification('Modo de edição ativado. Você pode modificar as informações do tópico.', 'success');
    }

    function deactivateEditMode() {
      isEditMode = false;
      document.getElementById('edit-mode-banner').style.display = 'none';
      document.querySelectorAll('.info-value').forEach(el => el.style.display = 'block');
      document.querySelectorAll('.edit-input').forEach(el => el.style.display = 'none');
      if (originalTopicData.disc) {
        document.getElementById('info-disc').textContent = originalTopicData.disc;
        document.getElementById('info-seq').textContent = originalTopicData.seq;
        document.getElementById('info-topico').textContent = originalTopicData.topico;
        document.getElementById('info-subtopico').textContent = originalTopicData.subtopico;
      }
      document.getElementById('edit-topic-btn').innerHTML = '<i class="fas fa-edit"></i> Editar Tópico';
      document.getElementById('edit-topic-btn').classList.remove('btn-cancel');
      document.getElementById('edit-topic-btn').classList.add('btn-edit');
      showNotification('Modo de edição desativado.', 'success');
    }

    async function saveTopicChanges() {
      if (!currentUserName) {
        showNotification('Usuário não autenticado.', 'error');
        return;
      }
      const sequence = currentTopicSequence;
      if (!sequence) {
        showNotification('Nenhum tópico selecionado.', 'error');
        return;
      }
      const disc = document.getElementById('edit-disc').value;
      const seq = document.getElementById('edit-seq').value;
      const topico = document.getElementById('edit-topico').value;
      const subtopico = document.getElementById('edit-subtopico').value;
      if (!disc || !seq || !topico) {
        showNotification('Disciplina, Sequência e Tópico são obrigatórios.', 'error');
        return;
      }
      try {
        const url = new URL(WEB_APP_URL);
        const params = new URLSearchParams();
        params.append("action", "update_topic");
        params.append("userEmail", currentUserName);
        params.append("sequence", sequence);
        params.append("disc", disc);
        params.append("topico", topico);
        params.append("subtopico", subtopico);
        const response = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: params,
          redirect: 'follow'
        });
        const result = await response.json();
        if (result.error) {
          throw new Error(result.error);
        }
        if (!result.success) {
          throw new Error(result.message);
        }
        document.getElementById('info-disc').textContent = disc;
        document.getElementById('info-seq').textContent = seq;
        document.getElementById('info-topico').textContent = topico;
        document.getElementById('info-subtopico').textContent = subtopico;
        document.getElementById('topic-detail-title').innerHTML = `<i class="fas fa-book"></i> ${disc} - ${seq}`;
        if (subtopico && subtopico !== '—') {
          document.getElementById('topic-detail-title').innerHTML += `<br><i class="fas fa-level-down-alt"></i> ${subtopico}`;
        }
        document.getElementById('topic-detail-discipline').textContent = topico;
        showNotification('Tópico atualizado com sucesso!');
        deactivateEditMode();
        await loadAllData();
      } catch (error) {
        console.error("Erro ao salvar tópico:", error);
        showNotification(`Erro ao salvar: ${error.message}`, 'error');
      }
    }

    function resetProgress() {
      const resetButton = document.getElementById('reset-progress-btn');
      const sequence = currentTopicSequence;
      if (!sequence) return;
      showConfirm('Tem certeza que deseja limpar todo o progresso deste tópico?', async (confirmed) => {
        if (confirmed) {
          setButtonLoading(resetButton, true);
          try {
            const url = new URL(WEB_APP_URL);
            const params = new URLSearchParams();
            params.append("action", "reset");
            params.append("userEmail", currentUserName);
            params.append("sequence", sequence);
            
            // ✅ ADICIONAR reset do contador de revisões - SUBSTITUIÇÃO APLICADA
            params.append("resetRevisaoCount", "true");
            
            const response = await fetch(url, {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: params,
              redirect: 'follow'
            });
            
            const result = await response.json();
            if (result.error) {
              throw new Error(result.error);
            }
            if (!result.success) {
              throw new Error(result.message);
            }
            
            showNotification('Progresso resetado com sucesso!');
            await loadAllData();
            
          } catch (error) {
            console.error("Erro ao resetar progresso:", error);
            showNotification(`Erro ao resetar: ${error.message}`, 'error');
          } finally {
            setButtonLoading(resetButton, false);
          }
        }
      });
    }
	
	async function setDifficulty(level) {
      if (!currentTopicSequence) return;
    
      // Atualiza a aparência dos botões
      document.querySelectorAll('.btn-difficulty').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.level === level) {
          btn.classList.add('active');
        }
      });
    
      // Salva a informação
      await saveTopicDifficulty(currentTopicSequence, level);
    }
    
    async function saveTopicDifficulty(sequence, level) {
      if (!currentUserName) {
        showNotification('Usuário não autenticado.', 'error');
        return;
      }
      try {
        const url = new URL(WEB_APP_URL);
        const params = new URLSearchParams();
        params.append("action", "updateDifficulty");
        params.append("userEmail", currentUserName);
        params.append("sequence", sequence);
        params.append("difficulty", level);
    
        const response = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: params,
          redirect: 'follow'
        });
    
        const result = await response.json();
        if (result.error) throw new Error(result.error);
    
        showNotification(`Dificuldade do tópico #${sequence} salva como "${level}"!`);
        
        // Atualiza os dados locais para refletir a mudança
        const topic = allTopics.find(t => t.Seq == sequence);
        if (topic) {
          topic.Dificuldade = level;
        }
    
      } catch (error) {
        console.error("Erro ao salvar dificuldade:", error);
        showNotification(`Erro ao salvar dificuldade: ${error.message}`, 'error');
      }
    }
    // --- FIM DAS NOVAS FUNÇÕES DE DIFICULDADE ---
	
// === FUNÇÕES DE CONTROLE RÁPIDO NA LISTA ===

async function quickToggleEstudo(sequence, element) {
  if (!currentUserName) {
    showNotification('Usuário não autenticado.', 'error');
    return;
  }

  // --- Início da Modificação ---
  element.classList.remove('success', 'error');
  element.classList.add('loading');
  // --- Fim da Modificação ---

  const isChecked = !element.classList.contains('checked-estudo'); // Lógica invertida para refletir o novo estado
  const newStatus = isChecked ? 'Concluído' : 'Não Concluído';
  const dataEstudo = isChecked ? new Date().toISOString().split('T')[0] : '';

  try {
    const url = new URL(WEB_APP_URL);
    const params = new URLSearchParams();
    params.append("action", "update");
    params.append("userEmail", currentUserName);
    params.append("sequence", sequence);
    params.append("statusEstudo", newStatus);
    params.append("dataEstudo", dataEstudo);
    
    const response = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: params,
      redirect: 'follow'
    });
    
    const result = await response.json();
    if (result.error) throw new Error(result.error);
    
    // --- Início da Modificação ---
    element.classList.remove('loading');
    element.classList.add('success');
    showNotification('Status de estudo atualizado!', 'success');
    await loadAllData(); // Recarrega a lista
    // --- Fim da Modificação ---
    
  } catch (error) {
    console.error("Erro:", error);
    showNotification(`Erro: ${error.message}`, 'error');
    // --- Início da Modificação ---
    element.classList.remove('loading');
    element.classList.add('error');
    setTimeout(() => element.classList.remove('error'), 1500); // Remove o estado de erro após um tempo
    // --- Fim da Modificação ---
  }
}

async function quickToggleQuestoes(sequence, element) {
  if (!currentUserName) {
    showNotification('Usuário não autenticado.', 'error');
    return;
  }

  // --- Início da Modificação ---
  element.classList.remove('success', 'error');
  element.classList.add('loading');
  // --- Fim da Modificação ---

  const isChecked = !element.classList.contains('checked-questoes');
  const newStatus = isChecked ? 'Concluído' : 'Não Concluído';
  const dataQuestoes = isChecked ? new Date().toISOString().split('T')[0] : '';

  try {
    const url = new URL(WEB_APP_URL);
    const params = new URLSearchParams();
    params.append("action", "update");
    params.append("userEmail", currentUserName);
    params.append("sequence", sequence);
    params.append("statusQuestoes", newStatus);
    params.append("dataQuestoes", dataQuestoes);
    
    const response = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: params,
      redirect: 'follow'
    });
    
    const result = await response.json();
    if (result.error) throw new Error(result.error);
    
    // --- Início da Modificação ---
    element.classList.remove('loading');
    element.classList.add('success');
    showNotification('Status de questões atualizado!', 'success');
    await loadAllData();
    // --- Fim da Modificação ---
    
  } catch (error) {
    console.error("Erro:", error);
    showNotification(`Erro: ${error.message}`, 'error');
    // --- Início da Modificação ---
    element.classList.remove('loading');
    element.classList.add('error');
    setTimeout(() => element.classList.remove('error'), 1500);
    // --- Fim da Modificação ---
  }
}
 async function quickToggleFlashcards(sequence, element) {
  if (!currentUserName) {
    showNotification('Usuário não autenticado.', 'error');
    return;
  }

  element.classList.remove('success', 'error');
  element.classList.add('loading');

  const isChecked = !element.classList.contains('checked-flashcards');
  const newStatus = isChecked ? 'Concluído' : 'Não Concluído';
  const dataFlashcards = isChecked ? new Date().toISOString().split('T')[0] : '';

  try {
    const url = new URL(WEB_APP_URL);
    const params = new URLSearchParams();
    params.append("action", "update");
    params.append("userEmail", currentUserName);
    params.append("sequence", sequence);
    params.append("statusFlashcards", newStatus);
    params.append("dataFlashcards", dataFlashcards);
    
    const response = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: params,
      redirect: 'follow'
    });
    
    const result = await response.json();
    if (result.error) throw new Error(result.error);
    
    element.classList.remove('loading');
    element.classList.add('success');
    showNotification('Status de flashcards atualizado!', 'success');
    await loadAllData();
    
  } catch (error)
{
    console.error("Erro:", error);
    showNotification(`Erro: ${error.message}`, 'error');
    element.classList.remove('loading');
    element.classList.add('error');
    setTimeout(() => element.classList.remove('error'), 1500);
  }
}

function openRevisaoPopup(sequence, currentCount) {
  // Cria backdrop
  const backdrop = document.createElement('div');
  backdrop.className = 'popup-backdrop';
  backdrop.onclick = () => closeRevisaoPopup();
  
  // Cria popup
  const popup = document.createElement('div');
  popup.className = 'revisao-popup';
  popup.id = 'revisao-popup';
  popup.innerHTML = `
    <h4><i class="fas fa-sync-alt"></i> Quantidade de Revisões</h4>
    <input type="number" id="revisao-input" min="0" value="${currentCount}" 
           onkeypress="if(event.key==='Enter') saveRevisaoPopup('${sequence}')">
    <div class="revisao-popup-buttons">
      <button class="btn-modal-cancel" onclick="closeRevisaoPopup()">Cancelar</button>
      <button class="btn-modal-confirm" onclick="saveRevisaoPopup('${sequence}')">Salvar</button>
    </div>
  `;
  
  document.body.appendChild(backdrop);
  document.body.appendChild(popup);
  
  // Foca no input
  setTimeout(() => document.getElementById('revisao-input').select(), 100);
}

function closeRevisaoPopup() {
  const popup = document.getElementById('revisao-popup');
  const backdrop = document.querySelector('.popup-backdrop');
  if (popup) popup.remove();
  if (backdrop) backdrop.remove();
}

async function saveRevisaoPopup(sequence) {
  const input = document.getElementById('revisao-input');
  const popupConfirmButton = document.querySelector('.revisao-popup-buttons .btn-modal-confirm');
  const count = parseInt(input.value) || 0;
  
  if (!currentUserName) {
    showNotification('Usuário não autenticado.', 'error');
    closeRevisaoPopup();
    return;
  }
  
  // --- Início da Modificação ---
  // Feedback visual no botão do popup
  popupConfirmButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
  popupConfirmButton.disabled = true;

  // Encontra o contador na lista principal para aplicar o feedback lá também
  const counterElement = document.querySelector(`.topic-item[data-sequence="${sequence}"] .quick-revisao-counter`);
  if (counterElement) {
    counterElement.classList.add('loading');
  }
  // --- Fim da Modificação ---

  try {
    const url = new URL(WEB_APP_URL);
    const params = new URLSearchParams();
    params.append("action", "update");
    params.append("userEmail", currentUserName);
    params.append("sequence", sequence);
    params.append("statusRevisao", count > 0 ? 'Concluído' : 'Não Concluído');
    params.append("dataRevisao", count > 0 ? new Date().toISOString().split('T')[0] : '');
    params.append("revisaoCount", count);
    
    const response = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: params,
      redirect: 'follow'
    });
    
    const result = await response.json();
    if (result.error) throw new Error(result.error);
    
    closeRevisaoPopup();
    showNotification('Revisões atualizadas!', 'success');
    await loadAllData();
    
  } catch (error) {
    console.error("Erro:", error);
    showNotification(`Erro: ${error.message}`, 'error');
    closeRevisaoPopup();
    // --- Início da Modificação ---
    if (counterElement) {
        counterElement.classList.remove('loading');
        counterElement.classList.add('error');
        setTimeout(() => counterElement.classList.remove('error'), 1500);
    }
    // --- Fim da Modificação ---
  }
}
    // --- FUNÇÕES DA AGENDA (FASE 2 COMPLETA) ---

    // Função com loading para o botão Agenda
    async function showAgendaWithLoading() {
  // --- Início da Modificação: Pega o botão e ativa o spinner ---
  const button = document.querySelector('.top-bar button:nth-child(7)'); // Seleciona o 7º botão na barra
  const mainIcon = button.querySelector('.fa-calendar-alt');
  const spinner = button.querySelector('.button-spinner');

  button.disabled = true; // Desabilita para evitar cliques duplos
  if(mainIcon) mainIcon.style.display = 'none';
  if(spinner) spinner.style.display = 'inline-block';
  // --- Fim da Modificação ---

  try {
    await loadAgendaData();
    showAgendaModal();
  } catch (error) {
    console.error("Erro ao mostrar agenda:", error);
    showNotification('Não foi possível carregar a agenda.', 'error');
  } finally {
    // --- Início da Modificação: Restaura o botão no final ---
    button.disabled = false;
    if(mainIcon) mainIcon.style.display = 'inline-block';
    if(spinner) spinner.style.display = 'none';
    // --- Fim da Modificação ---
  }
}

   // Fechar modal da agenda
    function closeAgendaModal() {
	 if (isTimerRunning) startPauseTimer(); // Pausa o timer se estiver rodando
      // Esta função agora é mais inteligente!
      // Primeiro, ela verifica se a aba "Configurações" está ativa.
      const configTab = document.querySelector('.agenda-tab[onclick*="config"]');
      const isConfigTabActive = configTab && configTab.classList.contains('active');

      // Se a aba "Configurações" for a que está aberta...
      if (isConfigTabActive) {
        // ...ela não fecha a agenda, mas sim volta para a aba "Semanal".
        // Para isso, encontramos o botão da aba "Semanal" e clicamos nele.
        const semanalTabButton = document.querySelector('.agenda-tab[onclick*="semanal"]');
        if (semanalTabButton) {
          semanalTabButton.click();
        } else {
          // Caso algo dê errado, apenas fecha a janela como antes.
          document.getElementById('agendaModal').style.display = 'none';
        }
      } else {
        // Se qualquer outra aba (Semanal ou Mensal) estiver aberta, o botão "Fechar"
        // funciona normalmente, fechando a janela da agenda.
        document.getElementById('agendaModal').style.display = 'none';
      }
    }

    // Trocar entre abas
    function switchAgendaTab(tabName) {
      // Atualizar botões ativos
      document.querySelectorAll('.agenda-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // Carregar conteúdo da aba
      loadAgendaTab(tabName);
    }

    // Carregar dados da agenda
    async function loadAgendaData() {
      if (!currentUserName) {
        showNotification('Usuário não autenticado.', 'error');
        return;
      }
      
      try {
        const url = new URL(WEB_APP_URL);
        url.searchParams.append('action', 'readAgenda');
        url.searchParams.append('userEmail', currentUserName);
        
        const response = await fetch(url, { redirect: 'follow' });
        const result = await response.json();
        
        if (result.error) {
          throw new Error(result.error);
        }
        
        window.agendaData = result.data || [];
        return result.data;
      } catch (error) {
        console.error('Erro ao carregar agenda:', error);
        showNotification('Erro ao carregar agenda.', 'error');
        return [];
      }
    }

    // Carregar conteúdo da aba específica
    function loadAgendaTab(tabName) {
      const contentDiv = document.getElementById('agenda-content');
      
      switch(tabName) {
        case 'semanal':
  contentDiv.innerHTML = generateWeeklyView();
  initializeAgendaInteractions();
  // Garantir que a visibilidade dos períodos seja atualizada após carregar a interface
  setTimeout(updatePeriodoVisibility, 100);
  break;
        case 'mensal':
          contentDiv.innerHTML = generateMonthlyView();
          initializeMonthlyView();
          break;
        case 'config':
          contentDiv.innerHTML = generateConfigView();
          initializeConfigView();
          break;
      }
    }

    // ==================== ABA SEMANAL ====================

    function generateWeeklyView() {
      return `
        <div class="weekly-agenda">
    <div class="agenda-toolbar" style="display: flex; align-items: center; flex-wrap: wrap; gap: 25px; margin-bottom: 15px;">
    
    <!-- 1º Grupo: Botões de Ação -->
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button onclick="generateAutoAgenda()" class="btn-save">
            <i class="fas fa-robot"></i> Gerar Agenda Automática
        </button>
        <button onclick="addNewBlock()" class="btn-edit">
            <i class="fas fa-plus"></i> Novo Bloco
        </button>
        <button onclick="clearAgenda()" class="btn-reset">
            <i class="fas fa-trash"></i> Limpar
        </button>
        <button onclick="saveAgenda()" class="btn-save">
            <i class="fas fa-save"></i> Salvar Agenda
        </button>
    </div>

    <!-- 2º Grupo: Seletores de Período -->
    <div style="display: flex; align-items: center; gap: 10px;">
        <strong style="color: #F7EF8A;">Mostrar períodos:</strong>
        <label style="color: #fff; display:flex; align-items:center; gap: 4px;"><input type="checkbox" id="periodo-manha" checked> Manhã</label>
        <label style="color: #fff; display:flex; align-items:center; gap: 4px;"><input type="checkbox" id="periodo-tarde" checked> Tarde</label>
        <label style="color: #fff; display:flex; align-items:center; gap: 4px;"><input type="checkbox" id="periodo-noite" checked> Noite</label>
    </div>

    <!-- 3º Grupo: Data da Semana -->
    <div id="week-date-range" style="color: #Fff; font-weight: bold;">
        <!-- A data será inserida aqui -->
    </div>

</div>
              <!-- NOVO: Container com rolagem -->
         <div class="week-grid-container">
  ${generateWeekGrid()}
</div>
          </div>
          <!-- Modal para adicionar/editar bloco -->
          <div id="block-modal" class="modal-backdrop" style="display: none;">
            <div class="modal" style="max-width: 500px;">
              <h3 id="block-modal-title"><i class="fas fa-plus"></i> Adicionar Bloco de Estudo</h3>
			  <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <div class="form-field" style="flex: 1;">
          <label>Dia da Semana:</label>
          <select id="block-dia" style="width: 100%; padding: 8px; border-radius: 4px; background: #222; color: #fff; border: 1px solid #555;">
            <option value="Segunda">Segunda</option>
            <option value="Terça">Terça</option>
            <option value="Quarta">Quarta</option>
            <option value="Quinta">Quinta</option>
            <option value="Sexta">Sexta</option>
            <option value="Sábado">Sábado</option>
            <option value="Domingo">Domingo</option>
          </select>
        </div>
        <div class="form-field" style="flex: 1;">
          <label>Período:</label>
          <select id="block-periodo" style="width: 100%; padding: 8px; border-radius: 4px; background: #222; color: #fff; border: 1px solid #555;">
            <option value="Manhã">Manhã</option>
            <option value="Tarde">Tarde</option>
            <option value="Noite">Noite</option>
          </select>
        </div>
      </div>
              <div class="form-field" style="margin-bottom: 15px;">
                <label>Disciplina:</label>
                <select id="block-disciplina" style="width: 100%; padding: 8px; border-radius: 4px; background: #222; color: #fff; border: 1px solid #555;">
                  <option value="">Selecione uma disciplina</option>
                </select>
              </div>
              <div class="form-field" style="margin-bottom: 15px;">
                <label>Tópico:</label>
                <select id="block-topico" style="width: 100%; padding: 8px; border-radius: 4px; background: #222; color: #fff; border: 1px solid #555;">
                  <option value="">Selecione um tópico</option>
                </select>
              </div>
              <div class="form-field" style="margin-bottom: 15px;">
                <label>Horas:</label>
                <input type="number" id="block-horas" min="0.5" max="8" step="0.5" value="2" style="width: 100%; padding: 8px; border-radius: 4px; background: #222; color: #fff; border: 1px solid #555;">
              </div>
              <div class="form-field" style="margin-bottom: 15px;">
                <label>Prioridade:</label>
                <select id="block-prioridade" style="width: 100%; padding: 8px; border-radius: 4px; background: #222; color: #fff; border: 1px solid #555;">
                  <option value="Alta">Alta</option>
                  <option value="Média" selected>Média</option>
                  <option value="Baixa">Baixa</option>
                </select>
              </div>
              <div class="modal-buttons">
                <button class="btn-modal-cancel" onclick="closeBlockModal()">Cancelar</button>
                <button class="btn-modal-confirm" onclick="saveBlockModal()">Salvar Bloco</button>
              </div>
            </div>
          </div>
		 </div>
      `;
    }

    function generateWeekGrid() {
    const today = new Date();
    const weekdays = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
    const todayName = weekdays[today.getDay()];
    const days = ['Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado', 'Domingo'];
    const periods = ['Manhã', 'Tarde', 'Noite'];

    // Calcula a data de segunda-feira desta semana
    const monday = new Date(today);
    monday.setDate(today.getDate() - (today.getDay() === 0 ? 6 : today.getDay() - 1));
    
    let gridHTML = '<div class="week-grid">';
    
    // Cabeçalho dos períodos (primeira coluna, vazia para alinhar)
    gridHTML += '<div></div>'; 
    
    // Cabeçalho dos dias com a data correta
    days.forEach((day, index) => {
        const currentDate = new Date(monday);
        currentDate.setDate(monday.getDate() + index);
        const dateString = currentDate.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
        const isToday = day === todayName;

        // Adiciona a classe 'today' se for o dia atual
        gridHTML += `<div class="day-header ${isToday ? 'today' : ''}">${day}<br><span style="font-size: 0.8em; color: #ccc;">${dateString}</span></div>`;
    });
    
    // Gera as linhas para cada período (Manhã, Tarde, Noite)
    periods.forEach(period => {
        // Adiciona o cabeçalho do período (ex: "Manhã")
        gridHTML += `<div class="period-header" data-period="${period}" style="font-size: 1.2rem; text-transform: uppercase;">${period}</div>`;
        
        // Adiciona as caixas de horário para cada dia da semana
        days.forEach(day => {
            gridHTML += `
                <div class="time-slot" data-day="${day}" data-period="${period}" ondrop="dropHandler(event)" ondragover="dragOverHandler(event)" ondragleave="dragLeaveHandler(event)">
                    <div class="slot-content" id="slot-${day}-${period}"></div>
                    <button onclick="openBlockModal('${day}', '${period}')" class="add-block-btn" title="Adicionar Bloco">+</button>
                </div>
            `;
        });
    });
    
    gridHTML += '</div>';
    return gridHTML;
}

function updateWeekDateRange() {
    const dateRangeElement = document.getElementById('week-date-range');
    if (!dateRangeElement) return;

    const today = new Date();
    // Ajuste para considerar Segunda-feira (1) como início da semana. Domingo é 0.
    const dayOfWeek = today.getDay();
    const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;

    const monday = new Date(today);
    monday.setDate(today.getDate() + diffToMonday);

    const sunday = new Date(monday);
    sunday.setDate(monday.getDate() + 6);

    const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
    const startDate = monday.toLocaleDateString('pt-BR', options);
    const endDate = sunday.toLocaleDateString('pt-BR', options);

    dateRangeElement.innerHTML = `<i class="fas fa-calendar-alt"></i> Semana de ${startDate} a ${endDate}`;
}
   function initializeAgendaInteractions() {
      populateDisciplineDropdown();
      loadExistingBlocks();
      updateWeekDateRange();

      // Carregar preferências salvas do localStorage
      const config = JSON.parse(localStorage.getItem('agendaConfig') || '{}');
      const mostrarManha = config.periodos?.includes('manha') ?? true;
      const mostrarTarde = config.periodos?.includes('tarde') ?? true;
      const mostrarNoite = config.periodos?.includes('noite') ?? false;

      document.getElementById('periodo-manha').checked = mostrarManha;
      document.getElementById('periodo-tarde').checked = mostrarTarde;
      document.getElementById('periodo-noite').checked = mostrarNoite;

      // Adicionar eventos de mudança aos checkboxes da grade principal
      document.getElementById('periodo-manha').addEventListener('change', (e) => syncPeriodCheckboxes(e.target, 'config'));
      document.getElementById('periodo-tarde').addEventListener('change', (e) => syncPeriodCheckboxes(e.target, 'config'));
      document.getElementById('periodo-noite').addEventListener('change', (e) => syncPeriodCheckboxes(e.target, 'config'));

      updatePeriodoVisibility();

      // --- INÍCIO DA MODIFICAÇÃO: Centralizar dia atual ---
      setTimeout(() => {
          const todayHeader = document.querySelector('.day-header.today');
          const container = document.querySelector('.week-grid-container');
          if (todayHeader && container) {
              const scrollPos = todayHeader.offsetLeft - (container.clientWidth / 2) + (todayHeader.clientWidth / 2);
              container.scrollLeft = scrollPos;
          }
      }, 100); // Pequeno delay para garantir que a interface foi renderizada
      // --- FIM DA MODIFICAÇÃO ---
    }

    function populateDisciplineDropdown() {
      const disciplinaSelect = document.getElementById('block-disciplina');
      if (!disciplinaSelect) return;
      
      // Obter disciplinas únicas dos tópicos
      const disciplines = [...new Set(allTopics.map(topic => topic.Disciplinas).filter(d => d))];
      
      disciplinaSelect.innerHTML = '<option value="">Selecione uma disciplina</option>';
      disciplines.forEach(discipline => {
        const option = document.createElement('option');
        option.value = discipline;
        option.textContent = discipline;
        disciplinaSelect.appendChild(option);
      });
      
      // Quando disciplina mudar, carregar tópicos
      disciplinaSelect.addEventListener('change', function() {
        populateTopicDropdown(this.value);
      });
    }

    function populateTopicDropdown(disciplina) {
      const topicoSelect = document.getElementById('block-topico');
      if (!topicoSelect) return;
      
      topicoSelect.innerHTML = '<option value="">Selecione um tópico</option>';
      
      if (!disciplina) return;
      
      // Filtrar tópicos da disciplina selecionada
      const topics = allTopics.filter(topic => topic.Disciplinas === disciplina);
      topics.forEach(topic => {
        const option = document.createElement('option');
        option.value = topic.Seq;
        option.textContent = `${topic.Seq} - ${topic.Tópicos}${topic.Subtópicos && topic.Subtópicos !== '—' ? ' - ' + topic.Subtópicos : ''}`;
        option.dataset.topicName = topic.Tópicos;
        option.dataset.subtopic = topic.Subtópicos || '';
        topicoSelect.appendChild(option);
      });
    }

   function openBlockModal(day, period) {
  window.editingBlockId = null;
  
  document.getElementById('block-modal-title').innerHTML = '<i class="fas fa-plus"></i> Adicionar Bloco de Estudo';
  document.getElementById('block-modal').style.display = 'flex';
  
  // Preenche ou reseta os seletores de dia e período
  document.getElementById('block-dia').value = day || 'Segunda';
  document.getElementById('block-periodo').value = period || 'Manhã';
  
  // Resetar o resto do formulário
  document.getElementById('block-disciplina').value = '';
  document.getElementById('block-topico').innerHTML = '<option value="">Selecione um tópico</option>';
  document.getElementById('block-horas').value = '2';
  document.getElementById('block-prioridade').value = 'Média';
}
    function closeBlockModal() {
      document.getElementById('block-modal').style.display = 'none';
    }

    function saveBlockModal() {
      const disciplina = document.getElementById('block-disciplina').value;
      const topicoSelect = document.getElementById('block-topico');
      const topicoSeq = topicoSelect.value;
      const topicoText = topicoSelect.options[topicoSelect.selectedIndex]?.text || '';
      const horas = document.getElementById('block-horas').value;
      const prioridade = document.getElementById('block-prioridade').value;
      
      if (!disciplina || !topicoSeq) {
        showNotification('Selecione uma disciplina e um tópico.', 'error');
        return;
      }
      
      const blockData = {
        Data: getCorrectDateForDayOfWeek(document.getElementById('block-dia').value),
        DiaSemana: document.getElementById('block-dia').value,
        Periodo: document.getElementById('block-periodo').value,
        Disciplina: disciplina,
        TopicosSugeridos: topicoText,
        Horas: horas,
        Concluido: 'Não', // Sempre assume 'Não' ao criar/editar
        Prioridade: prioridade,
        ID_Topico: topicoSeq,
        ID_Disciplina: disciplina
      };
      
      // MODIFICADO: Agora verifica se estamos editando a partir do índice (do calendário mensal)
      if (window.editingBlockIndex !== undefined && window.editingBlockIndex !== null) {
        // Atualiza o item existente no array de dados
        window.agendaData[window.editingBlockIndex] = { ...window.agendaData[window.editingBlockIndex], ...blockData };
        generateCalendar(); // Redesenha o calendário
        saveAgenda(); // Salva
        showNotification('Bloco atualizado com sucesso!');
        window.editingBlockIndex = null; // Limpa o índice de edição

      } else if (window.editingBlockId) {
        // Lógica antiga para a visão semanal
        updateExistingBlock(window.editingBlockId, blockData);

      } else {
        // Adicionar novo bloco (visão semanal)
        addBlockToSlot(blockData);
      }
      
      closeBlockModal();
    }

    function addBlockToSlot(blockData) {
      const slot = document.getElementById(`slot-${blockData.DiaSemana}-${blockData.Periodo}`);
      if (slot) {
        const blockHTML = generateStudyBlock(blockData);
        slot.innerHTML += blockHTML;
        updateAgendaData();
        showNotification('Bloco adicionado com sucesso!');
      }
    }

function generateStudyBlock(blockData) {
    const blockId = `block-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    
    // --- INÍCIO DA SOLUÇÃO DEFINITIVA ---
    let topicId = null;

    // 1. A ESTRATÉGIA PRINCIPAL: Extrair o ID diretamente do texto 'TopicosSugeridos'.
    //    Isso funciona mesmo que a coluna ID_Topico não seja carregada pela planilha.
    if (blockData.TopicosSugeridos && blockData.TopicosSugeridos.includes(' - ')) {
        topicId = blockData.TopicosSugeridos.split(' - ')[0].trim();
    }

    // 2. Se, por algum motivo, o texto não contiver o ID, exibe um erro claro.
    if (!topicId) {
        return `<div class="study-block" style="border-left-color: red !important; background: #333; color: white; padding: 10px;">
                    <strong style="color: #ffbaba;">Erro de Dados!</strong>
                    <p style="font-size: 0.8rem; margin: 5px 0 0 0;">Não foi possível extrair o ID do Tópico do texto: "${blockData.TopicosSugeridos || 'vazio'}".</p>
                </div>`;
    }
    
    const topic = allTopics.find(t => t.Seq == topicId) || {};
    const isEstudoConcluido = topic['Status Estudo'] === 'Concluído';
    const isQuestoesConcluido = topic['Status Questões'] === 'Concluído';
    const isFlashcardsConcluido = topic['Status Flashcards'] === 'Concluído';
    const revisaoCount = topic['Revisao Count'] || 0;

    const isNewTopic = blockData.Prioridade === 'Alta';
    const visualIndicator = isNewTopic 
        ? `<span style="color: #4CAF50;"><i class="fas fa-star fa-fw"></i> NOVO</span>`
        : `<span style="color: #FFC107;"><i class="fas fa-sync-alt fa-fw"></i> REVISÃO</span>`;
    // --- FIM DA SOLUÇÃO DEFINITIVA ---

    return `
        <div class="study-block" 
            id="${blockId}"
            data-disciplina="${blockData.Disciplina}"
            data-topico="${topicId}"
            data-horas="${blockData.Horas}"
            data-prioridade="${blockData.Prioridade}"
            draggable="true"
            ondragstart="dragStartHandler(event)"
            style="background: #1a1a1a; padding: 10px; margin-bottom: 8px; border-radius: 6px; border-left: 5px solid ${getPriorityColor(blockData.Prioridade)}; cursor: move;">
            
            <div style="display: flex; justify-content: space-between; align-items: start; gap: 10px;">
                <div style="flex: 1;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <strong style="color: #F7EF8A; font-size: 0.9rem;">${blockData.Disciplina}</strong>
                        <span style="font-size: 0.75rem; font-weight: bold; margin-left: auto;">${visualIndicator}</span>
                    </div>
                    <!-- Adicionada uma classe para busca segura -->
                    <div class="agenda-block-title" style="font-size: 0.8rem; color: #fff;">${blockData.TopicosSugeridos}</div>
                </div>
                <button onclick="event.stopPropagation(); deleteBlock('${blockId}')" class="delete-block" title="Excluir Bloco">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>

            <div class="quick-controls" onclick="event.stopPropagation()" style="margin-top: 10px; padding-top: 8px; border-top: 1px solid #444; display: flex; justify-content: space-around; align-items: center;">
                <div class="quick-checkbox ${isEstudoConcluido ? 'checked-estudo' : ''}" title="Estudo" onclick="quickToggleEstudo('${topicId}', this)">${isEstudoConcluido ? '✓' : ''}</div>
                <div class="quick-revisao-counter ${revisaoCount > 0 ? 'has-revisoes' : ''}" title="Revisões" onclick="openRevisaoPopup('${topicId}', ${revisaoCount})">${revisaoCount}</div>
                <div class="quick-checkbox ${isQuestoesConcluido ? 'checked-questoes' : ''}" title="Questões" onclick="quickToggleQuestoes('${topicId}', this)">${isQuestoesConcluido ? '✓' : ''}</div>
                <div class="quick-checkbox ${isFlashcardsConcluido ? 'checked-flashcards' : ''}" title="Flashcards" onclick="quickToggleFlashcards('${topicId}', this)">${isFlashcardsConcluido ? '✓' : ''}</div>
            </div>
        </div>
    `;
}

    function getPriorityColor(prioridade) {
      switch(prioridade) {
        case 'Alta': return '#ff4444';
        case 'Média': return '#ffaa00';
        case 'Baixa': return '#44ff44';
        default: return '#D2AC47';
      }
    }
function getCorrectDateForDayOfWeek(dayName) {
      const weekdays = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
      const targetDayIndex = weekdays.indexOf(dayName);

      const today = new Date();
      const todayIndex = today.getDay(); // Domingo é 0, Segunda é 1...

      // Calcula a data da Segunda-feira desta semana
      const monday = new Date(today);
      const diffToMonday = todayIndex === 0 ? -6 : 1 - todayIndex;
      monday.setDate(today.getDate() + diffToMonday);

      // Calcula a data final somando os dias a partir de Segunda-feira
      const targetDate = new Date(monday);
      targetDate.setDate(monday.getDate() + (targetDayIndex - 1)); // -1 porque Segunda é o dia 0 no nosso cálculo

      // Formata a data como YYYY-MM-DD
      return targetDate.toISOString().split('T')[0];
    }
    // ==================== SISTEMA DRAG & DROP ====================

    function loadExistingBlocks() {
      if (window.agendaData && window.agendaData.length > 0) {
        window.agendaData.forEach(item => {
          const slot = document.getElementById(`slot-${item.DiaSemana}-${item.Periodo}`);
          if (slot) {
            const blockHTML = generateStudyBlock(item);
            slot.innerHTML += blockHTML;
          }
        });
      }
    }

    function dragStartHandler(event) {
      event.dataTransfer.setData('text/plain', event.target.id);
      event.target.style.opacity = '0.4';
    }

    function dragOverHandler(event) {
      event.preventDefault();
      event.currentTarget.classList.add('drag-over');
    }

    function dragLeaveHandler(event) {
      event.currentTarget.classList.remove('drag-over');
    }

    function dropHandler(event) {
      event.preventDefault();
      const data = event.dataTransfer.getData('text/plain');
      const draggedElement = document.getElementById(data);
      const dropZone = event.currentTarget.querySelector('.slot-content');
      
      if (draggedElement && dropZone) {
        dropZone.appendChild(draggedElement);
        draggedElement.style.opacity = '1';
        event.currentTarget.classList.remove('drag-over');
        
        updateAgendaData();
        showNotification('Bloco movido com sucesso!');
      }
    }

    // ==================== GESTÃO DE BLOCO ====================

    function editBlock(blockId) {
      const block = document.getElementById(blockId);
      const disciplina = block.dataset.disciplina;
      const topico = block.dataset.topico;
      const horas = block.dataset.horas;
      const prioridade = block.dataset.prioridade;
      
      // Encontrar dia e período atual do bloco
      const slot = block.closest('.time-slot');
      const day = slot?.dataset.day;
      const period = slot?.dataset.period;
      
      if (!day || !period) return;
      
      window.currentBlockDay = day;
      window.currentBlockPeriod = period;
      window.editingBlockId = blockId;
      
      document.getElementById('block-modal-title').innerHTML = '<i class="fas fa-edit"></i> Editar Bloco de Estudo';
      document.getElementById('block-modal').style.display = 'flex';
      
      // Preencher formulário
      document.getElementById('block-disciplina').value = disciplina;
      populateTopicDropdown(disciplina);
      
      // Aguardar carregamento dos tópicos
      setTimeout(() => {
        document.getElementById('block-topico').value = topico;
        document.getElementById('block-horas').value = horas;
        document.getElementById('block-prioridade').value = prioridade;
      }, 100);
    }

    function updateExistingBlock(blockId, newData) {
      const block = document.getElementById(blockId);
      if (block) {
        const newBlockHTML = generateStudyBlock(newData);
        block.outerHTML = newBlockHTML;
        updateAgendaData();
        showNotification('Bloco atualizado com sucesso!');
      }
    }

        function deleteBlock(blockId) {
      showConfirm('Deseja excluir este bloco de estudo?', (confirmed) => {
        if (confirmed) {
          const block = document.getElementById(blockId);
          if (block) {
            block.remove(); // Remove imediatamente da interface
            updateAgendaData(); // Atualiza os dados no window.agendaData
            showNotification('Bloco excluído com sucesso!');
          }
        }
      });
    }
function deleteAgendaItem(itemIndex) {
      // Pede confirmação ao usuário antes de deletar
      showConfirm('Deseja excluir este bloco de estudo do calendário?', (confirmed) => {
        if (confirmed) {
          // Remove o item do array de dados da agenda usando seu índice
          window.agendaData.splice(itemIndex, 1);
          
          // Redesenha o calendário mensal para refletir a remoção
          generateCalendar();
          
          // Salva a alteração na planilha
          saveAgenda(); 
          
          showNotification('Bloco excluído com sucesso do calendário!');
        }
      });
    }

    function editAgendaItem(itemIndex) {
      // Guarda o índice do item que estamos editando
      window.editingBlockIndex = itemIndex;
      const blockData = window.agendaData[itemIndex];

      if (!blockData) {
        showNotification('Erro: Bloco de estudo não encontrado.', 'error');
        return;
      }
      
      // Abre o modal de edição
      document.getElementById('block-modal-title').innerHTML = '<i class="fas fa-edit"></i> Editar Bloco de Estudo';
      document.getElementById('block-modal').style.display = 'flex';
      
      // Preenche o formulário com os dados do bloco selecionado
      document.getElementById('block-dia').value = blockData.DiaSemana;
      document.getElementById('block-periodo').value = blockData.Periodo;
      document.getElementById('block-disciplina').value = blockData.Disciplina;
      
      // Carrega os tópicos corretos para a disciplina
      populateTopicDropdown(blockData.Disciplina);
      
      setTimeout(() => {
        document.getElementById('block-topico').value = blockData.ID_Topico;
        document.getElementById('block-horas').value = blockData.Horas;
        document.getElementById('block-prioridade').value = blockData.Prioridade;
      }, 100); // Um pequeno atraso para garantir que os tópicos foram carregados
    }
    // ==================== CONCLUSÃO INTEGRADA ====================

    async function toggleConcluido(blockId) {
      const block = document.getElementById(blockId);
      const isConcluido = block.querySelector('input[type="checkbox"]').checked;
      const topicoSeq = block.dataset.topico;
      
      block.classList.toggle('concluido', isConcluido);
      
      // Integração com sistema principal
      if (isConcluido && topicoSeq) {
        await updateTopicCompletion(topicoSeq);
      }
      
      updateAgendaData();
    }

    async function updateTopicCompletion(sequence) {
      if (!currentUserName) {
        showNotification('Usuário não autenticado.', 'error');
        return;
      }
      
      try {
        const url = new URL(WEB_APP_URL);
        const params = new URLSearchParams();
        params.append("action", "update");
        params.append("userEmail", currentUserName);
        params.append("sequence", sequence);
        params.append("statusEstudo", "Concluído");
        params.append("dataEstudo", new Date().toISOString().split('T')[0]);
        
        const response = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: params,
          redirect: 'follow'
        });
        
        const result = await response.json();
        if (result.error) {
          throw new Error(result.error);
        }
        
        // Recarregar dados para atualizar estatísticas
        await loadAllData();
        showNotification('Tópico marcado como concluído no sistema!');
        
      } catch (error) {
        console.error('Erro ao atualizar tópico:', error);
        showNotification('Erro ao atualizar tópico.', 'error');
      }
    }

    // ==================== ATUALIZAÇÃO DE DADOS ====================

function updateAgendaData() {
  const agendaData = [];
  const days = ['Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado', 'Domingo'];
  const periods = ['Manhã', 'Tarde', 'Noite'];
  
  days.forEach(day => {
    periods.forEach(period => {
      const slot = document.getElementById(`slot-${day}-${period}`);
      if (slot) {
        const blocks = slot.querySelectorAll('.study-block');
        blocks.forEach(block => {
          const concluido = block.classList.contains('concluido');
          const topicoSeq = block.dataset.topico; 
          
          // Busca o elemento do título de forma segura usando uma classe
          const topicoElement = block.querySelector('.agenda-block-title');
          const topicoNome = topicoElement ? topicoElement.textContent : '';

          agendaData.push({
            Data: getCorrectDateForDayOfWeek(day),
            DiaSemana: day,
            Periodo: period,
            Disciplina: block.dataset.disciplina,
            TopicosSugeridos: topicoNome,
            Horas: block.dataset.horas,
            Concluido: concluido ? 'Sim' : 'Não',
            Prioridade: block.dataset.prioridade,
            ID_Topico: topicoSeq, 
            ID_Disciplina: block.dataset.disciplina
          });
        });
      }
    });
  });
  
  window.agendaData = agendaData;
}
async function generateAutoAgenda() {
    const button = document.querySelector('.weekly-agenda .btn-save');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando...';

    try {
        document.querySelectorAll('.slot-content').forEach(slot => slot.innerHTML = '');

        const config = JSON.parse(localStorage.getItem('agendaConfig') || '{}');
        // ... (o resto das variáveis de config continuam iguais) ...
        const diasSemanaConfig = parseInt(config.diasSemana || '5');
        const topicosDiaConfig = parseInt(config.topicosDia || '0');
        const focoPrincipalConfig = config.focoPrincipal || 'balanceado';
        const baseAgendaConfig = config.baseAgenda || 'meta-diaria-topicos';
        const distribuicaoConfig = config.distribuicao || 'igual';
        const periodosConfig = config.periodos || ['manha', 'tarde', 'noite'];
        const baseRevisaoConfig = config.baseRevisao || '1';

        // --- NOVA LÓGICA: Determinar a Data Final (Deadline) ---
        const deadlineDate = currentUserGoals['Meta Data Conclusão'] 
            ? new Date(currentUserGoals['Meta Data Conclusão']) 
            : (globalMetas['Data_Prova'] ? new Date(globalMetas['Data_Prova'].value) : null);
        if (deadlineDate) {
            deadlineDate.setHours(23, 59, 59, 999); // Garante que o dia final seja incluído
        }
        
        const today = new Date();
        const todayIndex = today.getDay() === 0 ? 6 : today.getDay() - 1;
        const todosOsDiasDaSemana = ['Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado', 'Domingo'];
        
        const diasDeEstudoConfigurados = todosOsDiasDaSemana.slice(0, diasSemanaConfig);
        const diasDeEstudoRestantes = diasDeEstudoConfigurados.filter((_, index) => index >= todayIndex);

        if (diasDeEstudoRestantes.length === 0) {
            showNotification('Não há mais dias de estudo configurados para esta semana.', 'error');
            button.innerHTML = originalText;
            return;
        }

        const availableSlots = [];
        diasDeEstudoRestantes.forEach(day => {
            if (periodosConfig.includes('manha')) availableSlots.push({ dia: day, periodo: 'Manhã' });
            if (periodosConfig.includes('tarde')) availableSlots.push({ dia: day, periodo: 'Tarde' });
            if (periodosConfig.includes('noite')) availableSlots.push({ dia: day, periodo: 'Noite' });
        });

        if (availableSlots.length === 0) {
            showNotification('Nenhum período de estudo disponível para os dias restantes da semana.', 'error');
            button.innerHTML = originalText;
            return;
        }

        let newTopicsTarget = 0;
        if (baseAgendaConfig !== 'nenhum') {
            newTopicsTarget = getDailyStudyTarget(baseAgendaConfig, topicosDiaConfig, diasSemanaConfig);
        }
        
        let revisionTarget = 0;
        // A lógica de `switch` para `baseRevisaoConfig` permanece a mesma...
        switch (baseRevisaoConfig) {
            case 'srs':
                // Agora passamos o deadline para a função do SRS
                revisionTarget = getTopicsForSrsReview(deadlineDate).length;
                break;
            case 'medias-recomendadas-revisao':
                const diasParaProvaRecomendado = globalMetas['Dias_p_Prova']?.value || 0;
                const totalRevisoes = globalMetas['Total_Temas_Revisao_Edital']?.value || totalTopics;
                if (diasParaProvaRecomendado > 0) {
                    revisionTarget = Math.ceil(totalRevisoes / diasParaProvaRecomendado);
                }
                break;
            case 'medias-personalizadas-revisao':
                const mediasPersonalizadas = calcularMediasPersonalizadas();
                revisionTarget = Math.ceil(parseFloat(mediasPersonalizadas.mediaRevisoesPersonalizada) || 0);
                break;
            default:
                revisionTarget = parseInt(baseRevisaoConfig) || 0;
                break;
        }

        if (focoPrincipalConfig === 'chico-concursos') {
            // ... (lógica do Chico Concursos permanece a mesma) ...
            const totalDailyBlocks = newTopicsTarget + revisionTarget;
            const studyPhase = calculateStudyPhase();
            let newContentProportion = 0.5;
            if (studyPhase === '0-50') newContentProportion = 0.75;
            if (studyPhase === '75-100') newContentProportion = 0.25;
            if (studyPhase === '100+') newContentProportion = 0;
            newTopicsTarget = Math.floor(totalDailyBlocks * newContentProportion);
            revisionTarget = Math.ceil(totalDailyBlocks * (1 - newContentProportion));
        }

        if (newTopicsTarget <= 0 && revisionTarget <= 0) {
            showNotification('Nenhuma meta de estudo ou revisão definida para gerar a agenda.', 'error');
            button.innerHTML = originalText;
            return;
        }

        // --- MODIFICAÇÃO: Passando o deadline para a próxima função ---
        const { newTopics, reviewTopics } = prepareTopicsForScheduling(focoPrincipalConfig, distribuicaoConfig, allTopics, globalMetas, deadlineDate);

        // ... (o resto da função para distribuir os tópicos continua igual) ...
        const totalNewTopicsToSchedule = newTopicsTarget * diasDeEstudoRestantes.length;
        const totalRevisionsToSchedule = (baseRevisaoConfig === 'srs') ? revisionTarget : (revisionTarget * diasDeEstudoRestantes.length);

        const newAgendaData = [];
        let currentSlotIndex = 0;

        for (let i = 0; i < totalNewTopicsToSchedule && i < newTopics.length; i++) {
            const topic = newTopics[i];
            const targetSlot = availableSlots[currentSlotIndex % availableSlots.length];
            newAgendaData.push({
                Data: getCorrectDateForDayOfWeek(targetSlot.dia), DiaSemana: targetSlot.dia, Periodo: targetSlot.periodo,
                Disciplina: topic.Disciplinas, TopicosSugeridos: `${topic.Seq} - ${topic.Tópicos}`,
                Horas: 1, Concluido: 'Não', Prioridade: 'Alta',
                ID_Topico: topic.Seq, ID_Disciplina: topic.Disciplinas
            });
            currentSlotIndex++;
        }

        for (let i = 0; i < totalRevisionsToSchedule && i < reviewTopics.length; i++) {
            const topic = reviewTopics[i];
            const targetSlot = availableSlots[currentSlotIndex % availableSlots.length];
            newAgendaData.push({
                Data: getCorrectDateForDayOfWeek(targetSlot.dia), DiaSemana: targetSlot.dia, Periodo: targetSlot.periodo,
                Disciplina: topic.Disciplinas, TopicosSugeridos: `${topic.Seq} - ${topic.Tópicos}`,
                Horas: 1, Concluido: 'Não', Prioridade: 'Média',
                ID_Topico: topic.Seq, ID_Disciplina: topic.Disciplinas
            });
            currentSlotIndex++;
        }

        window.agendaData = newAgendaData;
        loadExistingBlocks();
        showNotification('Agenda inteligente gerada com sucesso!', 'success');

    } catch (error) {
        console.error('Erro ao gerar agenda inteligente:', error);
        showNotification(`Ocorreu um erro: ${error.message}`, 'error');
    } finally {
        button.innerHTML = originalText;
    }
}
    // ==================== FUNÇÕES DE GESTÃO ====================


// ========================================================================
// INÍCIO DA NOVA FUNÇÃO INTELIGENTE generateAutoAgenda (VERSÃO FINAL E CORRIGIDA)
// ========================================================================
function prepareTopicsForScheduling(focoPrincipalConfig, distribuicaoConfig, allTopics, globalMetas, deadlineDate) { // <-- PARÂMETRO NOVO AQUI
    const config = JSON.parse(localStorage.getItem('agendaConfig') || '{}');
    const excludedDiscipline = config.excludeDisciplina || '';
    
    const availableTopics = excludedDiscipline 
        ? allTopics.filter(t => t.Disciplinas !== excludedDiscipline)
        : allTopics;

    let topicsToStudy = availableTopics.filter(t => t['Status Estudo'] !== 'Concluido');
    
    const baseRevisaoConfig = config.baseRevisao || '1';
    let topicsToReviewOriginal = [];
    
    if (baseRevisaoConfig === 'srs') {
        // Agora passamos o deadline para a função do SRS
        topicsToReviewOriginal = getTopicsForSrsReview(deadlineDate); 
    } else {
        topicsToReviewOriginal = availableTopics.filter(t => t['Status Estudo'] === 'Concluído' && (parseInt(t['Revisao Count']) || 0) < 4);
    }

    // ... (o resto da função, com a lógica de small/large topics e applyDisciplineDistribution, permanece exatamente igual) ...
    const SMALL_TOPIC_PAGES_THRESHOLD = 5; 
    let smallReviewTopics = topicsToReviewOriginal.filter(t => (parseInt(t['N. de Páginas']) || 0) < SMALL_TOPIC_PAGES_THRESHOLD);
    let largeReviewTopics = topicsToReviewOriginal.filter(t => (parseInt(t['N. de Páginas']) || 0) >= SMALL_TOPIC_PAGES_THRESHOLD);

    smallReviewTopics.sort((a, b) => parseInt(a.Seq) - parseInt(b.Seq));
    largeReviewTopics.sort((a, b) => parseInt(a.Seq) - parseInt(b.Seq));

    let topicsToReview = [];
    let smallIdx = 0;
    let largeIdx = 0;

    while (smallIdx < smallReviewTopics.length || largeIdx < largeReviewTopics.length) {
        for (let i = 0; i < 2 && smallIdx < smallReviewTopics.length; i++) {
            topicsToReview.push(smallReviewTopics[smallIdx++]);
        }
        if (largeIdx < largeReviewTopics.length) {
            topicsToReview.push(largeReviewTopics[largeIdx++]);
        }
    }
    while (smallIdx < smallReviewTopics.length) {
        topicsToReview.push(smallReviewTopics[smallIdx++]);
    }
    while (largeIdx < largeReviewTopics.length) {
        topicsToReview.push(largeReviewTopics[largeIdx++]);
    }
    
    function applyDisciplineDistribution(topics, distributionType) {
        const disciplines = [...new Set(topics.map(t => t.Disciplinas).filter(d => d))];
        let distributedTopics = [];

        if (distributionType === 'igual') {
            distributedTopics = [...topics].sort(() => Math.random() - 0.5);
        } else if (distributionType === 'peso') {
            const disciplineWeights = {};
            disciplines.forEach(d => {
                const cleanDiscName = d.replace(/[^a-zA-Z0-9çãáéíóúâêôõüÇÃÁÉÍÓÚÂÊÔÕÜ\s]/g, '').replace(/ /g, '_');
                disciplineWeights[d] = parseInt(globalMetas[cleanDiscName]?.value || 0);
            });
            
            disciplines.sort((a, b) => disciplineWeights[b] - disciplineWeights[a]);

            let disciplineQueues = {};
            disciplines.forEach(d => disciplineQueues[d] = topics.filter(t => t.Disciplinas === d).sort((a, b) => parseInt(a.Seq) - parseInt(b.Seq)));
            
            let allQueuesEmpty = false;
            let currentDisciplineIndex = 0;
            while (!allQueuesEmpty) {
                allQueuesEmpty = true;
                const currentDisc = disciplines[currentDisciplineIndex];
                if (disciplineQueues[currentDisc] && disciplineQueues[currentDisc].length > 0) {
                    distributedTopics.push(disciplineQueues[currentDisc].shift());
                    allQueuesEmpty = false;
                }
                currentDisciplineIndex = (currentDisciplineIndex + 1) % disciplines.length;
                
                if (allQueuesEmpty) {
                    allQueuesEmpty = Object.values(disciplineQueues).every(queue => queue.length === 0);
                }
            }
        } else { 
            distributedTopics = [...topics].sort(() => Math.random() - 0.5);
        }
        return distributedTopics;
    }

    topicsToStudy = applyDisciplineDistribution(topicsToStudy, distribuicaoConfig);
    topicsToReview = applyDisciplineDistribution(topicsToReview, distribuicaoConfig);

    let finalNewTopics = [];
    let finalReviewTopics = [];

    if (focoPrincipalConfig === 'novos') {
        finalNewTopics = topicsToStudy;
        finalReviewTopics = topicsToReview.slice(0, Math.ceil(topicsToReview.length * 0.15));
    } else if (focoPrincipalConfig === 'revisao') {
        finalReviewTopics = topicsToReview;
        finalNewTopics = topicsToStudy.slice(0, Math.ceil(topicsToStudy.length * 0.15));
    } else if (focoPrincipalConfig === 'balanceado' || focoPrincipalConfig === 'chico-concursos') {
        finalNewTopics = topicsToStudy;
        finalReviewTopics = topicsToReview;
    } else if (focoPrincipalConfig === 'questoes') {
        finalReviewTopics = topicsToReview.filter(t => t['Status Questões'] !== 'Concluído' && t['Status Estudo'] === 'Concluído');
        finalNewTopics = topicsToStudy.filter(t => t['Status Questões'] !== 'Concluido');
        finalNewTopics.sort(() => Math.random() - 0.5);
        finalReviewTopics.sort(() => Math.random() - 0.5);
    }
    
    return { newTopics: finalNewTopics || [], reviewTopics: finalReviewTopics || [] };
}

// ========================================================================
// FIM DA NOVA FUNÇÃO INTELIGENTE
// ========================================================================

    function addNewBlock() {
      openBlockModal('Segunda', 'Manhã');
    }

    function clearAgenda() {
      showConfirm('Deseja limpar toda a agenda? Esta ação não pode ser desfeita.', (confirmed) => {
        if (confirmed) {
          const slots = document.querySelectorAll('.slot-content');
          slots.forEach(slot => {
            slot.innerHTML = '';
          });
          window.agendaData = [];
          showNotification('Agenda limpa com sucesso!');
        }
      });
    }

    async function saveAgenda() {
      if (!currentUserName) {
        showNotification('Usuário não autenticado.', 'error');
        return;
      }
      
      const button = document.querySelector('.btn-save');
      const originalText = button.innerHTML;
      button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
      
      try {
        updateAgendaData();
        
        const url = new URL(WEB_APP_URL);
        const params = new URLSearchParams();
        params.append("action", "updateAgenda");
        params.append("userEmail", currentUserName);
        params.append("agendaData", JSON.stringify(window.agendaData));
        
        const response = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: params,
          redirect: 'follow'
        });
        
        const result = await response.json();
        if (result.error) {
          throw new Error(result.error);
        }
        
        showNotification('Agenda salva com sucesso!');
        
      } catch (error) {
        console.error('Erro ao salvar agenda:', error);
        showNotification('Erro ao salvar agenda.', 'error');
      } finally {
        button.innerHTML = originalText;
      }
    }

    // ==================== ABA MENSAL ====================

    function generateMonthlyView() {
      // Variáveis para controle do mês exibido
      if (window.currentMonth === undefined) window.currentMonth = new Date().getMonth(); // Use new Date() para obter o mês atual inicialmente
      if (window.currentYear === undefined) window.currentYear = new Date().getFullYear();
      const monthName = new Date(window.currentYear, window.currentMonth).toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
      return `
        <div class="monthly-agenda">
          <div class="calendar-header" style="text-align: center; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 15px;">
            <button onclick="changeMonth(-1)" style="background: #333; border: 1px solid #555; color: #F7EF8A; padding: 5px 10px; border-radius: 5px; cursor: pointer;"><</button>
            <h3 style="color: #F7EF8A; margin: 0;">${monthName.charAt(0).toUpperCase() + monthName.slice(1)}</h3>
            <button onclick="changeMonth(1)" style="background: #333; border: 1px solid #555; color: #F7EF8A; padding: 5px 10px; border-radius: 5px; cursor: pointer;">></button>
          </div>
          <div class="calendar-stats" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px;">
            <div class="stat-card" style="background: #333; padding: 15px; border-radius: 8px; text-align: center;">
              <div style="font-size: 0.9rem; color: #fff;">Horas Programadas</div>
              <div style="font-size: 1.5rem; font-weight: bold; color: #F7EF8A;" id="monthly-hours">0h</div>
            </div>
            <div class="stat-card" style="background: #333; padding: 15px; border-radius: 8px; text-align: center;">
              <div style="font-size: 0.9rem; color: #fff;">Blocos Concluídos</div>
              <div style="font-size: 1.5rem; font-weight: bold; color: #4CAF50;" id="monthly-completed">0</div>
            </div>
            <div class="stat-card" style="background: #333; padding: 15px; border-radius: 8px; text-align: center;">
              <div style="font-size: 0.9rem; color: #fff;">Disciplinas</div>
              <div style="font-size: 1.5rem; font-weight: bold; color: #2196F3;" id="monthly-disciplines">0</div>
            </div>
            <div class="stat-card" style="background: #333; padding: 15px; border-radius: 8px; text-align: center;">
              <div style="font-size: 0.9rem; color: #fff;">Dias de Estudo</div>
              <div style="font-size: 1.5rem; font-weight: bold; color: #FFC107;" id="monthly-days">0</div>
            </div>
          </div>
            <div class="calendar-grid" id="monthly-calendar" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px;">
              <!-- Calendário será gerado aqui -->
          </div>
      `;
    }

    async function initializeMonthlyView() {
  // Garante que os dados da agenda estejam carregados
  if (!window.agendaData || window.agendaData.length === 0) {
    await loadAgendaData();
  }

  // Verifica se já temos um mês/ano selecionado, se não, define o padrão
  if (window.currentMonth === undefined) {
    // Se há dados na agenda, define o mês/ano para o primeiro evento encontrado
    if (window.agendaData && window.agendaData.length > 0) {
      const dateParts = window.agendaData[0].Data.split('-'); // Separa a data em ano, mês e dia
      const firstEventDate = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]); // Cria a data ignorando o fuso horário
      window.currentMonth = firstEventDate.getMonth();
      window.currentYear = firstEventDate.getFullYear();
    } else {
      // Se não há dados, define para o mês/ano atual
      const today = new Date();
      window.currentMonth = today.getMonth();
      window.currentYear = today.getFullYear();
    }
  }
  
  // Agora, com o mês e ano corretos definidos, redesenha a view
  document.getElementById('agenda-content').innerHTML = generateMonthlyView();
  generateCalendar();
  calculateMonthlyStats();
}

    function generateCalendar() {
      const today = new Date();
      const year = window.currentYear;
      const month = window.currentMonth;
      
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      
      const calendarGrid = document.getElementById('monthly-calendar');
      if (!calendarGrid) return;
      
      let calendarHTML = '';
      
      const weekdays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
      weekdays.forEach(day => {
        calendarHTML += `<div class="weekday-header" style="text-align: center; font-weight: bold; color: #F7EF8A; padding: 10px; background: #333; border-radius: 4px;">${day}</div>`;
      });
      
      for (let i = 0; i < firstDay.getDay(); i++) {
        calendarHTML += `<div class="empty-day" style="background: #111; border-radius: 4px; min-height: 80px;"></div>`;
      }
      
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        
        // Encontra os itens e seus índices originais
        const dayAgendaWithIndices = window.agendaData.map((item, index) => ({ item, index }))
                                                      .filter(({ item }) => item.Data === dateStr);
        
        const hasStudies = dayAgendaWithIndices.length > 0;
        const isToday = day === today.getDate() && month === today.getMonth() && year === today.getFullYear();
        
        calendarHTML += `
          <div class="calendar-day ${isToday ? 'today' : ''} ${hasStudies ? 'has-studies' : ''}" 
               style="background: ${isToday ? '#333' : '#222'}; border-radius: 4px; min-height: 80px; padding: 5px; border: 1px solid #444; position: relative; display: flex; flex-direction: column; gap: 4px;">
            <div style="font-weight: bold; color: ${isToday ? '#F7EF8A' : '#fff'};">${day}</div>
            <div class="day-studies" style="font-size: 0.75rem; flex-grow: 1;">
              ${dayAgendaWithIndices.map(({ item, index }) => `
                <div style="background: #3a3a3a; color: #fff; margin-top: 2px; padding: 4px; border-radius: 3px; border-left: 3px solid ${getPriorityColor(item.Prioridade)};">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${item.TopicosSugeridos}">
                      ${item.Disciplina} (${item.Horas}h)
                    </span>
                    <div style="display: flex; gap: 3px;">
                      <button onclick="editAgendaItem(${index})" style="background:none; border:none; color:#D2AC47; cursor:pointer; font-size: 0.8rem; padding: 2px;"><i class="fas fa-pencil-alt"></i></button>
                      <button onclick="deleteAgendaItem(${index})" style="background:none; border:none; color:#ff4444; cursor:pointer; font-size: 0.8rem; padding: 2px;"><i class="fas fa-trash-alt"></i></button>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }
      
      calendarGrid.innerHTML = calendarHTML;
    }

    function calculateMonthlyStats() {
      if (!window.agendaData) return;
      
      const monthlyHours = window.agendaData.reduce((total, item) => total + parseFloat(item.Horas || 0), 0);
      const completedBlocks = window.agendaData.filter(item => item.Concluido === 'Sim').length;
      const uniqueDisciplines = [...new Set(window.agendaData.map(item => item.Disciplina))].length;
      const studyDays = [...new Set(window.agendaData.map(item => item.Data))].length;
      
      document.getElementById('monthly-hours').textContent = `${monthlyHours}h`;
      document.getElementById('monthly-completed').textContent = completedBlocks;
      document.getElementById('monthly-disciplines').textContent = uniqueDisciplines;
      document.getElementById('monthly-days').textContent = studyDays;
    }

    // ==================== ABA CONFIGURAÇÕES ====================

   
   // >>>>> INÍCIO DA NOVA FUNÇÃO <<<<<
function updateConfigUI() {
    const focoPrincipal = document.getElementById('config-foco-principal').value;
    const isChicoMethod = focoPrincipal === 'chico-concursos';

    // >>>>> LÓGICA ANTIGA DE DESABILITAR FOI REMOVIDA DAQUI <<<<<

    // Mostra ou esconde a mensagem de ajuda
    const helperText = document.getElementById('chico-helper');
    if (helperText) {
        helperText.style.display = isChicoMethod ? 'block' : 'none';
    }

    // Lógica para mostrar/esconder a barra de progresso
    const progressBarContainer = document.getElementById('chico-progress-bar-container');
    if (progressBarContainer) {
        if (isChicoMethod) {
            progressBarContainer.style.display = 'flex';
            updateChicoProgressBar();
        } else {
            progressBarContainer.style.display = 'none';
        }
    }
}
// >>>>> FIM DA NOVA FUNÇÃO <<<<<
   // >>>>> INÍCIO DA NOVA FUNÇÃO PARA A BARRA DE PROGRESSO <<<<<
function updateChicoProgressBar() {
    const container = document.getElementById('chico-progress-bar-container');
    if (!container) return; // Se o elemento não existir, para aqui.

    const totalDailyHours = parseFloat(document.getElementById('config-horas-dia').value) || 0;
    if (totalDailyHours === 0) {
        container.style.display = 'none'; // Esconde se não houver horas
        return;
    }

    const studyPhase = calculateStudyPhase();
    const { newContentHours, reviewHours } = allocateDailyStudyHours(totalDailyHours, studyPhase);

    const newContentPercent = (newContentHours / totalDailyHours) * 100;
    const reviewPercent = 100 - newContentPercent;

    const newContentSegment = document.getElementById('new-content-segment');
    const reviewSegment = document.getElementById('review-segment');

    // Atualiza a largura das barras
    newContentSegment.style.width = `${newContentPercent}%`;
    reviewSegment.style.width = `${reviewPercent}%`;

    // Atualiza o texto dentro das barras
    newContentSegment.textContent = formatarHoras(newContentHours);
    reviewSegment.textContent = formatarHoras(reviewHours);

    // Atualiza os tooltips (texto que aparece ao passar o mouse)
    newContentSegment.title = `Conteúdo Novo: ${formatarHoras(newContentHours)} (${newContentPercent.toFixed(0)}%)`;
    reviewSegment.title = `Revisão: ${formatarHoras(reviewHours)} (${reviewPercent.toFixed(0)}%)`;
}
// >>>>> FIM DA NOVA FUNÇÃO <<<<<

 function generateConfigView() {
    // --- SEU NOVO CÓDIGO COMEÇA AQUI ---
    const disciplines = [...new Set(allTopics.map(topic => topic.Disciplinas).filter(d => d))];
    let disciplineOptions = '<option value="">Nenhuma</option>';
    disciplines.forEach(d => {
        disciplineOptions += `<option value="${d}">${d}</option>`;
    });
    // --- FIM DO NOVO CÓDIGO ---
    return `
        <div class="agenda-config">
        <h4 style="color: #F7EF8A; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px;">
            <i class="fas fa-cog"></i> Configurações da Agenda
        </h4>
        
        <div style="display: flex; gap: 20px; margin-bottom: 25px;">

            <!-- Coluna da Esquerda: Preferências -->
            <div class="config-section" style="flex: 1;">
            <h5 style="color: #D2AC47; margin-bottom: 15px;">📅 Preferências de Agendamento</h5>
            
            <div class="form-field" style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #fff;">Dias de Estudo por Semana:</label>
                <input type="number" id="config-dias-semana" min="1" max="7" value="5" style="width: 100%; padding: 8px; border-radius: 4px; background: #222; color: #fff; border: 1px solid #555;">
            </div>
            
                            <div class="form-field" style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #fff;">Horas de Estudo por Dia:</label>
                <input type="number" id="config-horas-dia" min="1" max="12" value="4" oninput="updateChicoProgressBar()" style="width: 100%; padding: 8px; border-radius: 4px; background: #222; color: #fff; border: 1px solid #555;">
            </div>
                <!-- NOVO CAMPO: Tópicos Estudo por Dia -->
            <div class="form-field" style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #fff;">Tópicos Estudo por Dia:</label>
                <input type="number" id="config-topicos-dia" min="0" value="0" style="width: 100%; padding: 8px; border-radius: 4px; background: #222; color: #fff; border: 1px solid #555;">
            </div>

            <!-- FIM NOVO CAMPO -->
            <div class="form-field" style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #fff;">Períodos Preferidos:</label>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <label style="color: #fff; display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="config-periodo-manha" checked> Manhã
                </label>
                <label style="color: #fff; display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="config-periodo-tarde" checked> Tarde
                </label>
                <label style="color: #fff; display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="config-periodo-noite"> Noite
                </label>
                </div>
            </div>
            </div>
            
            <!-- Coluna da Direita: Metas -->
            <div class="config-section" style="flex: 1;">
            <h5 style="color: #D2AC47; margin-bottom: 15px;">🎯 Metas de Estudo</h5>
            
                            <div class="form-field" style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #fff;">Foco Principal:</label>
                <!-- >>>>> LINHA MODIFICADA AQUI <<<<< -->
                <!-- NOVO CÓDIGO COM A DICA -->
<select id="config-foco-principal" onchange="updateConfigUI()" style="width: 100%; padding: 8px; border-radius: 4px; background: #222; color: #fff; border: 1px solid #555;">
    <option value="novos">Novos Conteúdos</option>
    <option value="revisao">Revisão</option>
    <option value="balanceado">Balanceado</option>
    <option value="questoes">Resolução de Questões</option>
    <option value="chico-concursos" title="Método adaptativo que ajusta a proporção de conteúdo novo vs. revisão com base no seu percentual de progresso no edital.">Método Chico Concursos</option>
</select>
            </div>
            <!-- NOVO CAMPO: Base da Agenda -->
            <div class="form-field" style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #fff;">Base Conteúdo (Médias):</label>
<select id="config-base-agenda" style="width: 100%; padding: 8px; border-radius: 4px; background: #222; color: #fff; border: 1px solid #555;">
    <option value="nenhum">Nenhum Conteúdo Automático</option>
    <option value="meta-diaria-topicos">🎯 Meta Diária (Digitada)</option>
    <option value="medias-recomendadas">🧮 Médias Diárias Recomendadas (Edital)</option>
    <option value="medias-personalizadas">💪SUAS Médias Personalizadas</option>
</select>
            </div>
            <!-- FIM NOVO CAMPO -->
            
            <!-- NOVO CAMPO: Base da Revisão -->
      <div class="form-field" style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; color: #fff;">Base da Revisão Diária:</label>
        <!-- NOVO CÓDIGO COM A DICA -->
<select id="config-base-revisao" style="width: 100%; padding: 8px; border-radius: 4px; background: #222; color: #fff; border: 1px solid #555;">
  <option value="0">Nenhuma Revisão Automática</option>
  <option value="1" selected>1 Revisão por Dia</option>
  <option value="2">2 Revisões por Dia</option>
  <option value="3">3 Revisões por Dia</option>
  <option value="srs" title="Agenda automaticamente os tópicos que precisam ser revisados hoje, com base na data do estudo, dificuldade e número de revisões já feitas (método Anki).">Sistema de Repetição Espaçada (Automático)</option>
  <option value="medias-recomendadas-revisao">📅 Médias Diárias Recomendadas (Raio X)</option>
  <option value="medias-personalizadas-revisao">💪 SUAS Médias Personalizadas (Raio X)</option>
</select>
        <!-- >>>>> MENSAGEM DE AJUDA ADICIONADA AQUI <<<<< -->
        <div id="chico-helper" class="chico-helper-text">
            Estes campos definem o <b>volume total</b> de blocos. O método aplicará a proporção dinâmica sobre este total.
        </div>
      </div>
        
        <!-- SEU NOVO CÓDIGO COMEÇA AQUI -->
            <div class="form-field" style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; color: #fff;">Excluir Disciplina da Geração:</label>
            <select id="config-exclude-disciplina" style="width: 100%; padding: 8px; border-radius: 4px; background: #222; color: #fff; border: 1px solid #555;">
            <!-- A MODIFICAÇÃO ESTÁ AQUI -->
            ${disciplineOptions}
                </select>
            </div>
            <!-- FIM DO NOVO CÓDIGO -->
        
            <div class="form-field" style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #fff;">Distribuição por Disciplina:</label>
                <select id="config-distribuicao" style="width: 100%; padding: 8px; border-radius: 4px; background: #222; color: #fff; border: 1px solid #555;">
                <option value="igual">Igual para Todas</option>
                <option value="peso">Por Peso no Edital</option>
                <option value="dificuldade">Por Dificuldade Pessoal</option>
                </select>
            </div>
            </div>
<!-- >>>>> INÍCIO DAS CONFIGURAÇÕES DO POMODORO <<<<< -->
    <div class="config-section" style="flex: 1;">
        <h5 style="color: #D2AC47; margin-bottom: 15px;">🍅 Configurações do Timer Pomodoro</h5>
        <div class="form-field" style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; color: #fff;">Tempo de Foco (minutos):</label>
            <input type="number" id="config-pomodoro-focus" min="5" max="60" value="25" style="width: 100%; padding: 8px; border-radius: 4px; background: #222; color: #fff; border: 1px solid #555;">
        </div>
        <div class="form-field" style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; color: #fff;">Pausa Curta (minutos):</label>
            <input type="number" id="config-pomodoro-short-break" min="1" max="20" value="5" style="width: 100%; padding: 8px; border-radius: 4px; background: #222; color: #fff; border: 1px solid #555;">
        </div>
        <div class="form-field" style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; color: #fff;">Pausa Longa (minutos):</label>
            <input type="number" id="config-pomodoro-long-break" min="10" max="45" value="15" style="width: 100%; padding: 8px; border-radius: 4px; background: #222; color: #fff; border: 1px solid #555;">
        </div>
        <div class="form-field" style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; color: #fff;">Ciclos para Pausa Longa:</label>
            <input type="number" id="config-pomodoro-cycles" min="2" max="8" value="4" style="width: 100%; padding: 8px; border-radius: 4px; background: #222; color: #fff; border: 1px solid #555;">
        </div>
    </div>
    <!-- >>>>> FIM DAS CONFIGURAÇÕES DO POMODORO <<<<< -->

  </div>
        </div>
        
        <div class="config-actions" style="display: flex; gap: 10px; justify-content: flex-end;">
            <button class="btn-modal-cancel" onclick="resetConfig()">Redefinir</button>
            <button class="btn-modal-confirm" onclick="saveConfig()">Salvar Configurações</button>
        </div>
        </div>
    `;
}

    function initializeConfigView() {
      loadConfig();
	   updateConfigUI(); // Atualiza a interface assim que abre
    }

      function loadConfig() {
    const config = JSON.parse(localStorage.getItem('agendaConfig') || '{}');
    
    // Carrega os valores salvos ou, se não existirem, busca das metas do usuário ou um padrão
    document.getElementById('config-dias-semana').value = config.diasSemana ?? (currentUserGoals['Meta Dias Estudo'] || '5');
    document.getElementById('config-horas-dia').value = config.horasDia ?? (currentUserGoals['Meta Horas Estudo'] || '4');
    document.getElementById('config-topicos-dia').value = config.topicosDia ?? (currentUserGoals['Meta Diária Tópicos'] || '0');
    
    document.getElementById('config-periodo-manha').checked = config.periodos?.includes('manha') ?? true;
    document.getElementById('config-periodo-tarde').checked = config.periodos?.includes('tarde') ?? true;
    document.getElementById('config-periodo-noite').checked = config.periodos?.includes('noite') ?? false;

    document.getElementById('config-foco-principal').value = config.focoPrincipal || 'balanceado';
    document.getElementById('config-base-agenda').value = config.baseAgenda || 'meta-diaria-topicos';
    
    // Carrega a nova configuração de revisão
    document.getElementById('config-base-revisao').value = config.baseRevisao || '1';
    
    // >>>>> LINHA CORRIGIDA/ADICIONADA AQUI <<<<<
    document.getElementById('config-exclude-disciplina').value = config.excludeDisciplina || '';
    // >>>>> FIM DA LINHA CORRIGIDA <<<<<

    document.getElementById('config-distribuicao').value = config.distribuicao || 'igual';
	// >>>>> CARREGAR E APLICAR CONFIGURAÇÕES DO POMODORO <<<<<
    document.getElementById('config-pomodoro-focus').value = config.pomodoroFocus || '25';
    document.getElementById('config-pomodoro-short-break').value = config.pomodoroShortBreak || '5';
    document.getElementById('config-pomodoro-long-break').value = config.pomodoroLongBreak || '15';
    document.getElementById('config-pomodoro-cycles').value = config.pomodoroCycles || '4';

    // Atualiza as variáveis globais do timer
    pomodoroSettings.focus = parseInt(config.pomodoroFocus || '25');
    pomodoroSettings.short_break = parseInt(config.pomodoroShortBreak || '5');
    pomodoroSettings.long_break = parseInt(config.pomodoroLongBreak || '15');
    pomodoroSettings.cycles_to_long_break = parseInt(config.pomodoroCycles || '4');
    
    resetTimer(); // Reinicia o timer com as novas configurações carregadas
}
	
    function changeMonth(direction) {
      window.currentMonth += direction;
      if (window.currentMonth < 0) {
        window.currentMonth = 11;
        window.currentYear--;
      } else if (window.currentMonth > 11) {
        window.currentMonth = 0;
        window.currentYear++;
      }
      // Recarregar a visualização mensal
      loadAgendaTab('mensal');
    }
    
	function saveConfig() {
    const config = {
        diasSemana: document.getElementById('config-dias-semana').value,
        horasDia: document.getElementById('config-horas-dia').value,
        topicosDia: document.getElementById('config-topicos-dia').value,
        periodos: [
            document.getElementById('config-periodo-manha').checked ? 'manha' : null,
            document.getElementById('config-periodo-tarde').checked ? 'tarde' : null,
            document.getElementById('config-periodo-noite').checked ? 'noite' : null
        ].filter(Boolean),
        focoPrincipal: document.getElementById('config-foco-principal').value,
        baseAgenda: document.getElementById('config-base-agenda').value,
        baseRevisao: document.getElementById('config-base-revisao').value,
        excludeDisciplina: document.getElementById('config-exclude-disciplina').value,
        distribuicao: document.getElementById('config-distribuicao').value,
        // NOVAS CONFIGURAÇÕES DO POMODORO
        pomodoroFocus: document.getElementById('config-pomodoro-focus').value,
        pomodoroShortBreak: document.getElementById('config-pomodoro-short-break').value,
        pomodoroLongBreak: document.getElementById('config-pomodoro-long-break').value,
        pomodoroCycles: document.getElementById('config-pomodoro-cycles').value
    };
  
    localStorage.setItem('agendaConfig', JSON.stringify(config));
    showNotification('Configurações salvas com sucesso!');

    // Sincronizar campos com as Metas do Usuário
    saveUserGoalSpecificField('Meta Diária Tópicos', config.topicosDia);
    saveUserGoalSpecificField('Meta Horas Estudo', config.horasDia);
    saveUserGoalSpecificField('Meta Dias Estudo', config.diasSemana);

    // >>>>> LÓGICA NOVA PARA ATUALIZAR O TIMER IMEDIATAMENTE <<<<<
    // Atualiza as variáveis globais do timer com os novos valores salvos
    pomodoroSettings.focus = parseInt(config.pomodoroFocus || '25');
    pomodoroSettings.short_break = parseInt(config.pomodoroShortBreak || '5');
    pomodoroSettings.long_break = parseInt(config.pomodoroLongBreak || '15');
    pomodoroSettings.cycles_to_long_break = parseInt(config.pomodoroCycles || '4');
    
    resetTimer(); // Reinicia o timer com as novas configurações para atualizar a tela
    // >>>>> FIM DA NOVA LÓGICA <<<<<
}

    // ========================================================
// >>>>> INÍCIO DAS NOVAS FUNÇÕES DO TIMER DE FOCO <<<<<
// ========================================================

function startPauseTimer() {
    const startPauseIcon = document.querySelector('#timer-start-pause i');
    if (isTimerRunning) {
        // Pausar
        clearInterval(timerInterval);
        isTimerRunning = false;
        startPauseIcon.className = 'fas fa-play';
    } else {
        // Iniciar
        isTimerRunning = true;
        startPauseIcon.className = 'fas fa-pause';
        timerInterval = setInterval(tick, 1000);
    }
}

function resetTimer() {
    clearInterval(timerInterval);
    isTimerRunning = false;
    document.querySelector('#timer-start-pause i').className = 'fas fa-play';
    
    if (timerMode === 'pomodoro') {
        pomodoroState = 'focus';
        pomodoroCycles = 0;
        timerSeconds = pomodoroSettings.focus * 60;
        updatePomodoroUI();
    } else {
        timerSeconds = 0;
    }
    updateTimerDisplay();
}

function tick() {
    if (timerMode === 'pomodoro') {
        timerSeconds--;
    } else {
        timerSeconds++;
    }
    updateTimerDisplay();

    if (timerMode === 'pomodoro' && timerSeconds <= 0) {
        handlePomodoroEnd();
    }
}

function updateTimerDisplay() {
    const minutes = Math.floor(Math.abs(timerSeconds) / 60);
    const seconds = Math.abs(timerSeconds) % 60;
    const display = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    document.getElementById('timer-display').textContent = display;
    document.title = `${display} - Controle de Progresso`;
}

function handlePomodoroEnd() {
    document.getElementById('timer-alert-sound').play();
    clearInterval(timerInterval);
    isTimerRunning = false;
    document.querySelector('#timer-start-pause i').className = 'fas fa-play';

    if (pomodoroState === 'focus') {
        pomodoroCycles++;
        if (pomodoroCycles % pomodoroSettings.cycles_to_long_break === 0) {
            pomodoroState = 'long_break';
            timerSeconds = pomodoroSettings.long_break * 60;
            showNotification('Hora da pausa longa!', 'success');
        } else {
            pomodoroState = 'short_break';
            timerSeconds = pomodoroSettings.short_break * 60;
            showNotification('Ótimo trabalho! Pausa curta.', 'success');
        }
    } else { // Era uma pausa
        pomodoroState = 'focus';
        timerSeconds = pomodoroSettings.focus * 60;
        showNotification('Fim da pausa. Hora de focar!', 'success');
    }
    updatePomodoroUI();
    updateTimerDisplay();
}

function toggleTimerMode() {
    const toggleButton = document.getElementById('timer-mode-toggle');
    resetTimer(); // Reinicia o timer ao trocar de modo
    if (timerMode === 'pomodoro') {
        timerMode = 'chronometer';
        toggleButton.innerHTML = '<i class="fas fa-hourglass-half"></i>';
        toggleButton.title = "Alternar para modo Pomodoro";
        document.getElementById('pomodoro-cycles').style.display = 'none';
    } else {
        timerMode = 'pomodoro';
        toggleButton.innerHTML = '<i class="fas fa-stopwatch"></i>';
        toggleButton.title = "Alternar para modo Cronômetro";
        document.getElementById('pomodoro-cycles').style.display = 'block';
    }
    resetTimer(); // Garante que a UI seja atualizada para o novo modo
}

function updatePomodoroUI() {
    const cyclesDisplay = document.getElementById('pomodoro-cycles');
    const container = document.getElementById('focus-timer-container');
    let cycleHTML = '';
    for (let i = 0; i < pomodoroSettings.cycles_to_long_break; i++) {
        cycleHTML += i < pomodoroCycles % pomodoroSettings.cycles_to_long_break ? '🍅' : '⚪';
    }
    cyclesDisplay.innerHTML = cycleHTML;

    // Mudar a cor de fundo baseado no estado
    if (pomodoroState === 'focus') {
        container.style.borderColor = '#444';
    } else if (pomodoroState === 'short_break') {
        container.style.borderColor = '#4CAF50'; // Verde para pausa curta
    } else { // long_break
        container.style.borderColor = '#2196F3'; // Azul para pausa longa
    }
}

// ========================================================
// >>>>> FIM DAS NOVAS FUNÇÕES DO TIMER DE FOCO <<<<<
// ========================================================

    // ==================== FUNÇÕES GLOBAIS ====================

    function showAgendaModal() {
      document.getElementById('agendaModal').style.display = 'flex';
      loadAgendaTab('semanal');
    }
	// ... (fim do código existente) ...

// NOVA FUNÇÃO: Atualiza a visibilidade dos períodos com base nos checkboxes
function updatePeriodoVisibility() {
  const mostrarManha = document.getElementById('periodo-manha').checked;
  const mostrarTarde = document.getElementById('periodo-tarde').checked;
  const mostrarNoite = document.getElementById('periodo-noite').checked;

  // Esconder todos os cabeçalhos de período
  document.querySelectorAll('.period-header').forEach(header => {
    header.style.display = 'none';
  });
  // Esconder todos os slots de tempo
  document.querySelectorAll('.time-slot').forEach(slot => {
    slot.style.display = 'none';
  });

  // Mostrar apenas os períodos selecionados
  if (mostrarManha) {
    document.querySelectorAll('.period-header[data-period="Manhã"]').forEach(header => {
      header.style.display = '';
    });
    document.querySelectorAll('.time-slot[data-period="Manhã"]').forEach(slot => {
      slot.style.display = '';
    });
  }

  if (mostrarTarde) {
    document.querySelectorAll('.period-header[data-period="Tarde"]').forEach(header => {
      header.style.display = '';
    });
    document.querySelectorAll('.time-slot[data-period="Tarde"]').forEach(slot => {
      slot.style.display = '';
    });
  }

  if (mostrarNoite) {
    document.querySelectorAll('.period-header[data-period="Noite"]').forEach(header => {
      header.style.display = '';
    });
    document.querySelectorAll('.time-slot[data-period="Noite"]').forEach(slot => {
      slot.style.display = '';
    });
  }

  // Salvar preferências no localStorage
  localStorage.setItem('mostrarManha', mostrarManha);
  localStorage.setItem('mostrarTarde', mostrarTarde);
  localStorage.setItem('mostrarNoite', mostrarNoite);
}
</script>
  </script>
  <audio id="timer-alert-sound" src="https://www.soundjay.com/buttons/sounds/button-3.mp3" preload="auto"></audio>
</body>
</html>
